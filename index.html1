<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA SURVIVOR 2026 - PRO</title>
    <style>
        :root {
            --primary: #00d4ff; --red: #ff0055; --gold: #ffcc00; --green: #00ff66;
            --bg: #050805; --panel-bg: rgba(0, 20, 0, 0.95);
        }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; }
        body, html { margin: 0; padding: 0; width: 100%; height: 100%; background: var(--bg); color: #fff; font-family: 'Segoe UI', sans-serif; overflow: hidden; }
        canvas { display: block; width: 100vw; height: 100vh; position: absolute; top: 0; left: 0; }
        
        /* UI Screens */
        .ui-screen { position: absolute; top: 0; left: 0; width: 100%; height: 100%; display: flex; justify-content: center; align-items: center; z-index: 100; background: rgba(0,0,0,0.7); backdrop-filter: blur(4px); }
        .hidden { display: none !important; }
        .panel { background: var(--panel-bg); padding: 30px; border: 2px solid var(--primary); border-radius: 20px; text-align: center; width: 90%; max-width: 450px; box-shadow: 0 0 30px rgba(0, 212, 255, 0.3); }
        
        /* Level Up Upgrade Card */
        .upgrade-card { background: rgba(255,255,255,0.05); border: 1px solid var(--primary); padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; transition: 0.2s; }
        .upgrade-card:hover { background: rgba(0, 212, 255, 0.2); transform: scale(1.02); }
        .upgrade-card h3 { margin: 0; color: var(--gold); font-size: 1.1em; }
        .upgrade-card p { margin: 5px 0 0; font-size: 0.9em; opacity: 0.8; }

        .btn { display: block; width: 100%; padding: 15px; margin: 10px 0; background: var(--primary); color: #000; border: none; border-radius: 8px; font-weight: bold; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; }
        .btn-sec { background: transparent; color: var(--primary); border: 1px solid var(--primary); }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; pointer-events: none; z-index: 50; }
        .bar-container { width: 100%; height: 12px; background: rgba(255,255,255,0.1); margin-bottom: 6px; border-radius: 6px; overflow: hidden; border: 1px solid rgba(255,255,255,0.2); }
        .bar-fill { height: 100%; width: 100%; transition: width 0.3s cubic-bezier(0.17, 0.67, 0.83, 0.67); }
        .hp-bar .bar-fill { background: linear-gradient(90deg, #ff0055, #ff5588); }
        .exp-bar .bar-fill { background: linear-gradient(90deg, #00d4ff, #00ffcc); }
        .stats-top { display: flex; justify-content: space-between; font-weight: bold; margin-bottom: 8px; text-shadow: 2px 2px 4px #000; font-family: monospace; font-size: 1.2em; }
        
        #joy-base { position: absolute; bottom: 50px; left: 50px; width: 120px; height: 120px; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); z-index: 50; backdrop-filter: blur(2px); }
        #joy-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 15px var(--primary); }
        input { width: 100%; padding: 15px; background: #000; border: 1px solid var(--primary); color: #fff; text-align: center; margin-bottom: 15px; border-radius: 8px; font-size: 1.1em; }
    </style>
</head>
<body>

    <div id="hud" class="hidden">
        <div class="stats-top">
            <div id="h-lvl">LVL 1</div>
            <div id="h-time">00:00</div>
            <div id="h-gold">0</div>
        </div>
        <div class="bar-container exp-bar"><div id="exp-fill" class="bar-fill" style="width:0%"></div></div>
        <div class="bar-container hp-bar"><div id="hp-fill" class="bar-fill" style="width:100%"></div></div>
    </div>

    <div id="auth" class="ui-screen">
        <div class="panel">
            <h1 style="color:var(--primary); margin-top:0;">MEGA SURVIVOR</h1>
            <input type="text" id="auth-nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" maxlength="10">
            <button class="btn" onclick="account.login()">–í–•–û–î</button>
            <button id="btn-audio" class="btn btn-sec" onclick="audio.toggle()">SOUND: ON</button>
        </div>
    </div>

    <div id="lobby" class="ui-screen hidden">
        <div class="panel">
            <div id="user-info" style="font-size: 1.2em; margin-bottom: 5px;">–ì–ï–†–û–ô</div>
            <h2 id="user-gold" style="color:var(--gold); margin-bottom: 20px;">üí∞ 0</h2>
            <button class="btn" onclick="game.preStart()">–í –ë–û–ô</button>
            <button class="btn btn-sec" onclick="ui.showTab('rankings')">–†–ï–ô–¢–ò–ù–ì</button>
        </div>
    </div>

    <div id="level-up" class="ui-screen hidden">
        <div class="panel">
            <h2 style="color:var(--gold)">–ù–û–í–´–ô –£–†–û–í–ï–ù–¨!</h2>
            <div id="upgrade-list"></div>
        </div>
    </div>

    <div id="rankings" class="ui-screen hidden">
        <div class="panel">
            <h2>–¢–û–ü –í–´–ñ–ò–í–®–ò–•</h2>
            <div id="rank-body" style="text-align:left; margin:15px 0; max-height:250px; overflow-y:auto;"></div>
            <button class="btn btn-sec" onclick="ui.showTab('lobby')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>
    <div id="joy-base" class="hidden"><div id="joy-stick"></div></div>

<script>
// --- CONFIG & CONSTANTS ---
const UPGRADES = [
    { id: 'fire_rate', name: '–°–∫–æ—Ä–æ—Å—Ç—Ä–µ–ª—å–Ω–æ—Å—Ç—å', desc: '–°—Ç—Ä–µ–ª—å–±–∞ –Ω–∞ 15% –±—ã—Å—Ç—Ä–µ–µ', type: 'stat' },
    { id: 'speed', name: '–õ–æ–≤–∫–æ—Å—Ç—å', desc: '+10% –∫ —Å–∫–æ—Ä–æ—Å—Ç–∏ –±–µ–≥–∞', type: 'stat' },
    { id: 'shield', name: '–î—Ä–æ–Ω-—â–∏—Ç', desc: '–ó–∞—â–∏—Ç–Ω—ã–µ —Å—Ñ–µ—Ä—ã –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–∫–∞', type: 'weapon' },
    { id: 'damage', name: '–°–∏–ª–∞', desc: '+20% –∫ —É—Ä–æ–Ω—É –ø—É–ª—å', type: 'stat' },
    { id: 'magnet', name: '–ú–∞–≥–Ω–∏—Ç', desc: '–°–±–æ—Ä –æ–ø—ã—Ç–∞ —Å –±–æ–ª—å—à–µ–≥–æ —Ä–∞—Å—Å—Ç–æ—è–Ω–∏—è', type: 'stat' }
];

// --- ACCOUNT SYSTEM ---
const account = {
    current: null,
    login() {
        const nick = document.getElementById('auth-nick').value.trim() || "Rookie";
        const saved = localStorage.getItem('mega_save_' + nick);
        this.current = saved ? JSON.parse(saved) : { nick, gold: 0, lvl: 1, bestTime: 0 };
        this.save();
        ui.showTab('lobby');
        this.updateUI();
    },
    save() {
        if (!this.current) return;
        localStorage.setItem('mega_save_' + this.current.nick, JSON.stringify(this.current));
    },
    updateUI() {
        document.getElementById('user-info').innerText = `–ë–û–ï–¶: ${this.current.nick}`;
        document.getElementById('user-gold').innerText = `üí∞ ${this.current.gold}`;
    }
};

// --- AUDIO ENGINE ---
const audio = {
    ctx: null,
    enabled: localStorage.getItem('mega_audio_on') !== 'false',
    init() { if (!this.ctx) this.ctx = new (window.AudioContext || window.webkitAudioContext)(); },
    toggle() {
        this.enabled = !this.enabled;
        localStorage.setItem('mega_audio_on', this.enabled);
        this.updateBtn();
        if (this.enabled && this.ctx?.state === 'suspended') this.ctx.resume();
    },
    updateBtn() {
        const btn = document.getElementById('btn-audio');
        if (btn) btn.innerText = this.enabled ? "SOUND: ON" : "SOUND: OFF";
    },
    play(freq, type, duration, vol, slide = 10) {
        if (!this.enabled || !this.ctx) return;
        const osc = this.ctx.createOscillator();
        const g = this.ctx.createGain();
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        osc.frequency.exponentialRampToValueAtTime(slide, this.ctx.currentTime + duration);
        g.gain.setValueAtTime(vol, this.ctx.currentTime);
        g.gain.linearRampToValueAtTime(0, this.ctx.currentTime + duration);
        osc.connect(g); g.connect(this.ctx.destination);
        osc.start(); osc.stop(this.ctx.currentTime + duration);
    },
    shoot() { this.play(600, 'square', 0.1, 0.03, 100); },
    boom() { this.play(150, 'sawtooth', 0.2, 0.08, 20); },
    lvl() { this.play(523, 'sine', 0.6, 0.1, 880); }
};

// --- UI CONTROLLER ---
const ui = {
    showTab(id) {
        document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'rankings') this.renderTop();
        if (id === 'hud') document.getElementById('hud').classList.remove('hidden');
        else if (id !== 'level-up') document.getElementById('hud').classList.add('hidden');
    },
    renderTop() {
        const container = document.getElementById('rank-body');
        const players = Object.keys(localStorage)
            .filter(k => k.startsWith('mega_save_'))
            .map(k => JSON.parse(localStorage.getItem(k)))
            .sort((a, b) => b.gold - a.gold).slice(0, 10);
        container.innerHTML = players.map((p, i) => `
            <div style="display:flex; justify-content:space-between; border-bottom:1px solid #222; padding:8px 0;">
                <span>${i+1}. ${p.nick}</span>
                <span style="color:var(--gold)">üí∞ ${p.gold}</span>
            </div>`).join('') || "–ë–ê–ó–ê –î–ê–ù–ù–´–• –ü–£–°–¢–ê";
    }
};

// --- VIRTUAL JOYSTICK ---
const joy = {
    active: false, x: 0, y: 0,
    base: document.getElementById('joy-base'),
    stick: document.getElementById('joy-stick'),
    init() {
        const start = (e) => { if (!game.active || game.paused) return; this.active = true; this.base.classList.remove('hidden'); this.move(e); };
        const move = (e) => { if (this.active) this.move(e); };
        const end = () => { this.active = false; this.x = 0; this.y = 0; this.base.classList.add('hidden'); };
        window.addEventListener('touchstart', start); window.addEventListener('touchmove', move); window.addEventListener('touchend', end);
    },
    move(e) {
        const touch = e.touches[0];
        const bx = this.base.offsetLeft + 60, by = this.base.offsetTop + 60;
        const dx = touch.clientX - bx, dy = touch.clientY - by;
        const dist = Math.sqrt(dx*dx + dy*dy), max = 45, angle = Math.atan2(dy, dx);
        const moveX = Math.min(dist, max) * Math.cos(angle), moveY = Math.min(dist, max) * Math.sin(angle);
        this.stick.style.transform = `translate(${moveX}px, ${moveY}px)`;
        this.x = moveX / max; this.y = moveY / max;
    }
};

// --- GAME ENGINE ---
const game = {
    active: false, paused: false, time: 0,
    width: 0, height: 0,
    player: null, enemies: [], bullets: [], xp: [], particles: [],
    
    preStart() {
        audio.init();
        this.active = true;
        this.paused = false;
        this.time = 0;
        ui.showTab('hud');
        this.init();
    },

    init() {
        const cvs = document.getElementById('gameCanvas');
        this.width = cvs.width = window.innerWidth;
        this.height = cvs.height = window.innerHeight;
        this.player = {
            x: this.width/2, y: this.height/2,
            hp: 100, maxHp: 100, lvl: 1, exp: 0, nextExp: 60,
            r: 16, speed: 3.2, lastShot: 0, 
            fireRate: 35, damage: 1, magnet: 60,
            shields: 0, shieldAngle: 0
        };
        this.enemies = []; this.bullets = []; this.xp = []; this.particles = [];
        requestAnimationFrame(() => this.loop());
    },

    spawnEnemy() {
        if (this.enemies.length > 35) return;
        const side = Math.floor(Math.random() * 4);
        let x, y;
        if (side === 0) { x = Math.random()*this.width; y = -40; }
        else if (side === 1) { x = this.width+40; y = Math.random()*this.height; }
        else if (side === 2) { x = Math.random()*this.width; y = this.height+40; }
        else { x = -40; y = Math.random()*this.height; }
        
        const isBoss = this.time > 0 && this.time % 3600 === 0; // –ë–æ—Å—Å –∫–∞–∂–¥—É—é –º–∏–Ω—É—Ç—É
        this.enemies.push({
            x, y, 
            hp: isBoss ? 50 : 2 + Math.floor(this.time/1200), 
            maxHp: isBoss ? 50 : 2,
            r: isBoss ? 40 : 14, 
            speed: isBoss ? 0.8 : 1.2 + (this.time/5000),
            color: isBoss ? '#ffcc00' : '#ff0055',
            isBoss
        });
    },

    update() {
        if (!this.active || this.paused) return;
        this.time++;

        // Movement
        this.player.x += joy.x * this.player.speed;
        this.player.y += joy.y * this.player.speed;
        this.player.x = Math.max(this.player.r, Math.min(this.width - this.player.r, this.player.x));
        this.player.y = Math.max(this.player.r, Math.min(this.height - this.player.r, this.player.y));

        // Shields rotation
        if (this.player.shields > 0) this.player.shieldAngle += 0.05;

        // Auto-shooting
        if (this.time - this.player.lastShot > this.player.fireRate) {
            let target = null, minDist = 400;
            this.enemies.forEach(e => {
                const d = Math.hypot(e.x - this.player.x, e.y - this.player.y);
                if (d < minDist) { minDist = d; target = e; }
            });
            if (target) {
                const angle = Math.atan2(target.y - this.player.y, target.x - this.player.x);
                this.bullets.push({ x: this.player.x, y: this.player.y, angle, speed: 8, dmg: this.player.damage });
                audio.shoot();
                this.player.lastShot = this.time;
            }
        }

        // Bullets logic
        this.bullets.forEach((b, i) => {
            b.x += Math.cos(b.angle) * b.speed;
            b.y += Math.sin(b.angle) * b.speed;
            if (b.x < -10 || b.x > this.width+10 || b.y < -10 || b.y > this.height+10) this.bullets.splice(i, 1);
        });

        // Enemies logic
        if (this.time % 50 === 0) this.spawnEnemy();
        this.enemies.forEach((e, i) => {
            const angle = Math.atan2(this.player.y - e.y, this.player.x - e.x);
            e.x += Math.cos(angle) * e.speed;
            e.y += Math.sin(angle) * e.speed;

            // Collision with bullets
            this.bullets.forEach((b, bi) => {
                if (Math.hypot(e.x - b.x, e.y - b.y) < e.r + 5) {
                    e.hp -= b.dmg;
                    this.bullets.splice(bi, 1);
                    if (e.hp <= 0) this.killEnemy(i, e);
                }
            });

            // Collision with shields
            if (this.player.shields > 0) {
                for(let s=0; s < this.player.shields; s++) {
                    const sx = this.player.x + Math.cos(this.player.shieldAngle + (s * Math.PI*2/this.player.shields)) * 60;
                    const sy = this.player.y + Math.sin(this.player.shieldAngle + (s * Math.PI*2/this.player.shields)) * 60;
                    if (Math.hypot(e.x - sx, e.y - sy) < e.r + 10) {
                        e.hp -= 0.1; // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —É—Ä–æ–Ω —â–∏—Ç–æ–º
                        if (e.hp <= 0) this.killEnemy(i, e);
                    }
                }
            }

            // Player Damage
            if (Math.hypot(e.x - this.player.x, e.y - this.player.y) < e.r + this.player.r) {
                this.player.hp -= 0.4;
                if (this.player.hp <= 0) this.gameOver();
            }
        });

        // XP & Particles
        this.xp.forEach((x, xi) => {
            const dist = Math.hypot(x.x - this.player.x, x.y - this.player.y);
            if (dist < this.player.magnet) {
                x.x += (this.player.x - x.x) * 0.15;
                x.y += (this.player.y - x.y) * 0.15;
                if (dist < 15) {
                    this.player.exp += x.val;
                    this.xp.splice(xi, 1);
                    if (this.player.exp >= this.player.nextExp) this.startUpgrade();
                }
            }
        });
        
        this.particles.forEach((p, pi) => {
            p.x += p.vx; p.y += p.vy; p.life -= 0.02;
            if (p.life <= 0) this.particles.splice(pi, 1);
        });

        this.updateHUD();
    },

    killEnemy(idx, e) {
        for(let i=0; i<5; i++) this.particles.push({ x: e.x, y: e.y, vx: (Math.random()-0.5)*4, vy: (Math.random()-0.5)*4, life: 1, color: e.color });
        this.xp.push({ x: e.x, y: e.y, val: e.isBoss ? 100 : 15 });
        this.enemies.splice(idx, 1);
        audio.boom();
    },

    startUpgrade() {
        this.paused = true;
        this.player.exp = 0;
        this.player.nextExp *= 1.4;
        audio.lvl();
        
        const list = document.getElementById('upgrade-list');
        list.innerHTML = '';
        const choices = [...UPGRADES].sort(() => 0.5 - Math.random()).slice(0, 3);
        
        choices.forEach(upg => {
            const card = document.createElement('div');
            card.className = 'upgrade-card';
            card.innerHTML = `<h3>${upg.name}</h3><p>${upg.desc}</p>`;
            card.onclick = () => this.applyUpgrade(upg.id);
            list.appendChild(card);
        });
        ui.showTab('level-up');
    },

    applyUpgrade(id) {
        if (id === 'fire_rate') this.player.fireRate *= 0.85;
        if (id === 'speed') this.player.speed *= 1.1;
        if (id === 'damage') this.player.damage += 0.5;
        if (id === 'magnet') this.player.magnet += 30;
        if (id === 'shield') this.player.shields++;
        
        this.player.hp = Math.min(this.player.maxHp, this.player.hp + 20);
        this.player.lvl++;
        this.paused = false;
        ui.showTab('hud');
    },

    updateHUD() {
        document.getElementById('h-lvl').innerText = `LVL ${this.player.lvl}`;
        document.getElementById('h-gold').innerText = account.current.gold;
        document.getElementById('hp-fill').style.width = (this.player.hp / this.player.maxHp * 100) + '%';
        document.getElementById('exp-fill').style.width = (this.player.exp / this.player.nextExp * 100) + '%';
        const sec = Math.floor(this.time / 60);
        document.getElementById('h-time').innerText = `${Math.floor(sec/60).toString().padStart(2,'0')}:${(sec%60).toString().padStart(2,'0')}`;
    },

    loop() {
        if (!this.active) return;
        const ctx = document.getElementById('gameCanvas').getContext('2d');
        ctx.fillStyle = '#050805';
        ctx.fillRect(0, 0, this.width, this.height);

        this.update();

        // Draw XP
        ctx.shadowBlur = 5; ctx.shadowColor = '#00d4ff';
        this.xp.forEach(x => {
            ctx.fillStyle = '#00d4ff';
            ctx.beginPath(); ctx.arc(x.x, x.y, 4, 0, Math.PI*2); ctx.fill();
        });

        // Draw Bullets
        ctx.fillStyle = '#fff'; ctx.shadowBlur = 10; ctx.shadowColor = '#fff';
        this.bullets.forEach(b => ctx.fillRect(b.x-3, b.y-3, 6, 6));

        // Draw Particles
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life; ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 3, 3);
        });
        ctx.globalAlpha = 1; ctx.shadowBlur = 0;

        // Draw Enemies
        this.enemies.forEach(e => {
            ctx.fillStyle = e.color;
            ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill();
            if (e.isBoss) {
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 2; ctx.stroke();
                ctx.fillStyle = '#333'; ctx.fillRect(e.x-20, e.y-e.r-10, 40, 5);
                ctx.fillStyle = '#ffcc00'; ctx.fillRect(e.x-20, e.y-e.r-10, (e.hp/e.maxHp)*40, 5);
            }
        });

        // Draw Player & Shields
        ctx.shadowBlur = 20; ctx.shadowColor = '#00d4ff';
        ctx.fillStyle = '#00d4ff';
        ctx.beginPath(); ctx.arc(this.player.x, this.player.y, this.player.r, 0, Math.PI*2); ctx.fill();
        
        if (this.player.shields > 0) {
            for(let s=0; s < this.player.shields; s++) {
                const sx = this.player.x + Math.cos(this.player.shieldAngle + (s * Math.PI*2/this.player.shields)) * 60;
                const sy = this.player.y + Math.sin(this.player.shieldAngle + (s * Math.PI*2/this.player.shields)) * 60;
                ctx.fillStyle = '#00ffcc'; ctx.beginPath(); ctx.arc(sx, sy, 8, 0, Math.PI*2); ctx.fill();
            }
        }
        ctx.shadowBlur = 0;

        requestAnimationFrame(() => this.loop());
    },

    gameOver() {
        this.active = false;
        const earned = Math.floor(this.time / 15);
        account.current.gold += earned;
        account.save();
        alert(`–ú–ò–°–°–ò–Ø –ü–†–û–í–ê–õ–ï–ù–ê!\n–í–†–ï–ú–Ø: ${document.getElementById('h-time').innerText}\n–ó–û–õ–û–¢–û: üí∞${earned}`);
        location.reload();
    }
};

// --- START ---
window.addEventListener('load', () => {
    joy.init();
    const lastKeys = Object.keys(localStorage).filter(k => k.startsWith('mega_save_'));
    if (lastKeys.length > 0) document.getElementById('auth-nick').value = lastKeys[0].replace('mega_save_', '');
    window.addEventListener('resize', () => {
        game.width = gameCanvas.width = window.innerWidth;
        game.height = gameCanvas.height = window.innerHeight;
    });
});
audio.updateBtn();
</script>
</body>
  </html>
