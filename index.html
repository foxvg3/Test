<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA SURVIVOR</title>
    <link rel="stylesheet" href="style.css"> </head>
<body>

    <div id="auth" class="ui-screen">
        <h1 style="color:var(--primary); font-size:48px; margin-bottom:10px;">MEGA</h1>
        <div class="panel">
            <input type="text" id="auth-nick" placeholder="NICKNAME" autocomplete="off" style="background:#111; border:1px solid #333; color:#fff; padding:12px; border-radius:10px; width:100%; margin-bottom:10px;">
            <button class="btn" onclick="account.login()" data-t="login">ВХОД / РЕГИСТРАЦИЯ</button>
            <button id="btn-lang" class="btn btn-sec" onclick="i18n.toggle()">ЯЗЫК: RU</button>
        </div>
    </div>

    <div id="lobby" class="ui-screen hidden">
        <div class="panel">
            <div style="display:flex; justify-content: space-between; align-items: center; margin-bottom: 15px;">
                <div id="lvl-trigger" onclick="ui.showDetails()" style="cursor:pointer; text-align: left;">
                    <div style="color:var(--primary); font-size: 10px;" data-t="info">ИНФО (КЛИК)</div>
                    <div style="font-size: 20px; font-weight: bold;">LVL <span id="p-lvl">1</span></div>
                </div>
                <div style="text-align: right; color: var(--gold);">
                    <div style="font-size: 10px;">GOLD</div>
                    <div style="font-size: 20px; font-weight: bold;"><span id="l-gold">0</span></div>
                </div>
            </div>
            
            <div id="char-grid"></div>
            
            <button class="btn" onclick="game.preStart()" data-t="play">ИГРАТЬ</button>
            
            <div style="display:flex; gap:5px;">
                <button class="btn btn-sec" onclick="ui.showTab('rankings')" data-t="top">ТОП-100</button>
                <button id="admin-btn" class="btn btn-sec hidden" onclick="ui.showTab('admin-panel')">ADMIN</button>
            </div>
        </div>
    </div>

    <div id="rankings" class="ui-screen hidden">
        <div class="panel">
            <h3 style="margin:0 0 10px 0;">LEADERBOARD</h3>
            <div class="rank-tabs">
                <button class="btn btn-sec" onclick="ui.renderTop('lvl')">LVL</button>
                <button class="btn btn-sec" onclick="ui.renderTop('endless')">TIME</button>
                <button class="btn btn-sec" onclick="ui.renderTop('boss')">BOSS</button>
            </div>
            <div style="max-height: 200px; overflow-y: auto; border: 1px solid #222; border-radius: 5px;">
                <table class="rank-table">
                    <thead><tr><th>#</th><th>PLAYER</th><th id="rank-col-name">LVL</th></tr></thead>
                    <tbody id="rank-body"></tbody>
                </table>
            </div>
            <button class="btn btn-sec" style="margin-top:10px;" onclick="ui.showTab('lobby')" data-t="back">НАЗАД</button>
        </div>
    </div>

    <div id="details-modal" class="ui-screen hidden" style="background: rgba(0,0,0,0.9);">
        <div class="panel">
            <h2 style="color:var(--primary)" data-t="stats">СТАТИСТИКА</h2>
            <div id="prof-data" style="text-align: left; line-height: 1.8; font-size: 14px;"></div>
            <button class="btn" style="margin-top:15px;" onclick="ui.showTab('lobby')" data-t="back">ЗАКРЫТЬ</button>
        </div>
    </div>

    <div id="admin-panel" class="ui-screen hidden">
        <div class="panel">
            <h2>ADMIN MENU</h2>
            <button class="btn" onclick="admin.addGold()">+10,000 GOLD</button>
            <button class="btn" onclick="admin.addLvl()">+1 LEVEL</button>
            <button class="btn btn-sec" onclick="ui.showTab('lobby')">BACK</button>
        </div>
    </div>

    <div id="hud" class="hidden">
        <div class="bar-wrap"><div id="hp-fill"></div></div>
        <div class="bar-wrap" style="height:6px;"><div id="exp-fill"></div></div>
        <div style="display:flex; justify-content: space-between; font-size: 12px; text-shadow: 1px 1px #000;">
            <span id="h-lvl">LVL 1</span>
            <span id="h-time">00:00</span>
            <span id="h-gold" style="color:var(--gold)">0</span>
        </div>
    </div>

    <div id="joy-base" class="hidden"><div id="joy-stick"></div></div>
    <canvas id="gameCanvas"></canvas>

</body>
</html>:root { 
    --primary: #00d4ff; 
    --bg: #050805; 
    --panel: rgba(0, 20, 20, 0.9); 
    --gold: #ffd700; 
    --red: #ff4d4d; 
}

* { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    outline: none; 
    user-select: none; 
}

body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    background: var(--bg); color: #fff; 
    font-family: 'Verdana', sans-serif; overflow: hidden; 
}

canvas { 
    display: block; width: 100%; height: 100%; 
    position: absolute; inset: 0; z-index: 1; 
}

/* Экраны интерфейса */
.ui-screen { 
    position: absolute; inset: 0; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    background: var(--bg); z-index: 10; 
}

.hidden { display: none !important; }

.panel { 
    background: var(--panel); padding: 25px; border-radius: 20px; 
    border: 2px solid var(--primary); 
    box-shadow: 0 0 20px rgba(0, 212, 255, 0.2); 
    width: 90%; max-width: 400px; text-align: center; 
}

/* Кнопки */
.btn { 
    background: var(--primary); color: #000; border: none; 
    padding: 12px; border-radius: 10px; font-weight: bold; 
    cursor: pointer; margin: 5px 0; width: 100%; transition: 0.2s; 
}

.btn:active { transform: scale(0.95); opacity: 0.8; }

.btn-sec { 
    background: transparent; border: 1px solid var(--primary); 
    color: var(--primary); 
}

/* Сетка выбора персонажей */
#char-grid { 
    display: grid; grid-template-columns: repeat(3, 1fr); 
    gap: 10px; margin: 15px 0; max-height: 200px; overflow-y: auto; 
}

.char-card { 
    background: #111; border-radius: 10px; padding: 10px; 
    border: 1px solid #333; cursor: pointer; transition: 0.3s;
}

.char-card.selected { 
    border-color: var(--primary); 
    background: rgba(0, 212, 255, 0.1); 
}

/* Таблицы ТОП-100 */
.rank-tabs { display: flex; gap: 5px; margin-bottom: 10px; }
.rank-table { width: 100%; border-collapse: collapse; font-size: 11px; }
.rank-table th { color: var(--primary); border-bottom: 1px solid #333; padding: 5px; }
.rank-table td { padding: 5px; border-bottom: 1px solid #111; }

/* HUD (Здоровье и Опыт) */
#hud { 
    position: absolute; top: 10px; left: 10px; right: 10px; 
    pointer-events: none; z-index: 5; 
}

.bar-wrap { 
    width: 100%; height: 12px; background: rgba(0,0,0,0.5); 
    border-radius: 6px; overflow: hidden; margin-bottom: 5px; 
    border: 1px solid #333; 
}

#hp-fill { height: 100%; background: linear-gradient(90deg, var(--red), #a00); width: 100%; }
#exp-fill { height: 100%; background: var(--primary); width: 0%; }

/* Джойстик */
#joy-base { 
    position: absolute; bottom: 40px; left: 40px; 
    width: 100px; height: 100px; background: rgba(255,255,255,0.05); 
    border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); z-index: 5; 
}

#joy-stick { 
    position: absolute; top: 30px; left: 30px; 
    width: 40px; height: 40px; background: var(--primary); 
    border-radius: 50%; box-shadow: 0 0 15px var(--primary); 
}const IS_ADMIN = location.search.includes('?ad123');

// --- СИСТЕМА ЛОКАЛИЗАЦИИ ---
const i18n = {
    lang: 'ru',
    data: {
        ru: { play: "ИГРАТЬ", top: "ТОП-100", info: "ИНФО (КЛИК)", lang: "ЯЗЫК: RU", back: "НАЗАД", login: "ВХОД / РЕГИСТРАЦИЯ", stats: "СТАТИСТИКА" },
        en: { play: "PLAY", top: "TOP 100", info: "INFO (CLICK)", lang: "LANG: EN", back: "BACK", login: "LOGIN / SIGNUP", stats: "STATISTICS" }
    },
    t(key) { return this.data[this.lang][key]; },
    toggle() {
        this.lang = this.lang === 'ru' ? 'en' : 'ru';
        this.updateUI();
    },
    updateUI() {
        document.querySelectorAll('[data-t]').forEach(el => {
            el.innerText = this.t(el.getAttribute('data-t'));
        });
        const btn = document.getElementById('btn-lang');
        if (btn) btn.innerText = this.t('lang');
    }
};

// --- УПРАВЛЕНИЕ АККАУНТОМ ---
const account = {
    current: { nick: 'Guest', gold: 0, lvl: 1, exp: 0, records: { endless: 0, boss: 0 } },
    
    login() {
        const input = document.getElementById('auth-nick');
        const nick = input.value.trim() || 'Guest';
        const saved = localStorage.getItem('mega_save_' + nick);
        
        if (saved) {
            this.current = JSON.parse(saved);
        } else {
            this.current = { nick, gold: 0, lvl: 1, exp: 0, records: { endless: 0, boss: 0 } };
            this.save();
        }
        
        if (IS_ADMIN) document.getElementById('admin-btn').classList.remove('hidden');
        ui.initLobby();
        ui.showTab('lobby');
        i18n.updateUI();
    },

    save() {
        localStorage.setItem('mega_save_' + this.current.nick, JSON.stringify(this.current));
        this.updateUI();
    },

    updateUI() {
        document.getElementById('p-lvl').innerText = this.current.lvl;
        document.getElementById('l-gold').innerText = Math.floor(this.current.gold);
    }
};

// --- АДМИН-ФУНКЦИИ ---
const admin = {
    addGold() {
        account.current.gold += 10000;
        account.save();
    },
    addLvl() {
        account.current.lvl += 1;
        account.save();
    }
};const ui = {
    selectedHero: 'square',

    // Переключение экранов
    showTab(id) {
        document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id).classList.remove('hidden');
        if (id === 'lobby') account.updateUI();
    },

    // Инициализация сетки персонажей
    initLobby() {
        const grid = document.getElementById('char-grid');
        grid.innerHTML = '';
        const heroes = ['square', 'circle', 'triangle', 'diamond', 'hex', 'star'];
        
        heroes.forEach(h => {
            const card = document.createElement('div');
            card.className = `char-card ${this.selectedHero === h ? 'selected' : ''}`;
            
            // Визуализация иконки (простой символ для примера)
            let icon = '■';
            if(h === 'circle') icon = '●';
            if(h === 'triangle') icon = '▲';
            if(h === 'diamond') icon = '◆';
            
            card.innerHTML = `<div style="font-size:24px; color:var(--primary)">${icon}</div>
                              <div style="font-size:10px; margin-top:5px;">${h.toUpperCase()}</div>`;
            
            card.onclick = () => {
                this.selectedHero = h;
                this.initLobby();
            };
            grid.appendChild(card);
        });
    },

    // Окно статистики игрока (клик по уровню)
    showDetails() {
        this.showTab('details-modal');
        const c = account.current;
        document.getElementById('prof-data').innerHTML = `
            <div style="border-bottom:1px solid #333; padding-bottom:5px; margin-bottom:10px;">
                <b style="color:var(--primary)">${c.nick.toUpperCase()}</b>
            </div>
            <b>LEVEL:</b> ${c.lvl}<br>
            <b>GOLD:</b> ${Math.floor(c.gold)}<br>
            <b>EXP:</b> ${c.exp}<br><br>
            <b style="color:var(--gold)">RECORDS:</b><br>
            • ENDLESS: ${c.records.endless}s<br>
            • BOSS KILLS: ${c.records.boss}
        `;
    },

    // Генерация ТОП-100
    renderTop(type) {
        const body = document.getElementById('rank-body');
        const colTitle = document.getElementById('rank-col-name');
        body.innerHTML = '';
        
        // Меняем заголовок колонки в зависимости от типа
        const titles = { lvl: 'LVL', endless: 'TIME', boss: 'KILLS' };
        colTitle.innerText = titles[type];

        // Имитация данных ТОП-100
        for (let i = 1; i <= 100; i++) {
            let val;
            if (type === 'lvl') val = 101 - i;
            else if (type === 'endless') val = (1000 - i * 7) + 's';
            else val = 50 - Math.floor(i / 2);

            const isPlayer = i === 42; // Для примера выделим игрока
            body.innerHTML += `
                <tr style="${isPlayer ? 'color:var(--primary); background:rgba(0,212,255,0.1)' : ''}">
                    <td>${i}</td>
                    <td>${isPlayer ? account.current.nick : 'Player_' + (1000 + i)}</td>
                    <td>${val}</td>
                </tr>
            `;
        }
    }
};Object.assign(game, {
    active: false, ctx: null, width: 0, height: 0,
    player: { x: 0, y: 0, hp: 100, maxHp: 100, exp: 0, next: 100, size: 20 },
    entities: { enemies: [], bullets: [], items: [] },
    input: { dx: 0, dy: 0, active: false },
    time: 0, lastTs: 0,

    preStart() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('joy-base').classList.remove('hidden');
        this.start();
    },

    start() {
        const cvs = document.getElementById('gameCanvas');
        this.ctx = cvs.getContext('2d');
        this.width = cvs.width = window.innerWidth;
        this.height = cvs.height = window.innerHeight;
        
        // Сброс состояния
        this.player.x = 0; this.player.y = 0;
        this.player.hp = 100;
        this.entities = { enemies: [], bullets: [], items: [] };
        this.time = 0;
        this.active = true;
        
        this.initJoy();
        requestAnimationFrame((t) => this.loop(t));
    },

    initJoy() {
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');
        const handle = (e) => {
            const t = e.touches ? e.touches[0] : e;
            const r = base.getBoundingClientRect();
            const cx = r.left + 50, cy = r.top + 50;
            const dist = Math.hypot(t.clientX - cx, t.clientY - cy);
            const ang = Math.atan2(t.clientY - cy, t.clientX - cx);
            const move = Math.min(dist, 40);
            
            this.input.dx = Math.cos(ang) * (move / 40);
            this.input.dy = Math.sin(ang) * (move / 40);
            this.input.active = dist > 5;
            stick.style.transform = `translate(${Math.cos(ang) * move}px, ${Math.sin(ang) * move}px)`;
        };
        base.ontouchstart = base.ontouchmove = handle;
        window.ontouchend = () => { 
            this.input.active = false; 
            stick.style.transform = 'translate(0,0)'; 
        };
    },

    update() {
        if (!this.active) return;

        // Движение игрока
        if (this.input.active) {
            this.player.x += this.input.dx * 4;
            this.player.y += this.input.dy * 4;
        }

        // Спавн врагов
        if (this.entities.enemies.length < 30 && Math.random() < 0.05) {
            const a = Math.random() * Math.PI * 2;
            this.entities.enemies.push({
                x: this.player.x + Math.cos(a) * 500,
                y: this.player.y + Math.sin(a) * 500,
                hp: 30, maxHp: 30, color: `hsl(${Math.random() * 360}, 70%, 50%)`,
                speed: 1.5 + Math.random()
            });
        }

        // Логика врагов
        this.entities.enemies.forEach((e, i) => {
            const ang = Math.atan2(this.player.y - e.y, this.player.x - e.x);
            e.x += Math.cos(ang) * e.speed;
            e.y += Math.sin(ang) * e.speed;

            // Урон игроку
            if (Math.hypot(e.x - this.player.x, e.y - this.player.y) < 25) {
                this.player.hp -= 0.2;
                if (this.player.hp <= 0) this.gameOver();
            }
        });

        this.time++;
        this.updateHUD();
    },

    render() {
        const c = this.ctx;
        c.fillStyle = '#050805'; 
        c.fillRect(0, 0, this.width, this.height);

        c.save();
        // КАМЕРА (Центрирование на игроке)
        c.translate(this.width / 2 - this.player.x, this.height / 2 - this.player.y);

        // Фоновая сетка
        c.strokeStyle = '#112211';
        c.lineWidth = 1;
        for (let x = Math.floor(this.player.x / 100) * 100 - 600; x < this.player.x + 600; x += 100) {
            c.beginPath(); c.moveTo(x, this.player.y - 600); c.lineTo(x, this.player.y + 600); c.stroke();
        }
        for (let y = Math.floor(this.player.y / 100) * 100 - 600; y < this.player.y + 600; y += 100) {
            c.beginPath(); c.moveTo(this.player.x - 600, y); c.lineTo(this.player.x + 600, y); c.stroke();
        }

        // Враги
        this.entities.enemies.forEach(e => {
            c.fillStyle = e.color;
            c.beginPath(); c.arc(e.x, e.y, 15, 0, Math.PI * 2); c.fill();
            // HP Bar врага
            c.fillStyle = '#f003'; c.fillRect(e.x - 15, e.y - 25, 30, 4);
            c.fillStyle = '#f00'; c.fillRect(e.x - 15, e.y - 25, (e.hp / e.maxHp) * 30, 4);
        });

        // Игрок
        c.fillStyle = varColor('--primary');
        c.shadowBlur = 20; c.shadowColor = varColor('--primary');
        c.fillRect(this.player.x - 15, this.player.y - 15, 30, 30);
        c.restore();
    },

    updateHUD() {
        document.getElementById('hp-fill').style.width = this.player.hp + '%';
        const sec = Math.floor(this.time / 60);
        document.getElementById('h-time').innerText = `${Math.floor(sec / 60).toString().padStart(2, '0')}:${(sec % 60).toString().padStart(2, '0')}`;
        document.getElementById('h-gold').innerText = Math.floor(account.current.gold);
    },

    loop(ts) {
        if (!this.active) return;
        this.update();
        this.render();
        requestAnimationFrame((t) => this.loop(t));
    },

    gameOver() {
        this.active = false;
        const earned = Math.floor(this.time / 60);
        account.current.gold += earned;
        account.save();
        alert(`GAME OVER! Earned: ${earned} gold`);
        location.reload();
    }
});

// Хелпер для получения CSS переменных
function varColor(name) {
    return getComputedStyle(document.documentElement).getPropertyValue(name).trim();
}

window.onload = () => {
    account.updateUI(); // Показываем нули до входа
};
