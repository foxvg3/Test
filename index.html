<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA SURVIVOR ULTIMATE</title>
    <style>
        :root { --p: #00ff88; --bg: #222; --panel: #fff; --text: #333; --gold: #ffaa00; --red: #ff4444; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; outline: none; user-select: none; font-family: 'Arial', sans-serif; }
        body { margin: 0; background: var(--bg); color: var(--text); overflow: hidden; height: 100vh; width: 100vw; }
        #game-bg { position: absolute; inset: 0; z-index: 0; background-color: #74b374; background-image: linear-gradient(rgba(0,0,0,0.05) 1px, transparent 1px), linear-gradient(90deg, rgba(0,0,0,0.05) 1px, transparent 1px); background-size: 40px 40px; }
        canvas { position: absolute; inset: 0; z-index: 1; }
        .screen { position: absolute; inset: 0; display: flex; flex-direction: column; z-index: 10; background: #f0f0f0; transition: 0.2s; }
        .hidden { display: none !important; }
        .top-bar { display: flex; justify-content: space-between; align-items: center; padding: 10px 15px; background: #fff; box-shadow: 0 2px 10px rgba(0,0,0,0.1); z-index: 20; }
        .player-lvl { display: flex; align-items: center; gap: 10px; font-weight: bold; cursor: pointer; }
        .lvl-badge { background: var(--p); color: #000; width: 35px; height: 35px; border-radius: 50%; display: flex; align-items: center; justify-content: center; border: 2px solid #333; }
        .res-box { background: #333; color: var(--gold); padding: 5px 12px; border-radius: 20px; font-size: 14px; font-weight: bold; }
        .tab-content { flex: 1; overflow-y: auto; padding: 15px; padding-bottom: 90px; }
        .nav-bar { position: absolute; bottom: 0; left: 0; right: 0; height: 75px; background: #fff; display: flex; justify-content: space-around; align-items: center; border-top: 2px solid #ddd; z-index: 30; }
        .nav-btn { flex: 1; text-align: center; font-size: 11px; color: #999; cursor: pointer; display: flex; flex-direction: column; align-items: center; }
        .nav-btn.active { color: var(--p); font-weight: bold; }
        .nav-icon { font-size: 24px; }
        .card { background: #fff; border-radius: 15px; padding: 15px; margin-bottom: 15px; box-shadow: 0 4px 6px rgba(0,0,0,0.05); }
        .btn { background: var(--p); color: #000; border: none; padding: 12px; border-radius: 10px; font-weight: 900; width: 100%; cursor: pointer; box-shadow: 0 4px 0 #00aa5e; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #00aa5e; }
        .btn-blue { background: #4488ff; box-shadow: 0 4px 0 #2266cc; color: #fff; }
        .btn-red { background: var(--red); box-shadow: 0 4px 0 #b32d2d; color: #fff; }
        .grid-3 { display: grid; grid-template-columns: repeat(3, 1fr); gap: 10px; }
        .hero-slot { background: #fff; border-radius: 12px; padding: 10px; text-align: center; border: 3px solid transparent; transition: 0.2s; }
        .hero-slot.selected { border-color: var(--p); background: #eafff5; }
        .frag-prog { font-size: 10px; background: #333; color: #fff; padding: 2px 5px; border-radius: 5px; margin-top: 5px; display: block; }
        #admin-modal { background: rgba(0,0,0,0.95); color: #fff; padding: 20px; z-index: 200; text-align: center; }
        .admin-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; }
        #hud { pointer-events: none; position: absolute; inset: 0; padding: 15px; z-index: 50; color: #fff; text-shadow: 2px 2px 0 #000; }
        .bar-wrap { width: 100%; height: 14px; background: rgba(0,0,0,0.6); border-radius: 7px; overflow: hidden; margin-bottom: 5px; border: 1px solid rgba(255,255,255,0.3); }
        #joy-zone { position: absolute; bottom: 40px; left: 50%; transform: translateX(-50%); width: 160px; height: 160px; z-index: 40; border-radius: 50%; background: rgba(255,255,255,0.1); border: 2px solid rgba(255,255,255,0.2); }
        table { width: 100%; border-collapse: collapse; }
        th { background: #eee; padding: 10px; font-size: 12px; }
        td { padding: 10px; border-bottom: 1px solid #ddd; font-size: 13px; }
    </style>
</head>
<body>
<div id="ui-layer" class="screen">
    <div class="top-bar">
        <div class="player-lvl" id="btn-profile">
            <div class="lvl-badge" id="g-lvl">1</div>
            <div style="margin-left:8px">
                <div style="font-size:10px; color:#888">LEVEL</div>
                <div style="width:70px; height:5px; background:#ddd; border-radius:3px;"><div id="g-xp-bar" style="width:0%; height:100%; background:#48f;"></div></div>
            </div>
        </div>
        <div class="res-box">üí∞ <span id="g-gold">0</span></div>
    </div>
    <div id="tab-shop" class="tab-content hidden">
        <h2 style="text-align:center">–ú–ê–ì–ê–ó–ò–ù</h2>
        <div class="card" style="text-align:center">
            <div style="font-size:50px">üì¶</div><h3>–û–ë–´–ß–ù–´–ô –Ø–©–ò–ö</h3><p>3-5 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤</p>
            <button class="btn btn-blue" onclick="shopBuy(0)">1000 üí∞</button>
        </div>
        <div class="card" style="text-align:center; border: 2px solid gold">
            <div style="font-size:50px">üíé</div><h3>–≠–ü–ò–ß–ï–°–ö–ò–ô –Ø–©–ò–ö</h3><p>15-25 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤</p>
            <button class="btn btn-blue" onclick="shopBuy(2)">5000 üí∞</button>
        </div>
    </div>
    <div id="tab-heroes" class="tab-content">
        <div class="card">
            <select id="game-mode" class="btn" style="background:#fff; color:#000; margin-bottom:10px; border:1px solid #ddd">
                <option value="normal">–û–ë–´–ß–ù–´–ô –†–ï–ñ–ò–ú</option>
                <option value="endless">–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô (LVL 3)</option>
                <option value="boss">–û–•–û–¢–ê –ù–ê –ë–û–°–°–û–í (LVL 6)</option>
            </select>
            <button class="btn" onclick="gamePreStart()">–í –ë–û–ô!</button>
        </div>
        <h3>–ì–ï–†–û–ò</h3>
        <div id="hero-grid" class="grid-3"></div>
    </div>
    <div id="tab-tree" class="tab-content hidden">
        <h3>–î–†–ï–í–û –¢–ï–•–ù–û–õ–û–ì–ò–ô</h3>
        <p>–û—á–∫–∏: <b id="tree-points">0</b></p>
        <div id="tree-list"></div>
    </div>
    <div id="tab-rank" class="tab-content hidden">
        <div style="display:flex; gap:5px; margin-bottom:15px">
            <button class="btn btn-blue" style="padding:5px" onclick="renderRank('lvl')">–¢–û–ü LVL</button>
            <button class="btn btn-blue" style="padding:5px" onclick="renderRank('endless')">–¢–û–ü –í–†–ï–ú–Ø</button>
            <button class="btn btn-blue" style="padding:5px" onclick="renderRank('boss')">–¢–û–ü –ë–û–°–°–´</button>
        </div>
        <div class="card" style="padding:0; overflow:hidden">
            <table><thead><tr><th>#</th><th>–ò–ì–†–û–ö</th><th id="rank-type-label">–ó–ù–ê–ß–ï–ù–ò–ï</th></tr></thead><tbody id="rank-body"></tbody></table>
        </div>
    </div>
    <div class="nav-bar">
        <div class="nav-btn" onclick="showTab('shop')"><span class="nav-icon">üõí</span>–ú–∞–≥–∞–∑–∏–Ω</div>
        <div class="nav-btn active" onclick="showTab('heroes')"><span class="nav-icon">üõ°Ô∏è</span>–ì–µ—Ä–æ–∏</div>
        <div class="nav-btn" onclick="showTab('tree')"><span class="nav-icon">üß¨</span>–ù–∞–≤—ã–∫–∏</div>
        <div class="nav-btn" onclick="showTab('rank')"><span class="nav-icon">üèÜ</span>–¢–æ–ø</div>
    </div>
</div>
<div id="game-layer" class="screen hidden" style="background:transparent">
    <div id="game-bg"></div><canvas id="cvs"></canvas>
    <div id="hud">
        <div class="bar-wrap"><div id="h-hp" style="width:100%; height:100%; background:var(--red)"></div></div>
        <div class="bar-wrap"><div id="h-xp" style="width:0%; height:100%; background:var(--p)"></div></div>
        <div style="display:flex; justify-content:space-between; font-weight:bold">
            <span>LVL <span id="h-lvl">1</span></span>
            <span id="h-timer">00:00</span>
            <span>üíÄ <span id="h-kills">0</span></span>
        </div>
    </div>
    <div id="joy-zone"></div>
</div>
<div id="popup-overlay" class="screen hidden" style="background:rgba(0,0,0,0.9); z-index:300; justify-content:center; align-items:center; padding:20px">
    <div id="popup-content" style="width:100%"></div>
</div>
<div id="admin-modal" class="screen hidden">
    <h2 style="color:var(--red)">ADMIN PANEL</h2>
    <div class="admin-grid">
        <button class="btn btn-blue" onclick="cheatVoid()">üåÄ –ß–ï–†–ù–ê–Ø –î–´–†–ê</button>
        <button class="btn btn-blue" onclick="cheatGod()">üòá –ë–ï–°–°–ú–ï–†–¢–ò–ï</button>
        <button class="btn" onclick="cheatKill()">‚ò†Ô∏è –£–ë–ò–¢–¨ –í–°–ï–•</button>
        <button class="btn" onclick="cheatMagnet()">üß≤ –ú–ê–ì–ù–ò–¢</button>
        <button class="btn" onclick="cheatBoss()">üëπ –ë–û–°–° +5–ú</button>
        <button class="btn" onclick="cheatLvl()">üÜô +1 LVL</button>
        <button class="btn btn-red" onclick="cheatReset()">‚ùå –°–ë–†–û–°</button>
        <button class="btn btn-blue" onclick="cheatGold()">üí∞ +10k –ó–û–õ–û–¢–ê</button>
    </div>
    <br><button class="btn" onclick="toggleAdmin(false)">–í–´–•–û–î</button>
          </div><script>
const CHARS = {
    sq: {n:'–ö–≤–∞–¥—Ä–∞—Ç', d:'–ë–∞–ª–∞–Ω—Å', s:'bolt'}, ci: {n:'–ö—Ä—É–≥', d:'–ê—É—Ä–∞ —É—Ä–æ–Ω–∞', s:'aura'}, tr: {n:'–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', d:'–†—ã–≤–æ–∫', s:'dash'},
    ro: {n:'–†–æ–º–±', d:'–ú–∏–Ω—ã', s:'mine'}, oc: {n:'–û–∫—Ç–∞–≥–æ–Ω', d:'–¢–∞–Ω–∫', s:'shield'}, st: {n:'–ó–≤–µ–∑–¥–∞', d:'–ú–∞–≥–∏—è', s:'missile'},
    he: {n:'–ì–µ–∫—Å', d:'–¢–µ—Ö–Ω–∏–∫', s:'drone'}, pe: {n:'–ü–µ–Ω—Ç–∞', d:'–ü—Ä–∏–∑—ã–≤', s:'ghost'}, cr: {n:'–ö—Ä–µ—Å—Ç', d:'–°–≤—è—Ç–æ—Å—Ç—å', s:'laser'},
    mo: {n:'–õ—É–Ω–∞', d:'–•–æ–ª–æ–¥', s:'ice'}, he2: {n:'–°–µ—Ä–¥—Ü–µ', d:'–õ–µ–∫–∞—Ä—å', s:'heal'}, sp: {n:'–ü–∏–∫–∞', d:'–ö—Ä–∏—Ç—ã', s:'crit'},
    cl: {n:'–¢—Ä–µ—Ñ', d:'–¢–æ–ª—á–æ–∫', s:'push'}, di: {n:'–ê–ª–º–∞–∑', d:'–ë–æ–≥–∞—á', s:'gold'}, clo: {n:'–û–±–ª–∞–∫–æ', d:'–ú–æ–ª–Ω–∏–∏', s:'storm'},
    bo: {n:'–ë–æ–ª—Ç', d:'–°–∫–æ—Ä–æ—Å—Ç—å', s:'haste'}, sk: {n:'–ß–µ—Ä–µ–ø', d:'–Ø–¥', s:'poison'}, gh: {n:'–ü—Ä–∏–∑—Ä–∞–∫', d:'–ù–µ–≤–∏–¥–∏–º–æ—Å—Ç—å', s:'fade'},
    rb: {n:'–†–æ–±–æ—Ç', d:'–õ–∞–∑–µ—Ä—ã', s:'beam'}, al: {n:'–ß—É–∂–æ–π', d:'–ü–ª–∞–∑–º–∞', s:'plasma'}
};
const SKILLS = [
    {id:'bolt', n:'–°—Ç—Ä–µ–ª–∞', t:'a'}, {id:'aura', n:'–ê—É—Ä–∞', t:'a'}, {id:'mine', n:'–ú–∏–Ω–∞', t:'a'}, {id:'missile', n:'–†–∞–∫–µ—Ç–∞', t:'a'},
    {id:'laser', n:'–õ—É—á–∏', t:'a'}, {id:'ice', n:'–õ–µ–¥', t:'a'}, {id:'storm', n:'–ì—Ä–æ–∑–∞', t:'a'}, {id:'beam', n:'–õ–∞–∑–µ—Ä', t:'a'},
    {id:'plasma', n:'–ü–ª–∞–∑–º–∞', t:'a'}, {id:'fire', n:'–û–≥–æ–Ω—å', t:'a'}, {id:'saw', n:'–ü–∏–ª–∞', t:'a'}, {id:'brick', n:'–ö–∏—Ä–ø–∏—á', t:'a'},
    {id:'boomerang', n:'–ë—É–º–µ—Ä–∞–Ω–≥', t:'a'}, {id:'molotov', n:'–ö–æ–∫—Ç–µ–π–ª—å', t:'a'}, {id:'drill', n:'–°–≤–µ—Ä–ª–æ', t:'a'}, {id:'soccer', n:'–ú—è—á', t:'a'},
    {id:'durian', n:'–î—É—Ä–∏–∞–Ω', t:'a'}, {id:'rpg', n:'–†–ü–ì', t:'a'}, {id:'whistle', n:'–°–≤–∏—Å—Ç–æ–∫', t:'a'}, {id:'drone_a', n:'–î—Ä–æ–Ω –ê', t:'a'},
    {id:'drone_b', n:'–î—Ä–æ–Ω –ë', t:'a'}, {id:'katana', n:'–ö–∞—Ç–∞–Ω–∞', t:'a'}, {id:'bat', n:'–ë–∏—Ç–∞', t:'a'}, {id:'revolver', n:'–†–µ–≤–æ–ª—å–≤–µ—Ä', t:'a'}, {id:'shotgun', n:'–î—Ä–æ–±–æ–≤–∏–∫', t:'a'},
    {id:'hp_up', n:'–ó–¥–æ—Ä–æ–≤—å–µ', t:'p'}, {id:'dmg_up', n:'–£—Ä–æ–Ω', t:'p'}, {id:'spd_up', n:'–°–∫–æ—Ä–æ—Å—Ç—å', t:'p'}, {id:'range_up', n:'–†–∞–¥–∏—É—Å', t:'p'},
    {id:'cd_down', n:'–ö–î', t:'p'}, {id:'xp_up', n:'–û–ø—ã—Ç', t:'p'}, {id:'gold_up', n:'–ó–æ–ª–æ—Ç–æ', t:'p'}, {id:'magnet_up', n:'–ú–∞–≥–Ω–∏—Ç', t:'p'},
    {id:'armor_up', n:'–ë—Ä–æ–Ω—è', t:'p'}, {id:'crit_up', n:'–ö—Ä–∏—Ç', t:'p'}, {id:'regen_up', n:'–†–µ–≥–µ–Ω', t:'p'}, {id:'size_up', n:'–†–∞–∑–º–µ—Ä –ø—É–ª—å', t:'p'},
    {id:'bullet_spd', n:'–°–∫–æ—Ä. –ø—É–ª—å', t:'p'}, {id:'revive', n:'–ñ–∏–∑–Ω—å+', t:'p'}, {id:'thorns', n:'–®–∏–ø—ã', t:'p'}, {id:'knockback', n:'–¢–æ–ª—á–æ–∫', t:'p'},
    {id:'luck', n:'–£–¥–∞—á–∞', t:'p'}, {id:'greed', n:'–ñ–∞–¥–Ω–æ—Å—Ç—å', t:'p'}, {id:'shield_p', n:'–©–∏—Ç', t:'p'}, {id:'vampire', n:'–í–∞–º–ø–∏—Ä', t:'p'},
    {id:'growth', n:'–†–æ—Å—Ç', t:'p'}, {id:'haste_p', n:'–°–ø–µ—à–∫–∞', t:'p'}, {id:'focus', n:'–§–æ–∫—É—Å', t:'p'}, {id:'ammo', n:'–ó–∞–ø–∞—Å', t:'p'}, {id:'energy', n:'–≠–Ω–µ—Ä–≥–∏—è', t:'p'}
];
let DB = {
    gold:0, pLvl:1, pXp:0, heroes:{sq:1}, frags:{}, tech:{hp:0,dmg:0,arm:0},
    rec:{normal:0, endless:0, boss:0}, selected:'sq'
};
function save() { localStorage.setItem('srv_data_v6', JSON.stringify(DB)); }
function load() {
    let s = localStorage.getItem('srv_data_v6');
    if(s) DB = JSON.parse(s);
    Object.keys(CHARS).forEach(k=>{ if(!DB.frags[k])DB.frags[k]=0; if(!DB.heroes[k])DB.heroes[k]=0; });
    DB.heroes.sq = Math.max(DB.heroes.sq, 1);
}
function addXP(v) {
    DB.pXp += v;
    let req = DB.pLvl * 100;
    if(DB.pXp >= req) { DB.pXp -= req; DB.pLvl++; addXP(0); }
    save(); updateUI();
}
function shopBuy(t) {
    let c = [1000, 3000, 5000][t];
    if(DB.gold < c) return alert('–ú–∞–ª–æ –∑–æ–ª–æ—Ç–∞!');
    DB.gold -= c;
    let n = [3, 10, 20][t], res = {};
    for(let i=0; i<n; i++) {
        let k = Object.keys(CHARS)[Math.floor(Math.random()*20)];
        DB.frags[k]++; res[k] = (res[k]||0)+1;
    }
    save(); updateUI(); showReward(res);
}
function upgradeHero(k) {
    let cost = (DB.heroes[k] + 1) * 10;
    if(DB.frags[k] >= cost) { DB.frags[k]-=cost; DB.heroes[k]++; save(); updateUI(); }
}const game = {
    active:false, paused:false, time:0, kills:0,
    player:null, enemies:[], bullets:[], items:[], props:[],
    joy:{active:false, x:0, y:0}, cheats:{void:false, god:false, lvl:0}
};
const cvs = document.getElementById('cvs');
const ctx = cvs.getContext('2d');
function gamePreStart() {
    let mode = document.getElementById('game-mode').value;
    if(mode==='endless' && DB.pLvl < 3) return alert('–ù—É–∂–µ–Ω 3 —É—Ä–æ–≤–µ–Ω—å!');
    if(mode==='boss' && DB.pLvl < 6) return alert('–ù—É–∂–µ–Ω 6 —É—Ä–æ–≤–µ–Ω—å!');
    document.getElementById('ui-layer').classList.add('hidden');
    document.getElementById('game-layer').classList.remove('hidden');
    startLevel(mode);
}
function startLevel(mode) {
    let h = CHARS[DB.selected], hl = DB.heroes[DB.selected];
    game.player = {
        x:0, y:0, hp:100+(hl*20)+(DB.tech.hp*10), maxHp:100+(hl*20)+(DB.tech.hp*10),
        dmg:1+(hl*0.1)+(DB.tech.dmg*0.05), arm:DB.tech.arm, spd:3,
        lvl:1, xp:0, next:20, skills:{[h.s]:1}, mode:mode
    };
    game.active = true; game.time = 0; game.kills = 0;
    game.enemies=[]; game.bullets=[]; game.items=[]; game.props=[];
    requestAnimationFrame(loop);
}
function loop() {
    if(!game.active) return;
    if(!game.paused) update();
    draw();
    requestAnimationFrame(loop);
}
function update() {
    game.time += 16;
    let p = game.player;
    if(game.joy.active) { p.x += game.joy.x*p.spd; p.y += game.joy.y*p.spd; }
    if(game.cheats.lvl > 0) { p.xp = p.next; game.cheats.lvl--; }
    if(p.xp >= p.next) { p.lvl++; p.xp=0; p.next*=1.3; game.paused=true; showSkillChoice(); }
    if(Math.random()<0.05) spawnEnemy();
    if(Math.random()<0.001) game.props.push({x:p.x+(Math.random()-0.5)*800, y:p.y+(Math.random()-0.5)*800});
    game.enemies.forEach((e,i)=>{
        if(game.cheats.void) { e.x += (p.x - 200 - e.x)*0.1; e.y += (p.y - e.y)*0.1; }
        else { let a = Math.atan2(p.y-e.y, p.x-e.x); e.x += Math.cos(a)*e.s; e.y += Math.sin(a)*e.s; }
        if(Math.hypot(p.x-e.x, p.y-e.y)<20 && !game.cheats.god) {
            p.hp -= Math.max(0, e.d - p.arm);
            if(p.hp <= 0) endGame();
        }
        game.bullets.forEach((b,bi)=>{
            if(Math.hypot(b.x-e.x, b.y-e.y)<25) { e.h -= p.dmg*b.dmg; b.life=0; }
        });
        if(e.h<=0) {
            game.items.push({x:e.x, y:e.y, v:e.boss?10:1});
            addXP(e.boss?10:1); game.kills += (e.boss?10:1);
            game.enemies.splice(i,1);
        }
    });
    game.bullets.forEach((b,i)=>{ b.x+=b.vx; b.y+=b.vy; b.life--; if(b.life<=0)game.bullets.splice(i,1); });
    game.items.forEach((it,i)=>{
        let d = Math.hypot(p.x-it.x, p.y-it.y);
        if(d<150) { it.x+=(p.x-it.x)*0.2; it.y+=(p.y-it.y)*0.2; }
        if(d<20) { p.xp += it.v; game.items.splice(i,1); }
    });
    autoFire();
}
function spawnEnemy() {
    let p = game.player, a = Math.random()*Math.PI*2;
    let isB = game.player.mode==='boss' || (game.time%300000 < 20);
    game.enemies.push({
        x:p.x+Math.cos(a)*500, y:p.y+Math.sin(a)*500,
        h:isB?500:20, d:isB?20:5, s:isB?1.5:2, boss:isB
    });
}
function autoFire() {
    if(game.time%1000 > 20) return;
    let p = game.player, e = game.enemies[0];
    if(!e) return;
    let a = Math.atan2(e.y-p.y, e.x-p.x);
    game.bullets.push({x:p.x, y:p.y, vx:Math.cos(a)*10, vy:Math.sin(a)*10, dmg:10, life:100});
}
function draw() {
    cvs.width = window.innerWidth; cvs.height = window.innerHeight;
    let ox = cvs.width/2 - game.player.x, oy = cvs.height/2 - game.player.y;
    document.getElementById('game-bg').style.backgroundPosition = `${ox}px ${oy}px`;
    ctx.save(); ctx.translate(ox, oy);
    game.items.forEach(it=>{ ctx.fillStyle=it.v>1?'#fb0':'#0f8'; ctx.beginPath(); ctx.arc(it.x, it.y, 5, 0, 7); ctx.fill(); });
    game.props.forEach(pr=>{ ctx.fillStyle='#842'; ctx.fillRect(pr.x-15, pr.y-15, 30, 30); });
    game.enemies.forEach(e=>{ ctx.fillStyle=e.boss?'#f0f':'#f44'; ctx.beginPath(); ctx.arc(e.x, e.y, e.boss?30:15, 0, 7); ctx.fill(); });
    game.bullets.forEach(b=>{ ctx.fillStyle='#ff0'; ctx.beginPath(); ctx.arc(b.x, b.y, 5, 0, 7); ctx.fill(); });
    ctx.fillStyle='#fff'; ctx.fillRect(game.player.x-12, game.player.y-12, 24, 24);
    ctx.restore();
    document.getElementById('h-hp').style.width = (game.player.hp/game.player.maxHp*100)+'%';
    document.getElementById('h-xp').style.width = (game.player.xp/game.player.next*100)+'%';
    document.getElementById('h-lvl').innerText = game.player.lvl;
    document.getElementById('h-kills').innerText = game.kills;
    let sec = Math.floor(game.time/1000);
    document.getElementById('h-timer').innerText = Math.floor(sec/60)+':'+(sec%60).toString().padStart(2,'0');
}
function endGame() { game.active=false; alert('GAME OVER'); location.reload(); }
function showSkillChoice() {
    let pool = SKILLS.sort(()=>0.5-Math.random()).slice(0,3);
    let h = '<h2>–í–´–ë–ï–†–ò–¢–ï –ù–ê–í–´–ö</h2>';
    pool.forEach(s=>{ h += `<div class="card" onclick="pickSkill('${s.id}')"><b>${s.n}</b><br>${s.t==='a'?'–ê–∫—Ç–∏–≤–Ω—ã–π':'–ü–∞—Å—Å–∏–≤–Ω—ã–π'}</div>`; });
    document.getElementById('popup-content').innerHTML = h;
    document.getElementById('popup-overlay').classList.remove('hidden');
}
function pickSkill(id) {
    game.player.skills[id] = (game.player.skills[id]||0)+1;
    game.paused = false; document.getElementById('popup-overlay').classList.add('hidden');
}
function showTab(id) {
    document.querySelectorAll('.tab-content').forEach(t=>t.classList.add('hidden'));
    document.querySelectorAll('.nav-btn').forEach(b=>b.classList.remove('active'));
    document.getElementById('tab-'+id).classList.remove('hidden');
    event.currentTarget.classList.add('active');
    if(id==='heroes') updateUI();
    if(id==='tree') renderTree();
    if(id==='rank') renderRank('lvl');
}
function updateUI() {
    document.getElementById('g-lvl').innerText = DB.pLvl;
    document.getElementById('g-gold').innerText = DB.gold;
    document.getElementById('g-xp-bar').style.width = (DB.pXp/(DB.pLvl*100)*100)+'%';
    let g = document.getElementById('hero-grid'); g.innerHTML = '';
    Object.keys(CHARS).forEach(k=>{
        let h = CHARS[k], lvl = DB.heroes[k], fr = DB.frags[k], req = (lvl+1)*10;
        let div = document.createElement('div'); div.className = 'hero-slot '+(DB.selected===k?'selected':'');
        div.innerHTML = `<b>${h.n}</b><br><small>Lvl ${lvl}</small><span class="frag-prog">${fr}/${req}</span>`;
        div.onclick = ()=>{ DB.selected = k; updateUI(); if(fr>=req) upgradeHero(k); };
        g.appendChild(div);
    });
}
function renderTree() {
    let used = DB.tech.hp + DB.tech.dmg + DB.tech.arm;
    let pts = (DB.pLvl - 1) - used;
    document.getElementById('tree-points').innerText = pts;
    let l = document.getElementById('tree-list'); l.innerHTML = '';
    [{n:'–ó–¥–æ—Ä–æ–≤—å–µ', k:'hp'}, {n:'–£—Ä–æ–Ω', k:'dmg'}, {n:'–ë—Ä–æ–Ω—è', k:'arm'}].forEach(t=>{
        let cost = (DB.tech[t.k]+1)*500;
        l.innerHTML += `<div class="card">${t.n}: ${DB.tech[t.k]} <button class="btn btn-blue" onclick="buyTech('${t.k}', ${cost})">–£–ª—É—á—à–∏—Ç—å (${cost}üí∞)</button></div>`;
    });
}
function buyTech(k, c) {
    let used = DB.tech.hp + DB.tech.dmg + DB.tech.arm;
    if(DB.pLvl-1 > used && DB.gold >= c) { DB.gold-=c; DB.tech[k]++; save(); renderTree(); updateUI(); }
}
function renderRank(type) {
    let b = document.getElementById('rank-body'); b.innerHTML = '';
    document.getElementById('rank-type-label').innerText = type.toUpperCase();
    for(let i=1; i<=100; i++) {
        b.innerHTML += `<tr><td>${i}</td><td>–ò–≥—Ä–æ–∫_${Math.floor(Math.random()*9999)}</td><td>${100-i}</td></tr>`;
    }
}
function showReward(res) {
    let h = '<h3>–ü–û–õ–£–ß–ï–ù–û:</h3><div class="grid-3">';
    Object.keys(res).forEach(k=>{ h += `<div class="card"><b>${CHARS[k].n}</b><br>x${res[k]}</div>`; });
    h += '</div><button class="btn" onclick="document.getElementById(\'popup-overlay\').classList.add(\'hidden\')">–û–ö</button>';
    document.getElementById('popup-content').innerHTML = h;
    document.getElementById('popup-overlay').classList.remove('hidden');
}
const jz = document.getElementById('joy-zone');
jz.addEventListener('touchstart', e=>{ game.joy.active=true; });
jz.addEventListener('touchmove', e=>{
    let t = e.touches[0], r = jz.getBoundingClientRect();
    game.joy.x = (t.clientX - (r.left+80))/80; game.joy.y = (t.clientY - (r.top+80))/80;
});
jz.addEventListener('touchend', ()=>{ game.joy.active=false; game.joy.x=0; game.joy.y=0; });
document.getElementById('btn-profile').onclick = ()=>{ 
    alert(`–ü–†–û–§–ò–õ–¨\n–£—Ä–æ–≤–µ–Ω—å: ${DB.pLvl}\n–ó–æ–ª–æ—Ç–æ: ${DB.gold}\n–†–µ–∫–æ—Ä–¥: ${DB.rec.normal}`);
};
function toggleAdmin(v) { document.getElementById('admin-modal').classList.toggle('hidden', !v); }
if(window.location.search.includes('ad123')) {
    let aBtn = document.createElement('button'); aBtn.innerText = 'ADM';
    aBtn.style = 'position:fixed; top:50px; right:10px; z-index:999; opacity:0.5';
    aBtn.onclick = ()=>toggleAdmin(true); document.body.appendChild(aBtn);
}
function cheatVoid() { game.cheats.void = !game.cheats.void; }
function cheatGod() { game.cheats.god = !game.cheats.god; }
function cheatKill() { game.enemies = []; }
function cheatMagnet() { game.items.forEach(i=>{ i.x=game.player.x; i.y=game.player.y; }); }
function cheatBoss() { game.time += 300000; spawnEnemy(); }
function cheatLvl() { game.cheats.lvl++; }
function cheatReset() { localStorage.clear(); location.reload(); }
function cheatGold() { DB.gold += 10000; save(); updateUI(); }
window.onload = ()=>{ load(); updateUI(); };
</script>
</body>
</html>
