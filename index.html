<!DOCTYPE html>
<html lang="ru" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Shape Survivor Online - V9</title>
    <style>
        :root { 
            --primary: #00d4ff; --gold: #ffd700; --bg: #050805; 
            --panel: rgba(20, 25, 20, 0.98); --red: #ff4d4d;
        }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Verdana', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; position: absolute; inset: 0; z-index: 1; }

        /* UI –≠–∫—Ä–∞–Ω—ã */
        .ui-screen { position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle at center, #1a201a 0%, #000 100%); overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* –®–∞–ø–∫–∞ –ø—Ä–æ—Ñ–∏–ª—è (Level & XP) */
        .profile-header { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.7); padding: 12px; border-radius: 10px; border-left: 4px solid var(--primary); font-size: 13px; box-shadow: 0 4px 15px rgba(0,0,0,0.5); }
        .profile-header b { color: var(--primary); display: block; margin-bottom: 3px; font-size: 15px; }
        .xp-mini-bar { width: 100px; height: 4px; background: #222; margin-top: 5px; border-radius: 2px; }
        #xp-mini-fill { height: 100%; background: var(--primary); width: 0%; transition: 0.3s; }
        
        /* –¢–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤ */
        .leaderboard-table { width: 100%; max-width: 500px; border-collapse: collapse; margin-top: 15px; background: rgba(255,255,255,0.02); border-radius: 10px; overflow: hidden; }
        .leaderboard-table th { background: #111; color: var(--gold); padding: 12px; text-align: left; font-size: 14px; }
        .leaderboard-table td { padding: 10px; border-bottom: 1px solid #222; font-size: 13px; }
        .leaderboard-table tr:nth-child(even) { background: rgba(255,255,255,0.01); }

        /* –î–µ—Ä–µ–≤–æ –Ω–∞–≤—ã–∫–æ–≤ */
        .skill-tree { display: grid; grid-template-columns: 1fr; gap: 12px; width: 100%; max-width: 450px; margin-top: 20px; }
        .tree-node { background: #151815; border: 1px solid #333; padding: 15px; border-radius: 12px; display: flex; justify-content: space-between; align-items: center; transition: 0.2s; }
        .tree-node.available { border-color: var(--primary); box-shadow: 0 0 10px rgba(0,212,255,0.1); }
        .tree-node.maxed { border-color: var(--gold); background: rgba(255,215,0,0.05); }
        .node-info b { display: block; color: #eee; font-size: 14px; }
        .node-info span { font-size: 11px; color: #888; }

        /* –ê–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏—è */
        .auth-box { background: var(--panel); padding: 30px; border-radius: 20px; border: 1px solid #333; display: flex; flex-direction: column; gap: 15px; width: 300px; box-shadow: 0 10px 30px rgba(0,0,0,0.8); }
        input { background: #000; border: 1px solid #444; color: white; padding: 14px; border-radius: 10px; outline: none; transition: 0.3s; }
        input:focus { border-color: var(--primary); box-shadow: 0 0 8px var(--primary); }

        /* HUD */
        #hud { position: fixed; top: 15px; left: 15px; z-index: 500; pointer-events: none; }
        .hp-cont { width: 200px; height: 14px; background: #000; border: 2px solid #333; border-radius: 7px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #f00, #ff4d4d); transition: 0.2s; }
        #exp-line { position: fixed; top: 0; left: 0; width: 100%; height: 5px; background: #111; z-index: 1100; }
        #exp-fill { height: 100%; width: 0%; background: #00ffd4; box-shadow: 0 0 10px #00ffd4; }

        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { background: linear-gradient(180deg, var(--primary) 0%, #008cb3 100%); color: #000; padding: 18px; border-radius: 15px; font-weight: 900; cursor: pointer; border: none; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; }
        .btn:active { transform: scale(0.96); }
        .btn-sec { background: #222; color: #fff; padding: 12px 20px; border-radius: 10px; border: 1px solid #444; cursor: pointer; font-size: 12px; }
        
        /* –î–∂–æ–π—Å—Ç–∏–∫ */
        #joy-base { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 120px; height: 120px; background: rgba(255,255,255,0.03); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; z-index: 100; }
        #joy-stick { position: absolute; top: 35px; left: 35px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 15px var(--primary); }

        /* –ê–Ω–∏–º–∞—Ü–∏—è —Ç—Ä—è—Å–∫–∏ */
        @keyframes shake {
            0% { transform: translate(1px, 1px) rotate(0deg); }
            20% { transform: translate(-3px, 0px) rotate(1deg); }
            40% { transform: translate(3px, 2px) rotate(-1deg); }
            60% { transform: translate(-3px, 1px) rotate(0deg); }
            80% { transform: translate(3px, 1px) rotate(-1deg); }
            100% { transform: translate(1px, -2px) rotate(0deg); }
        }
        .shake-screen { animation: shake 0.2s; }
    </style>
</head>
<body id="main-body">

<div id="exp-line"><div id="exp-fill"></div></div>

<div id="auth-screen" class="ui-screen">
    <div style="text-align: center; margin-bottom: 30px;">
        <h1 style="color: var(--primary); font-size: 40px; margin: 0;">SHAPE V9</h1>
        <p style="color: #666; font-size: 12px;">ACCOUNT SYSTEM & GLOBAL SKILLS</p>
    </div>
    <div class="auth-box">
        <input type="text" id="auth-nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" maxlength="12">
        <input type="password" id="auth-pass" placeholder="–ü–ê–†–û–õ–¨">
        <button class="btn" onclick="account.login()">–í–û–ô–¢–ò / –°–û–ó–î–ê–¢–¨</button>
    </div>
</div>

<div id="lobby" class="ui-screen hidden">
    <div class="profile-header">
        <b id="p-nick">---</b>
        <span>LVL: <span id="p-lvl">1</span></span>
        <div class="xp-mini-bar"><div id="xp-mini-fill"></div></div>
        <span style="font-size: 9px; color: #888;" id="p-exp-text">0/100 EXP</span>
    </div>

    <div style="margin-top: 80px; text-align: center;">
        <div style="color: var(--gold); font-size: 24px; font-weight: bold; margin-bottom: 20px;">üí∞ <span id="l-gold">0</span></div>
        
        <div id="char-grid" style="display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 25px;"></div>

        <div style="display: flex; flex-direction: column; gap: 10px; width: 280px;">
            <button class="btn" onclick="game.preStart('normal')">–í–´–ñ–ò–í–ê–ù–ò–ï (30 –ú–ò–ù)</button>
            <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 10px;">
                <button class="btn" style="padding: 12px; font-size: 11px; background: #700; color: #fff;" onclick="game.preStart('endless')">–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô</button>
                <button class="btn" style="padding: 12px; font-size: 11px; background: #505; color: #fff;" onclick="game.preStart('bossrush')">BOSS RUSH</button>
            </div>
            <button class="btn-sec" onclick="ui.showTab('skill-tree')">üß¨ –î–ï–†–ï–í–û –ù–ê–í–´–ö–û–í</button>
            <button class="btn-sec" onclick="ui.showTab('leaderboard')">üìä –¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</button>
            <button class="btn-sec" onclick="ui.showTab('achievements')">üèÜ –î–û–°–¢–ò–ñ–ï–ù–ò–Ø</button>
        </div>
    </div>
</div>

<div id="skill-tree" class="ui-screen hidden">
    <h2 style="color: var(--primary)">–ì–õ–û–ë–ê–õ–¨–ù–ê–Ø –ü–†–û–ö–ê–ß–ö–ê</h2>
    <p style="font-size: 11px; color: var(--gold)">–î–æ—Å—Ç—É–ø–Ω–æ –æ—á–∫–æ–≤ —É–ª—É—á—à–µ–Ω–∏—è: <span id="tree-points">0</span></p>
    <div class="skill-tree" id="tree-container"></div>
    <button class="btn" onclick="ui.showTab('lobby')" style="width: 200px; margin-top: 30px;">–í–ï–†–ù–£–¢–¨–°–Ø</button>
</div>

<div id="leaderboard" class="ui-screen hidden">
    <h2>–¢–ê–ë–õ–ò–¶–ê –õ–ò–î–ï–†–û–í</h2>
    <div style="display: flex; gap: 5px; margin-bottom: 15px;">
        <button class="btn-sec" onclick="account.renderLB('level')">–£–†–û–í–ï–ù–¨</button>
        <button class="btn-sec" onclick="account.renderLB('endless')">–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô</button>
        <button class="btn-sec" onclick="account.renderLB('bossrush')">BOSS RUSH</button>
    </div>
    <table class="leaderboard-table">
        <thead><tr id="lb-head"></tr></thead>
        <tbody id="lb-body"></tbody>
    </table>
    <button class="btn" onclick="ui.showTab('lobby')" style="width: 200px; margin-top: 20px;">–ù–ê–ó–ê–î</button>
</div>

<div id="hud" class="hidden">
    <div class="hp-cont"><div id="hp-fill"></div></div>
    <div style="font-size: 12px; margin-top: 5px; font-weight: bold;">
        üí∞ <span id="h-gold">0</span> | ‚≠ê <span id="h-lvl">1</span> | ‚è±Ô∏è <span id="h-time">00:00</span>
    </div>
</div>

<canvas id="gameCanvas"></canvas>
<div id="joy-base" class="hidden"><div id="joy-stick"></div></div>

<script>
"use strict";

const account = {
    current: null,
    db: JSON.parse(localStorage.getItem('v9_users')) || {},

    login() {
        const nick = document.getElementById('auth-nick').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();

        if (nick.length < 3 || pass.length < 3) return alert("–°–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π –Ω–∏–∫ –∏–ª–∏ –ø–∞—Ä–æ–ª—å!");

        if (this.db[nick]) {
            if (this.db[nick].pass === pass) {
                this.current = this.db[nick];
            } else {
                return alert("–≠—Ç–æ—Ç –Ω–∏–∫ —É–∂–µ –∑–∞–Ω—è—Ç –¥—Ä—É–≥–∏–º –∏–≥—Ä–æ–∫–æ–º (–Ω–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å)!");
            }
        } else {
            // –†–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è –Ω–æ–≤–æ–≥–æ –∏–≥—Ä–æ–∫–∞
            this.current = {
                nick: nick,
                pass: pass,
                gold: 0,
                lvl: 1,
                exp: 0,
                nextExp: 100,
                unlocked: ['square'],
                achieved: [],
                // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ (–¥–µ—Ä–µ–≤–æ)
                tree: { hp: 0, dmg: 0, armor: 0 },
                treeSpent: 0, // –ü–æ—Ç—Ä–∞—á–µ–Ω–æ –æ—á–∫–æ–≤ –Ω–∞ —Ç–µ–∫—É—â–µ–º —É—Ä–æ–≤–Ω–µ
                // –†–µ–∫–æ—Ä–¥—ã –¥–ª—è —Ç–∞–±–ª–∏—Ü—ã –ª–∏–¥–µ—Ä–æ–≤
                records: { level: 1, endless: 0, bossrush: 0 }
            };
            this.db[nick] = this.current;
        }
        
        this.save();
        this.updateProfile();
        ui.showTab('lobby');
        meta.init();
    },

    save() {
        if (this.current) {
            this.current.records.level = this.current.lvl;
            this.db[this.current.nick] = this.current;
        }
        localStorage.setItem('v9_users', JSON.stringify(this.db));
    },

    updateProfile() {
        const c = this.current;
        document.getElementById('p-nick').innerText = c.nick;
        document.getElementById('p-lvl').innerText = c.lvl;
        document.getElementById('l-gold').innerText = c.gold.toLocaleString();
        
        const perc = (c.exp / c.nextExp) * 100;
        document.getElementById('xp-mini-fill').style.width = perc + '%';
        document.getElementById('p-exp-text').innerText = `${Math.floor(c.exp)}/${c.nextExp} EXP`;
    },

    addGlobalExp(amt) {
        this.current.exp += amt;
        if (this.current.exp >= this.current.nextExp) {
            this.current.lvl++;
            this.current.exp -= this.current.nextExp;
            this.current.nextExp = Math.floor(this.current.nextExp * 1.6);
            alert("–ù–û–í–´–ô –£–†–û–í–ï–ù–¨ –ê–ö–ö–ê–£–ù–¢–ê: " + this.current.lvl);
        }
        this.updateProfile();
        this.save();
    }
};const treeData = [
    { id: 'hp', name: '–ñ–ò–í–£–ß–ï–°–¢–¨', desc: '+15% HP –¥–ª—è –≤—Å–µ—Ö –≥–µ—Ä–æ–µ–≤', icon: '‚ù§Ô∏è' },
    { id: 'dmg', name: '–°–ò–õ–ê –ê–¢–ê–ö–ö–ò', desc: '+10% –∫ —É—Ä–æ–Ω—É –≤—Å–µ—Ö –æ—Ä—É–∂–∏–π', icon: '‚öîÔ∏è' },
    { id: 'armor', name: '–ë–†–û–ù–Ø', desc: '+5% —Å–Ω–∏–∂–µ–Ω–∏—è —É—Ä–æ–Ω–∞', icon: 'üõ°Ô∏è' }
];

// –†–∞—Å—à–∏—Ä—è–µ–º –æ–±—ä–µ–∫—Ç UI –¥–ª—è —Ä–∞–±–æ—Ç—ã —Å –¥–µ—Ä–µ–≤–æ–º –∏ –ª–∏–¥–µ—Ä–∞–º–∏
Object.assign(ui, {
    renderTree() {
        const container = document.getElementById('tree-container');
        const points = account.current.lvl - account.current.treeSpent;
        document.getElementById('tree-points').innerText = points;
        container.innerHTML = '';

        treeData.forEach(s => {
            const level = account.current.tree[s.id];
            const node = document.createElement('div');
            // –ú–æ–∂–Ω–æ –∫–∞—á–∞—Ç—å —Ç–æ–ª—å–∫–æ –µ—Å–ª–∏ –µ—Å—Ç—å –æ—á–∫–∏ (1 —É—Ä–æ–≤–µ–Ω—å = 1 –æ—á–∫–æ)
            const canBuy = points > 0;
            node.className = `tree-node ${canBuy ? 'available' : ''} ${level > 0 ? 'maxed' : ''}`;
            
            node.innerHTML = `
                <div class="node-info">
                    <b>${s.icon} ${s.name} (–£—Ä. ${level})</b>
                    <span>${s.desc}</span>
                </div>
                <button class="btn-sec" ${!canBuy ? 'disabled' : ''} onclick="meta.buyGlobal('${s.id}')">
                    ${canBuy ? '–£–õ–£–ß–®–ò–¢–¨' : '–ù–ï–¢ –û–ß–ö–û–í'}
                </button>
            `;
            container.appendChild(node);
        });
    },

    renderLB(type) {
        const head = document.getElementById('lb-head');
        const body = document.getElementById('lb-body');
        body.innerHTML = '';

        let colName = "–ó–Ω–∞—á–µ–Ω–∏–µ";
        if(type === 'level') colName = "–£—Ä–æ–≤–µ–Ω—å";
        if(type === 'endless') colName = "–í—Ä–µ–º—è (—Å–µ–∫)";
        if(type === 'bossrush') colName = "–ë–æ—Å—Å–æ–≤";

        head.innerHTML = `<th>#</th><th>–ò–≥—Ä–æ–∫</th><th>${colName}</th>`;

        const users = Object.values(account.db)
            .sort((a, b) => {
                if(type === 'level') return b.lvl - a.lvl;
                return (b.records[type] || 0) - (a.records[type] || 0);
            })
            .slice(0, 10);

        users.forEach((u, i) => {
            const val = type === 'level' ? u.lvl : (u.records[type] || 0);
            body.innerHTML += `<tr><td>${i+1}</td><td>${u.nick}</td><td>${val}</td></tr>`;
        });
    }
});

// –°–∏—Å—Ç–µ–º–∞ —á–∞—Å—Ç–∏—Ü –∏ —Ç—Ä—è—Å–∫–∏
const fx = {
    particles: [],
    
    shake() {
        const b = document.getElementById('game-body') || document.body;
        b.classList.add('shake-screen');
        setTimeout(() => b.classList.remove('shake-screen'), 200);
    },

    spawn(x, y, color, count = 8) {
        for(let i=0; i<count; i++) {
            this.particles.push({
                x, y, 
                vx: (Math.random()-0.5)*10, 
                vy: (Math.random()-0.5)*10, 
                life: 1.0, 
                color: color
            });
        }
    },

    update(dt) {
        for(let i = this.particles.length-1; i>=0; i--) {
            const p = this.particles[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= 0.02;
            if(p.life <= 0) this.particles.splice(i, 1);
        }
    },

    draw(ctx) {
        this.particles.forEach(p => {
            ctx.globalAlpha = p.life;
            ctx.fillStyle = p.color;
            ctx.fillRect(p.x, p.y, 4, 4);
        });
        ctx.globalAlpha = 1.0;
    }
};

// –ú–µ—Ç–∞-–ª–æ–≥–∏–∫–∞ –ø–æ–∫—É–ø–æ–∫
meta.buyGlobal = function(id) {
    const points = account.current.lvl - account.current.treeSpent;
    if (points > 0) {
        account.current.tree[id]++;
        account.current.treeSpent++;
        account.save();
        ui.renderTree();
    }
};

// –†–∞–∑—Ä—É—à–∞–µ–º—ã–µ –æ–±—ä–µ–∫—Ç—ã (–Ø—â–∏–∫–∏)
const objects = {
    items: [],
    spawnBox(px, py) {
        const ang = Math.random()*Math.PI*2;
        const d = 400 + Math.random()*400;
        this.items.push({
            x: px + Math.cos(ang)*d,
            y: py + Math.sin(ang)*d,
            type: 'box',
            hp: 1,
            size: 25
        });
    },

    update(player, enemies) {
        for(let i = this.items.length-1; i>=0; i--) {
            const b = this.items[i];
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –ø–æ–ø–∞–¥–∞–Ω–∏—è –ø—É–ª—å –∏–≥—Ä–æ–∫–∞ –ø–æ —è—â–∏–∫—É (—É–ø—Ä–æ—â–µ–Ω–Ω–æ)
            game.entities.bullets.forEach(bul => {
                if(Math.hypot(bul.x - b.x, bul.y - b.y) < b.size + 10) {
                    b.hp = 0;
                    bul.life = 0;
                }
            });

            if(b.hp <= 0) {
                fx.spawn(b.x, b.y, '#8b4513', 12); // –î—Ä–µ–≤–µ—Å–Ω—ã–µ —á–∞—Å—Ç–∏—Ü—ã
                // –í—ã–ø–∞–¥–µ–Ω–∏–µ –±–æ–Ω—É—Å–∞
                const rnd = Math.random();
                if(rnd > 0.7) game.entities.items.push({ x: b.x, y: b.y, type: 'gold_bag' });
                else if(rnd > 0.4) game.entities.items.push({ x: b.x, y: b.y, type: 'heal' });
                this.items.splice(i, 1);
            }
        }
    },

    draw(ctx) {
        this.items.forEach(b => {
            ctx.fillStyle = '#5d4037';
            ctx.strokeStyle = '#3e2723';
            ctx.lineWidth = 2;
            ctx.strokeRect(b.x-12, b.y-12, 24, 24);
            ctx.fillRect(b.x-10, b.y-10, 20, 20);
            // –ö—Ä–µ—Å—Ç –Ω–∞ —è—â–∏–∫–µ
            ctx.beginPath();
            ctx.moveTo(b.x-10, b.y-10); ctx.lineTo(b.x+10, b.y+10);
            ctx.moveTo(b.x+10, b.y-10); ctx.lineTo(b.x-10, b.y+10);
            ctx.stroke();
        });
    }
};// –†–∞—Å—à–∏—Ä—è–µ–º –æ—Å–Ω–æ–≤–Ω–æ–π –æ–±—ä–µ–∫—Ç –∏–≥—Ä—ã
Object.assign(game, {
    mode: 'normal', // normal, endless, bossrush
    
    preStart(mode) {
        this.mode = mode;
        this.start();
    },

    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ —Å—Ç–∞—Ä—Ç–∞ –¥–ª—è —É—á–µ—Ç–∞ –≥–ª–æ–±–∞–ª—å–Ω—ã—Ö –±–æ–Ω—É—Å–æ–≤
    start() {
        const char = meta.chars[meta.selected];
        const mLvl = meta.charLevels[meta.selected];
        const g = account.current.tree; // –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –±–æ–Ω—É—Å—ã –∏–∑ –¥–µ—Ä–µ–≤–∞

        // –ü—Ä–∏–º–µ–Ω—è–µ–º —Å—Ç–∞—Ç—ã: (–ë–∞–∑–∞ * –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–≤–Ω—è) + –ì–ª–æ–±–∞–ª—å–Ω—ã–π –±–æ–Ω—É—Å –¥–µ—Ä–µ–≤–∞
        this.player.maxHp = (char.hp * (1 + mLvl * 0.1)) * (1 + g.hp * 0.15);
        this.player.hp = this.player.maxHp;
        this.player.speed = char.spd * (1 + mLvl * 0.05);
        this.player.dmgMod = 1 + (g.dmg * 0.1); // –ú–Ω–æ–∂–∏—Ç–µ–ª—å —É—Ä–æ–Ω–∞
        this.player.armor = g.armor * 0.05;    // –°–Ω–∏–∂–µ–Ω–∏–µ —É—Ä–æ–Ω–∞

        this.player.x = 0; this.player.y = 0;
        this.player.exp = 0; this.player.nextExp = 100;
        this.player.lvl = 1; this.player.gold = 0;
        this.player.kills = 0; this.player.bossKills = 0;
        this.player.skills = {};
        this.player.skills[char.skill] = 1;

        this.entities = { enemies: [], bullets: [], items: [], texts: [] };
        objects.items = []; // –û—á–∏—Å—Ç–∫–∞ —è—â–∏–∫–æ–≤
        this.elapsed = 0;
        this.active = true;
        this.paused = false;
        
        ui.showTab('hud'); // –ü–æ–∫–∞–∑—ã–≤–∞–µ–º —Ç–æ–ª—å–∫–æ –∏–≥—Ä–æ–≤–æ–π –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('joy-base').classList.remove('hidden');
        
        this.updateUI();
        this.timers.last = performance.now();
        requestAnimationFrame((t) => this.loop(t));
    },

    update(dt) {
        if (this.paused) return;

        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        let curSpd = this.player.speed;
        if (this.player.skills.speed_up) curSpd *= (1 + this.player.skills.speed_up * 0.15);
        
        if (this.input.joyActive) {
            this.player.x += this.input.dx * curSpd;
            this.player.y += this.input.dy * curSpd;
        }

        this.elapsed += dt;
        const totalSec = Math.floor(this.elapsed / 1000);

        // –¢–∞–π–º–µ—Ä—ã –æ—Ä—É–∂–∏—è (—É—á–∏—Ç—ã–≤–∞–µ–º dmgMod)
        this.updateWeapons(dt);

        // –°–ø–∞–≤–Ω –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ä–µ–∂–∏–º–∞
        this.handleSpawning(dt, totalSec);

        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Å—É—â–Ω–æ—Å—Ç–µ–π –∏ –æ–±—ä–µ–∫—Ç–æ–≤
        this.processEnemies(dt);
        this.processBullets(dt);
        this.processItems(dt);
        objects.update(this.player);
        fx.update(dt);

        // –°–ø–∞–≤–Ω —è—â–∏–∫–æ–≤ –∫–∞–∂–¥—ã–µ 15 —Å–µ–∫—É–Ω–¥
        if (totalSec % 15 === 0 && Math.random() < 0.02) {
            objects.spawnBox(this.player.x, this.player.y);
        }

        this.updateUI();
        
        // –õ–∏–º–∏—Ç –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –Ω–æ—Ä–º–∞–ª—å–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞
        if (this.mode === 'normal' && totalSec >= 1800) this.gameOver(true);
    },

    handleSpawning(dt, sec) {
        this.timers.spawn += dt;
        let rate = 800;

        if (this.mode === 'bossrush') {
            rate = 5000; // –†–µ–∂–µ –æ–±—ã—á–Ω—ã–µ –≤—Ä–∞–≥–∏
            if (sec > 0 && sec % 30 === 0 && !this.entities.enemies.some(e => e.isBoss)) {
                this.spawnEnemy(true);
            }
        } else {
            rate = Math.max(100, 900 - (this.player.lvl * 30));
            if (this.mode === 'endless') rate *= 0.8; // –ë–æ–ª—å—à–µ –≤—Ä–∞–≥–æ–≤
            if (sec > 0 && sec % 300 === 0) this.spawnEnemy(true);
        }

        if (this.timers.spawn > rate) {
            this.spawnEnemy(false);
            this.timers.spawn = 0;
        }
    },

    processEnemies(dt) {
        for (let i = this.entities.enemies.length - 1; i >= 0; i--) {
            const e = this.entities.enemies[i];
            const d = Math.hypot(this.player.x - e.x, this.player.y - e.y);
            
            e.x += ((this.player.x - e.x) / d) * e.speed;
            e.y += ((this.player.y - e.y) / d) * e.speed;

            // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
            if (d < this.player.size + e.size && !this.admGod) {
                let dmg = e.isBoss ? 1.5 : 0.6;
                dmg *= (1 - this.player.armor); // –ë—Ä–æ–Ω—è –∏–∑ –¥–µ—Ä–µ–≤–∞
                if (this.player.skills.shield) dmg *= (1 - this.player.skills.shield * 0.15);
                
                this.player.hp -= dmg;
                fx.shake(); // –¢—Ä—è—Å–∫–∞ –ø—Ä–∏ —É—Ä–æ–Ω–µ
                if (this.player.hp <= 0) this.gameOver(false);
            }

            if (e.hp <= 0) {
                const isB = e.isBoss;
                if (isB) this.player.bossKills++;
                this.player.kills++;
                
                // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ –æ–ø—ã—Ç–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
                account.addGlobalExp(isB ? 10 : 1);
                
                // –ó–æ–ª–æ—Ç–æ –∏ –æ–ø—ã—Ç –≤ –º–∞—Ç—á–µ
                this.player.gold += (isB ? 500 : 10);
                this.entities.items.push({ x: e.x, y: e.y, type: 'exp' });
                
                fx.spawn(e.x, e.y, e.color, isB ? 25 : 8); // –ß–∞—Å—Ç–∏—Ü—ã —Å–º–µ—Ä—Ç–∏
                this.entities.enemies.splice(i, 1);
            }
        }
    },

    processItems(dt) {
        for (let i = this.entities.items.length - 1; i >= 0; i--) {
            const it = this.entities.items[i];
            const d = Math.hypot(it.x - this.player.x, it.y - this.player.y);
            
            if (d < 120) {
                it.x += (this.player.x - it.x) * 0.2;
                it.y += (this.player.y - it.y) * 0.2;
            }

            if (d < 20) {
                if (it.type === 'exp') this.player.exp += 35;
                if (it.type === 'heal') this.player.hp = Math.min(this.player.maxHp, this.player.hp + 30);
                if (it.type === 'gold_bag') this.player.gold += 200;
                
                this.entities.items.splice(i, 1);
                if (this.player.exp >= this.player.nextExp) this.levelUp();
            }
        }
    },

    gameOver(win) {
        this.active = false;
        const totalGold = Math.floor(this.player.gold);
        account.current.gold += totalGold;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
        const rec = account.current.records;
        const sec = Math.floor(this.elapsed / 1000);
        
        if (this.mode === 'endless' && sec > rec.endless) rec.endless = sec;
        if (this.mode === 'bossrush' && this.player.bossKills > rec.bossrush) rec.bossrush = this.player.bossKills;
        
        account.save();
        
        alert(`${win ? '–ü–û–ë–ï–î–ê!' : '–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê'}\n–°–æ–±—Ä–∞–Ω–æ –∑–æ–ª–æ—Ç–∞: ${totalGold}\n–£–±–∏—Ç–æ –≤—Ä–∞–≥–æ–≤: ${this.player.kills}`);
        location.reload();
    }
});// –§–∏–Ω–∞–ª–∏–∑–∞—Ü–∏—è —Ä–µ–Ω–¥–µ—Ä–∏–Ω–≥–∞ –∏ –æ—Ä—É–∂–∏—è
Object.assign(game, {
    render() {
        const ctx = this.ctx;
        const cx = this.width / 2, cy = this.height / 2;
        
        // –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞
        ctx.fillStyle = '#050805';
        ctx.fillRect(0, 0, this.width, this.height);

        ctx.save();
        ctx.translate(cx - this.player.x, cy - this.player.y);

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞ (–ø–ª–∏—Ç–∫–∞)
        const gridSize = 128;
        const startX = Math.floor(this.player.x / gridSize) * gridSize - gridSize * 5;
        const startY = Math.floor(this.player.y / gridSize) * gridSize - gridSize * 5;
        for (let x = startX; x < startX + gridSize * 11; x += gridSize) {
            for (let y = startY; y < startY + gridSize * 11; y += gridSize) {
                ctx.drawImage(this.bgTile, x, y);
            }
        }

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ä–∞–∑—Ä—É—à–∞–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
        objects.draw(ctx);

        // –í—Ä–∞–≥–∏
        this.entities.enemies.forEach(e => {
            ctx.fillStyle = e.color;
            ctx.beginPath();
            ctx.arc(e.x, e.y, e.size, 0, Math.PI * 2);
            ctx.fill();
            if (e.isBoss) {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 3;
                ctx.stroke();
                // –ü–æ–ª–æ—Å–∫–∞ HP –±–æ—Å—Å–∞
                ctx.fillStyle = '#000';
                ctx.fillRect(e.x - 30, e.y - e.size - 10, 60, 6);
                ctx.fillStyle = '#f00';
                ctx.fillRect(e.x - 30, e.y - e.size - 10, 60 * (e.hp / e.maxHp), 6);
            }
        });

        // –°—Ñ–µ—Ä—ã –æ–ø—ã—Ç–∞ –∏ –±–æ–Ω—É—Å—ã
        this.entities.items.forEach(it => {
            if(it.type === 'exp') ctx.fillStyle = '#00ffd4';
            else if(it.type === 'heal') ctx.fillStyle = '#ff4d4d';
            else if(it.type === 'gold_bag') ctx.fillStyle = '#ffd700';
            
            ctx.beginPath();
            ctx.arc(it.x, it.y, it.type === 'exp' ? 6 : 10, 0, Math.PI * 2);
            ctx.fill();
            if(it.type !== 'exp') { 
                ctx.strokeStyle = '#fff'; ctx.lineWidth = 1; ctx.stroke(); 
            }
        });

        // –°–Ω–∞—Ä—è–¥—ã
        this.entities.bullets.forEach(b => {
            ctx.fillStyle = b.color;
            if (b.type === 'brick') {
                ctx.fillRect(b.x - 20, b.y - 12, 40, 24);
            } else {
                ctx.beginPath();
                ctx.arc(b.x, b.y, 8, 0, Math.PI * 2);
                ctx.fill();
            }
        });

        // –ò–≥—Ä–æ–∫ (–≤—ã–∑–æ–≤ —Ñ—É–Ω–∫—Ü–∏–∏ –æ—Ç—Ä–∏—Å–æ–≤–∫–∏ —Ñ–æ—Ä–º—ã –∏–∑ V8)
        this.renderPlayer(ctx, this.player.x, this.player.y);

        // –≠—Ñ—Ñ–µ–∫—Ç—ã —á–∞—Å—Ç–∏—Ü
        fx.draw(ctx);

        // –¢–µ–∫—Å—Ç—ã —É—Ä–æ–Ω–∞ / —ç—Ñ—Ñ–µ–∫—Ç–æ–≤
        this.entities.texts.forEach((t, i) => {
            ctx.fillStyle = t.color;
            ctx.font = 'bold 20px Arial';
            ctx.fillText(t.txt, t.x, t.y);
            t.y -= 1;
            t.life -= 16;
            if (t.life <= 0) this.entities.texts.splice(i, 1);
        });

        ctx.restore();
    },

    // –ú–æ–¥–∏—Ñ–∏—Ü–∏—Ä–æ–≤–∞–Ω–Ω–∞—è —Å—Ç—Ä–µ–ª—å–±–∞ —Å —É—á–µ—Ç–æ–º –≥–ª–æ–±–∞–ª—å–Ω–æ–≥–æ —É—Ä–æ–Ω–∞
    weaponShot() {
        const target = this.getClosestEnemy();
        if (!target) return;
        const lvl = this.player.skills.shot;
        const isEvo = lvl >= 6;
        const count = isEvo ? 5 : 1 + Math.floor(lvl / 3);
        
        // –ë–∞–∑–æ–≤—ã–π —É—Ä–æ–Ω —É–º–Ω–æ–∂–∞–µ–º –Ω–∞ dmgMod –∏–∑ –¥–µ—Ä–µ–≤–∞ –Ω–∞–≤—ã–∫–æ–≤
        const baseDmg = (isEvo ? 400 : 60) + (lvl * 15);
        const totalDmg = baseDmg * this.player.dmgMod;

        for (let i = 0; i < count; i++) {
            const angle = Math.atan2(target.y - this.player.y, target.x - this.player.x) + (i - (count-1)/2) * 0.2;
            this.entities.bullets.push({
                x: this.player.x, y: this.player.y,
                vx: Math.cos(angle) * 16, vy: Math.sin(angle) * 16,
                dmg: totalDmg,
                life: 1200, type: 'bullet',
                color: isEvo ? '#ff004c' : '#00d4ff'
            });
        }
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ —Å—Ç—Ä–∞–Ω–∏—Ü—ã
window.onload = () => {
    game.init();
    
    // –ü–µ—Ä–µ–æ–ø—Ä–µ–¥–µ–ª—è–µ–º –º–µ—Ç–æ–¥ init –≤ meta, —á—Ç–æ–±—ã –æ–Ω –Ω–µ –∑–∞–ø—É—Å–∫–∞–ª—Å—è –¥–æ –∞–≤—Ç–æ—Ä–∏–∑–∞—Ü–∏–∏
    meta.init = function() {
        this.gold = account.current.gold;
        this.unlocked = account.current.unlocked;
        this.achieved = account.current.achieved;
        this.renderLobby();
        this.renderAch();
        ui.renderTree();
    };

    // –°–ª—É—à–∞—Ç–µ–ª—å –¥–ª—è –∫–Ω–æ–ø–∫–∏ –æ—Ç–∫—Ä—ã—Ç–∏—è –¥–µ—Ä–µ–≤–∞
    const oldShowTab = ui.showTab;
    ui.showTab = function(id) {
        if(id === 'skill-tree') ui.renderTree();
        if(id === 'leaderboard') account.renderLB('level');
        oldShowTab.call(ui, id);
    };
};

// –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –¥–∂–æ–π—Å—Ç–∏–∫–∞ –≤ V9 (—É—á–µ—Ç —Ü–µ–Ω—Ç—Ä–∏—Ä–æ–≤–∞–Ω–∏—è)
game.setupControls = function() {
    const base = document.getElementById('joy-base');
    const stick = document.getElementById('joy-stick');
    
    const handleMove = (e) => {
        if (!this.active || this.paused) return;
        const touch = e.touches ? e.touches[0] : e;
        const rect = base.getBoundingClientRect();
        const centerX = rect.left + rect.width / 2;
        const centerY = rect.top + rect.height / 2;
        
        let dx = touch.clientX - centerX;
        let dy = touch.clientY - centerY;
        const dist = Math.hypot(dx, dy);
        const maxDist = 45;

        this.input.joyActive = true;
        const angle = Math.atan2(dy, dx);
        const moveDist = Math.min(dist, maxDist);

        this.input.dx = Math.cos(angle) * (moveDist / maxDist);
        this.input.dy = Math.sin(angle) * (moveDist / maxDist);

        stick.style.transform = `translate(${Math.cos(angle) * moveDist}px, ${Math.sin(angle) * moveDist}px)`;
    };

    const handleEnd = () => {
        this.input.joyActive = false;
        this.input.dx = 0; this.input.dy = 0;
        stick.style.transform = `translate(0px, 0px)`;
    };

    base.addEventListener('touchstart', (e) => { e.preventDefault(); handleMove(e); }, {passive: false});
    base.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, {passive: false});
    base.addEventListener('touchend', handleEnd);
    
    // –ü–ö —É–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
    window.addEventListener('keydown', (e) => {
        if(!this.active) return;
        this.input.joyActive = true;
        if (e.key === 'w' || e.key === 'ArrowUp') this.input.dy = -1;
        if (e.key === 's' || e.key === 'ArrowDown') this.input.dy = 1;
        if (e.key === 'a' || e.key === 'ArrowLeft') this.input.dx = -1;
        if (e.key === 'd' || e.key === 'ArrowRight') this.input.dx = 1;
    });
    window.addEventListener('keyup', handleEnd);
};

</script>
</body>
</html>
