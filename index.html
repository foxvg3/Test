<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivor.io - Mega Skills Update</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; }
        .hidden { display: none !important; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .top-bar { display: flex; align-items: center; gap: 10px; }
        #exp-bar { flex-grow: 1; height: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; overflow: hidden; }
        #exp-fill { width: 0%; height: 100%; background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
        #timer { font-size: 20px; font-weight: bold; text-align: center; margin-top: 5px; }
        #hp-bar { width: 120px; height: 12px; background: #333; margin-top: 5px; border-radius: 6px; border: 2px solid #000; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; transition: width 0.2s; }
        #gold-ui { color: #ffd700; font-weight: bold; margin-top: 5px; }

        #dev-toggle { position: absolute; top: 80px; right: 10px; z-index: 30; background: #00d4ff; color: black; padding: 5px 10px; border-radius: 5px; font-size: 12px; font-weight: bold; display: none; pointer-events: all; cursor: pointer; }
        #dev-panel { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; gap: 10px; }
        .dev-grid { display: grid; grid-template-columns: 1fr 1fr; gap: 10px; width: 90%; max-width: 400px; }
        .dev-btn { background: #222; border: 2px solid #00d4ff; color: #00d4ff; padding: 10px; border-radius: 8px; font-weight: bold; text-align: center; cursor: pointer; font-size: 11px; }

        #level-up, #death-screen { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: none; align-items: center; justify-content: center; z-index: 150; flex-direction: column; }
        .modal { background: #1a1a1a; padding: 15px; border-radius: 15px; border: 3px solid #00d4ff; width: 90%; max-width: 380px; text-align: center; }
        #cards-container { display: flex; flex-direction: column; gap: 8px; width: 100%; }
        .card { background: #2a2a2a; border: 2px solid #444; padding: 12px; border-radius: 10px; cursor: pointer; text-align: left; pointer-events: all; }
        .card b { color: #00d4ff; display: block; font-size: 14px; }
        .card span { font-size: 12px; color: #ccc; }
        .evo-txt { color: #ff4444 !important; text-shadow: 0 0 5px #ff4444; }
        
        #joystick-container { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; z-index: 5; }
        #joystick-base { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(0,212,255,0.2); display: flex; align-items: center; justify-content: center; }
        #joystick-stick { width: 40px; height: 40px; background: #00d4ff; border-radius: 50%; opacity: 0.6; }
    </style>
</head>
<body>

<div id="ui">
    <div class="top-bar">
        <div style="font-weight: bold; color: #00d4ff;">Lvl <span id="lvl">1</span></div>
        <div id="exp-bar"><div id="exp-fill"></div></div>
    </div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div id="gold-ui">üí∞ <span id="gold-count">0</span></div>
    <div id="timer">00:00</div>
</div>

<div id="dev-toggle" onclick="toggleDevPanel()">DEV MENU</div>

<div id="dev-panel">
    <h2 style="color:#00d4ff">MEGA ADMIN</h2>
    <div class="dev-grid">
        <div class="dev-btn" onclick="godMode=!godMode; this.innerText='–ë–û–ì: '+(godMode?'–í–ö–õ':'–í–´–ö–õ')">–ë–û–ì: –í–´–ö–õ</div>
        <div class="dev-btn" onclick="devKillAll()">–£–ë–ò–¢–¨ –í–°–ï–•</div>
        <div class="dev-btn" onclick="timeOffset += 60">+1 –ú–ò–ù</div>
        <div class="dev-btn" onclick="devMagnet()">–ú–ê–ì–ù–ò–¢</div>
        <div class="dev-btn" onclick="devBlackHole()">–ß–ï–†–ù–ê–Ø –î–´–†–ê</div>
        <div class="dev-btn" onclick="persistentUpgrades.gold += 5000; updateGoldUI()">+5000 $</div>
        <div class="dev-btn" style="border-color: yellow;" onclick="closeDevAndLvl()">LVL UP</div>
        <div class="dev-btn" style="border-color: #ff4444;" onclick="devResetAll()">–°–ë–†–û–°</div>
    </div>
    <div class="dev-btn" style="width: 200px; border-color: red; margin-top: 15px;" onclick="toggleDevPanel()">–í–´–•–û–î</div>
</div>

<div id="death-screen">
    <h1 style="color: red;">–ö–û–ù–ï–¶ –ò–ì–†–´</h1>
    <div id="shop-container" style="margin: 10px 0;"></div>
    <div class="dev-btn" onclick="location.reload()" style="margin-top:20px; background:#00d4ff; color:black; width: 200px;">–†–ï–°–¢–ê–†–¢</div>
</div>

<div id="level-up"><div class="modal"><h2>–í–´–ë–ï–†–ò –ù–ê–í–´–ö</h2><div id="cards-container"></div></div></div>

<canvas id="game"></canvas>
<div id="joystick-container"><div id="joystick-base"><div id="joystick-stick"></div></div></div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let gameActive = true, isPaused = false, godMode = false;
    let startTime = Date.now(), timeOffset = 0, lastBossSpawn = 0;
    
    let persistentUpgrades = JSON.parse(localStorage.getItem('survivor_upgrades')) || { dmg: 0, hp: 0, gold: 0 };
    if (window.location.search.includes('ad')) document.getElementById('dev-toggle').style.display = 'block';

    const player = {
        x: 0, y: 0, hp: 100 + persistentUpgrades.hp, maxHp: 100 + persistentUpgrades.hp, lvl: 1, exp: 0, nextLvl: 100, speed: 3.5, armor: 0,
        magnet: 60, expMult: 1, cooldown: 1,
        skills: { 
            weapon: 1, lightning: 0, field: 0, brick: 0, mines: 0, // –ê–∫—Ç–∏–≤–Ω—ã–µ
            p_magnet: 0, p_exp: 0, p_speed: 0, p_cd: 0, p_hp: 0   // –ü–∞—Å—Å–∏–≤–Ω—ã–µ
        }
    };

    let enemies = [], bullets = [], crystals = [], goldDrops = [], particles = [];
    let stats = { fireRate: 800, lastShot: 0, lastLightning: 0, lastBrick: 0, lastMine: 0 };

    // –ë–∞–∑–∞ –¥–∞–Ω–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤
    const SKILLS_DB = {
        active: [
            { id: 'weapon', n: '–ü—É—à–∫–∞', d: '–û—Å–Ω–æ–≤–Ω–æ–µ –æ—Ä—É–∂–∏–µ' },
            { id: 'lightning', n: '–ú–æ–ª–Ω–∏—è', d: '–ë—å–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—Ä–∞–≥–∞' },
            { id: 'field', n: '–ü–æ–ª–µ', d: '–£—Ä–æ–Ω –≤–æ–∫—Ä—É–≥ —Ç–µ–±—è' },
            { id: 'brick', n: '–ö–∏—Ä–ø–∏—á', d: '–ü—Ä–æ–±–∏–≤–∞–µ—Ç –≤—Ä–∞–≥–æ–≤ –Ω–∞—Å–∫–≤–æ–∑—å' },
            { id: 'mines', n: '–ú–∏–Ω—ã', d: '–í–∑—Ä—ã–≤–∞—é—Ç—Å—è –ø–æ–¥ –Ω–æ–≥–∞–º–∏' }
        ],
        passive: [
            { id: 'p_magnet', n: '–ú–∞–≥–Ω–∏—Ç', d: '–†–∞–¥–∏—É—Å —Å–±–æ—Ä–∞ +25%' },
            { id: 'p_exp', n: '–ú—É–¥—Ä–æ—Å—Ç—å', d: '–û–ø—ã—Ç +20%' },
            { id: 'p_speed', n: '–û–±—É–≤—å', d: '–°–∫–æ—Ä–æ—Å—Ç—å –±–µ–≥–∞ +15%' },
            { id: 'p_cd', n: '–ß–∞—Å—ã', d: '–ü–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∞ -10%' },
            { id: 'p_hp', n: '–ë—Ä–æ–Ω—è', d: '–ú–∞–∫—Å. –∑–¥–æ—Ä–æ–≤—å–µ +20%' }
        ]
    };

    function toggleDevPanel() { isPaused = !isPaused; document.getElementById('dev-panel').style.display = isPaused ? 'flex' : 'none'; }
    function devKillAll() { enemies.forEach(e => spawnLoot(e)); enemies = []; }
    function devMagnet() { crystals.forEach(c => { c.x = player.x; c.y = player.y; }); goldDrops.forEach(g => { g.x = player.x; g.y = player.y; }); }
    function devBlackHole() { enemies.forEach(e => { e.x = player.x; e.y = player.y; }); }
    function devResetAll() { localStorage.removeItem('survivor_upgrades'); location.reload(); }
    function closeDevAndLvl() { toggleDevPanel(); showLevelUp(); }
    
    function updateGoldUI() { document.getElementById('gold-count').innerText = persistentUpgrades.gold; }
    updateGoldUI();

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize); resize();

    let joystick = { active: false, x: 0, y: 0 };
    const stick = document.getElementById('joystick-stick'), jBase = document.getElementById('joystick-base');
    function handleInput(e) {
        const t = e.touches ? e.touches[0] : e;
        const b = jBase.getBoundingClientRect();
        const dx = t.clientX - (b.left + b.width/2), dy = t.clientY - (b.top + b.height/2);
        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
        const a = Math.atan2(dy, dx);
        joystick.x = Math.cos(a) * (d/40); joystick.y = Math.sin(a) * (d/40);
        stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    }
    document.addEventListener('touchstart', e => { if(!isPaused && gameActive) joystick.active = true; handleInput(e); });
    document.addEventListener('touchmove', e => { if(joystick.active) { e.preventDefault(); handleInput(e); } }, {passive: false});
    document.addEventListener('touchend', () => { joystick.active = false; stick.style.transform = 'translate(0,0)'; });

    function spawnLoot(e) {
        crystals.push({x: e.x, y: e.y, big: e.boss});
        if(Math.random() > 0.8 || e.boss) goldDrops.push({x: e.x, y: e.y});
    }

    function update() {
        if(!gameActive || isPaused) return requestAnimationFrame(update);
        let elapsed = Math.floor((Date.now() - startTime) / 1000) + timeOffset;
        document.getElementById('timer').innerText = `${Math.floor(elapsed/60).toString().padStart(2,'0')}:${(elapsed%60).toString().padStart(2,'0')}`;
        let diff = 1 + (Math.floor(elapsed/60) * 0.1);

        if(joystick.active) { player.x += joystick.x * player.speed; player.y += joystick.y * player.speed; }

        // --- –ê–¢–ê–ö–ò ---
        let now = Date.now();
        let cd = player.cooldown;

        // 1. –ü—É—à–∫–∞
        if(now - stats.lastShot > (stats.fireRate * cd)) {
            let near = getNearestEnemy(800);
            if(near) {
                let a = Math.atan2(near.y - player.y, near.x - player.x);
                bullets.push({x: player.x, y: player.y, vx: Math.cos(a)*12, vy: Math.sin(a)*12, type: 'bullet', pen: player.skills.weapon>=6?10:1});
                stats.lastShot = now;
            }
        }

        // 2. –ú–æ–ª–Ω–∏—è
        if(player.skills.lightning > 0 && now - stats.lastLightning > (2000 * cd)) {
            let targets = enemies.slice(0, player.skills.lightning);
            targets.forEach(e => {
                e.hp -= (100 + player.lvl*10); e.hit = 10;
                particles.push({x: e.x, y: e.y, t: 15, type: 'bolt'});
            });
            stats.lastLightning = now;
        }

        // 3. –ü–æ–ª–µ (–∫–∞–∂–¥—ã–π –∫–∞–¥—Ä)
        if(player.skills.field > 0) {
            let radius = 80 + player.skills.field * 15;
            enemies.forEach(e => {
                if(Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2) < radius) {
                    e.hp -= 2; e.hit = 2;
                }
            });
        }

        // 4. –ö–∏—Ä–ø–∏—á
        if(player.skills.brick > 0 && now - stats.lastBrick > (3000 * cd)) {
            bullets.push({x: player.x, y: player.y, vx: 0, vy: -15, type: 'brick', grav: 0.5, pen: 99});
            stats.lastBrick = now;
        }

        // 5. –ú–∏–Ω—ã
        if(player.skills.mines > 0 && now - stats.lastMine > (4000 * cd)) {
            particles.push({x: player.x, y: player.y, t: 500, type: 'mine'});
            stats.lastMine = now;
        }

        // --- –î–í–ò–ñ–ï–ù–ò–ï –û–ë–™–ï–ö–¢–û–í ---
        bullets.forEach((b, bi) => {
            if(b.type === 'brick') { b.vy += b.grav; }
            b.x += b.vx; b.y += b.vy;
            enemies.forEach((e, ei) => {
                if(Math.sqrt((b.x-e.x)**2 + (b.y-e.y)**2) < e.size) {
                    e.hp -= (30 + player.skills.weapon*10); e.hit = 5; b.pen--;
                    if(b.pen <= 0) bullets.splice(bi, 1);
                    if(e.hp <= 0) { spawnLoot(e); enemies.splice(ei, 1); }
                }
            });
            if(Math.abs(b.y-player.y) > 1000) bullets.splice(bi, 1);
        });

        // –ú–∏–Ω—ã –∏ –ø–∞—Ä—Ç–∏–∫–ª—ã
        particles.forEach((p, pi) => {
            if(p.type === 'mine') {
                enemies.forEach((e, ei) => {
                    if(Math.sqrt((p.x-e.x)**2 + (p.y-e.y)**2) < 40) {
                        e.hp -= 200; e.hit = 10; particles.splice(pi, 1);
                    }
                });
            }
            p.t--; if(p.t <= 0) particles.splice(pi, 1);
        });

        if(enemies.length < 40) {
            let a = Math.random()*Math.PI*2;
            enemies.push({ x: player.x+Math.cos(a)*700, y: player.y+Math.sin(a)*700, hp: (40 + player.lvl*10)*diff, speed: 1.5, size: 18, color: '#ff4444', hit: 0 });
        }

        enemies.forEach(e => {
            let a = Math.atan2(player.y-e.y, player.x-e.x);
            e.x += Math.cos(a)*e.speed; e.y += Math.sin(a)*e.speed;
            if(e.hit > 0) e.hit--;
            if(Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2) < e.size + 10) {
                if(!godMode) player.hp -= 0.5 * diff;
                if(player.hp <= 0) gameOver();
            }
        });

        crystals.forEach((c, i) => { if(Math.sqrt((c.x-player.x)**2+(c.y-player.y)**2) < player.magnet) { player.exp += (c.big?1000:40) * player.expMult; crystals.splice(i,1); if(player.exp >= player.nextLvl) showLevelUp(); }});
        goldDrops.forEach((g, i) => { if(Math.sqrt((g.x-player.x)**2+(g.y-player.y)**2) < player.magnet) { persistentUpgrades.gold += 15; goldDrops.splice(i,1); updateGoldUI(); }});

        draw();
        requestAnimationFrame(update);
    }

    function gameOver() { gameActive = false; document.getElementById('death-screen').style.display = 'flex'; localStorage.setItem('survivor_upgrades', JSON.stringify(persistentUpgrades)); }

    function showLevelUp() {
        isPaused = true; const cont = document.getElementById('cards-container'); cont.innerHTML = '';
        document.getElementById('level-up').style.display = 'flex';
        
        let pool = [];
        SKILLS_DB.active.forEach(s => { if(player.skills[s.id] < 6) pool.push({ ...s, type: 'active' }); });
        SKILLS_DB.passive.forEach(s => { if(player.skills[s.id] < 6) pool.push({ ...s, type: 'passive' }); });
        
        pool.sort(() => 0.5 - Math.random()).slice(0, 3).forEach(s => {
            let lvl = player.skills[s.id] + 1;
            let d = document.createElement('div'); d.className = 'card';
            d.innerHTML = `<b>${s.n} ${lvl}‚òÖ</b><span>${s.d}</span>`;
            d.onclick = () => { upgradeSkill(s.id); finishLvlUp(); };
            cont.appendChild(d);
        });
    }

    function upgradeSkill(id) {
        player.skills[id]++;
        if(id === 'p_magnet') player.magnet += 30;
        if(id === 'p_exp') player.expMult += 0.2;
        if(id === 'p_speed') player.speed += 0.5;
        if(id === 'p_cd') player.cooldown -= 0.1;
        if(id === 'p_hp') { player.maxHp += 20; player.hp += 20; }
    }

    function finishLvlUp() { player.lvl++; player.exp = 0; player.nextLvl *= 1.3; isPaused = false; document.getElementById('level-up').style.display = 'none'; }

    function getNearestEnemy(range) {
        let near = null, minD = range;
        enemies.forEach(e => { let d = Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2); if(d < minD) { minD = d; near = e; }});
        return near;
    }

    function draw() {
        ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
        const cx = canvas.width/2, cy = canvas.height/2;

        // –°–µ—Ç–∫–∞
        ctx.strokeStyle = '#111'; ctx.lineWidth = 1;
        for(let x = -player.x % 50; x < canvas.width; x += 50) { ctx.beginPath(); ctx.moveTo(x,0); ctx.lineTo(x,canvas.height); ctx.stroke(); }
        for(let y = -player.y % 50; y < canvas.height; y += 50) { ctx.beginPath(); ctx.moveTo(0,y); ctx.lineTo(canvas.width,y); ctx.stroke(); }

        // –≠—Ñ—Ñ–µ–∫—Ç—ã –∞—Ç–∞–∫
        if(player.skills.field > 0) {
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.2)'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(cx, cy, 80 + player.skills.field * 15, 0, Math.PI*2); ctx.stroke();
        }

        particles.forEach(p => {
            if(p.type === 'bolt') { ctx.strokeStyle = 'white'; ctx.lineWidth = 3; ctx.beginPath(); ctx.moveTo(p.x-player.x+cx, p.y-player.y+cy-50); ctx.lineTo(p.x-player.x+cx, p.y-player.y+cy); ctx.stroke(); }
            if(p.type === 'mine') { ctx.fillStyle = 'red'; ctx.beginPath(); ctx.arc(p.x-player.x+cx, p.y-player.y+cy, 5, 0, Math.PI*2); ctx.fill(); }
        });

        crystals.forEach(c => { ctx.fillStyle = c.big ? '#ff00ff' : '#00f2ff'; ctx.fillRect(c.x-player.x+cx-4, c.y-player.y+cy-4, 8, 8); });
        goldDrops.forEach(g => { ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(g.x-player.x+cx, g.y-player.y+cy, 5, 0, Math.PI*2); ctx.fill(); });
        enemies.forEach(e => { ctx.fillStyle = e.hit > 0 ? 'white' : e.color; ctx.beginPath(); ctx.arc(e.x-player.x+cx, e.y-player.y+cy, e.size, 0, Math.PI*2); ctx.fill(); });
        
        bullets.forEach(b => {
            ctx.fillStyle = b.type === 'brick' ? '#888' : '#ffff00';
            let s = b.type === 'brick' ? 15 : 6;
            ctx.fillRect(b.x-player.x+cx-s/2, b.y-player.y+cy-s/2, s, s);
        });

        ctx.fillStyle = godMode ? '#ffd700' : '#0066ff'; ctx.fillRect(cx-10, cy-10, 20, 20);
        document.getElementById('lvl').innerText = player.lvl;
        document.getElementById('exp-fill').style.width = (player.exp/player.nextLvl*100)+'%';
        document.getElementById('hp-fill').style.width = (player.hp/player.maxHp*100)+'%';
    }
    requestAnimationFrame(update);
</script>
</body>
</html>
