<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivor.io - Difficulty Levels</title>
    <style>
        body { margin: 0; background: #020202; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; }
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: #111; padding: 25px; border-radius: 20px; border: 2px solid #00d4ff; width: 95%; max-width: 450px; text-align: center; }
        
        /* –°—Ç–∏–ª–∏ –∫–∞—Ä—Ç–æ—á–µ–∫ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏ */
        .diff-card { background: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 15px; margin: 10px 0; cursor: pointer; transition: 0.3s; position: relative; overflow: hidden; }
        .diff-card.unlocked { border-color: #00d4ff; }
        .diff-card.locked { opacity: 0.5; cursor: not-allowed; border-color: #444; }
        .diff-card.selected { border-color: #00ff00; background: #0a1f0a; transform: scale(1.02); }
        .diff-card b { font-size: 18px; display: block; }
        .diff-card small { color: #888; }
        .lock-icon { position: absolute; right: 15px; top: 50%; transform: translateY(-50%); font-size: 20px; }
        
        .reward-tag { color: #ffd700; font-weight: bold; font-size: 12px; margin-top: 5px; display: block; }

        .btn { background: #222; border: 2px solid #00d4ff; color: #00d4ff; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; margin-top: 20px; width: 80%; display: inline-block; }
        .btn:active { transform: scale(0.98); }
        
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; z-index: 10; pointer-events: none; }
        #exp-bar { width: 100%; height: 10px; background: #1a1a1a; border-radius: 5px; border: 1px solid #333; overflow: hidden; }
        #exp-fill { width: 0%; height: 100%; background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
        #hp-bar { width: 140px; height: 14px; background: #333; margin-top: 8px; border-radius: 7px; overflow: hidden; border: 1px solid #000; }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; }
    </style>
</head>
<body>

<div id="diff-menu" class="overlay">
    <div class="modal">
        <h2 style="margin-top: 0; color: #00d4ff;">–í–´–ë–ï–†–ò–¢–ï –°–õ–û–ñ–ù–û–°–¢–¨</h2>
        
        <div id="diff-easy" class="diff-card unlocked selected" onclick="selectDifficulty('easy')">
            <b>–õ–ï–ì–ö–û</b>
            <small>–í—Ä–∞–≥–∏ —Å–ª–∞–±—ã–µ. –ò–¥–µ–∞–ª—å–Ω–æ –¥–ª—è –Ω–∞—á–∞–ª–∞.</small>
            <span class="reward-tag">–ù–∞–≥—Ä–∞–¥—ã: x1.0 üí∞</span>
        </div>

        <div id="diff-normal" class="diff-card locked" onclick="selectDifficulty('normal')">
            <b>–ù–û–†–ú–ê–õ–¨–ù–û</b>
            <small id="unlock-normal">–ó–∞–∫—Ä—ã—Ç–æ: –≤—ã–∂–∏–≤–∏—Ç–µ 30 –º–∏–Ω. –Ω–∞ –ª–µ–≥–∫–æ–π</small>
            <span class="reward-tag">–ù–∞–≥—Ä–∞–¥—ã: x1.8 üí∞</span>
            <span class="lock-icon">üîí</span>
        </div>

        <div id="diff-hard" class="diff-card locked" onclick="selectDifficulty('hard')">
            <b>–ê–î</b>
            <small id="unlock-hard">–ó–∞–∫—Ä—ã—Ç–æ: –≤—ã–∂–∏–≤–∏—Ç–µ 30 –º–∏–Ω. –Ω–∞ –Ω–æ—Ä–º.</small>
            <span class="reward-tag">–ù–∞–≥—Ä–∞–¥—ã: x3.5 üí∞</span>
            <span class="lock-icon">üîí</span>
        </div>

        <div class="btn" onclick="startGame()">–í –ë–û–ô!</div>
    </div>
</div>

<div id="ui" style="display:none">
    <div id="exp-bar"><div id="exp-fill"></div></div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div style="display:flex; justify-content:space-between; color:#ffd700; font-weight:bold; margin-top:5px;">
        <span id="gold-ui">üí∞ 0</span>
        <span id="timer-ui" style="color:white">00:00</span>
    </div>
</div>

<canvas id="game-canvas"></canvas>

<script>
/** –î–ê–ù–ù–´–ï –°–û–•–†–ê–ù–ï–ù–ò–Ø **/
let save = JSON.parse(localStorage.getItem('surv_save_v11')) || {
    gold: 0,
    totalTimeEasy: 0,   // —Å—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –ª–µ–≥–∫–æ–π (–≤ —Å–µ–∫)
    totalTimeNormal: 0, // —Å—É–º–º–∞—Ä–Ω–æ–µ –≤—Ä–µ–º—è –Ω–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π
    achDone: [],
    unlocked: ['square']
};

let selectedDiff = 'easy';
let gameActive = false;

const DIFFICULTY_SETTINGS = {
    easy: { hpMult: 1, speedMult: 1, goldMult: 1, reqTime: 0 },
    normal: { hpMult: 2.5, speedMult: 1.3, goldMult: 1.8, reqTime: 1800 }, // 30 –º–∏–Ω
    hard: { hpMult: 6, speedMult: 1.7, goldMult: 3.5, reqTime: 1800 }
};

function updateDiffMenu() {
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–æ—Ä–º–∞–ª—å–Ω–æ–π
    if (save.totalTimeEasy >= DIFFICULTY_SETTINGS.normal.reqTime) {
        document.getElementById('diff-normal').classList.remove('locked');
        document.getElementById('diff-normal').classList.add('unlocked');
        document.getElementById('diff-normal').querySelector('.lock-icon').innerText = '';
        document.getElementById('unlock-normal').innerText = '–í—Ä–∞–≥–∏ —Å—Ç–∞–ª–∏ –æ–ø–∞—Å–Ω–µ–µ.';
    } else {
        let left = Math.ceil((DIFFICULTY_SETTINGS.normal.reqTime - save.totalTimeEasy) / 60);
        document.getElementById('unlock-normal').innerText = `–ù—É–∂–Ω–æ –µ—â–µ ${left} –º–∏–Ω. –Ω–∞ –õ–µ–≥–∫–æ–π`;
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ –∞–¥–∞
    if (save.totalTimeNormal >= DIFFICULTY_SETTINGS.hard.reqTime) {
        document.getElementById('diff-hard').classList.remove('locked');
        document.getElementById('diff-hard').classList.add('unlocked');
        document.getElementById('diff-hard').querySelector('.lock-icon').innerText = '';
        document.getElementById('unlock-hard').innerText = '–ù–∞—Å—Ç–æ—è—â–µ–µ –±–µ–∑—É–º–∏–µ.';
    } else {
        let left = Math.ceil((DIFFICULTY_SETTINGS.hard.reqTime - save.totalTimeNormal) / 60);
        document.getElementById('unlock-hard').innerText = `–ù—É–∂–Ω–æ –µ—â–µ ${left} –º–∏–Ω. –Ω–∞ –ù–æ—Ä–º–∞–ª—å–Ω–æ–π`;
    }
}

function selectDifficulty(id) {
    const card = document.getElementById('diff-' + id);
    if (card.classList.contains('locked')) return;
    
    document.querySelectorAll('.diff-card').forEach(c => c.classList.remove('selected'));
    card.classList.add('selected');
    selectedDiff = id;
}

updateDiffMenu();/** 2. –î–û–°–¢–ò–ñ–ï–ù–ò–Ø –ò –ü–†–û–ì–†–ï–°–° **/
const DIFF_ACHIEVEMENTS = [
    { id: 'diff_pioneer', name: '–ü–µ—Ä–≤–æ–ø—Ä–æ—Ö–æ–¥–µ—Ü', desc: '–û—Ç–∫—Ä—ã—Ç—å –ù–æ—Ä–º–∞–ª—å–Ω—É—é —Å–ª–æ–∂–Ω–æ—Å—Ç—å', reward: 2000, check: () => save.totalTimeEasy >= 1800 },
    { id: 'diff_veteran', name: '–í–µ—Ç–µ—Ä–∞–Ω', desc: '–û—Ç–∫—Ä—ã—Ç—å —Å–ª–æ–∂–Ω–æ—Å—Ç—å –ê–¥', reward: 5000, check: () => save.totalTimeNormal >= 1800 },
    { id: 'diff_god', name: '–î–µ–º–æ–Ω–æ–±–æ—Ä–µ—Ü', desc: '–í—ã–∂–∏—Ç—å 10 –º–∏–Ω—É—Ç –Ω–∞ –ê–¥—É', reward: 10000, check: () => selectedDiff === 'hard' && (Date.now() - startTime)/1000 >= 600 }
];

function checkDiffAchievements() {
    DIFF_ACHIEVEMENTS.forEach(ach => {
        if (!save.achDone.includes(ach.id) && ach.check()) {
            save.achDone.push(ach.id);
            save.gold += ach.reward;
            if(typeof showToast === 'function') showToast(`üèÜ ${ach.name}! +${ach.reward}üí∞`);
        }
    });
}

/** 3. –ò–ì–†–û–í–û–ô –î–í–ò–ñ–ï–ö –° –£–ß–ï–¢–û–ú –°–õ–û–ñ–ù–û–°–¢–ò **/
const canvas = document.getElementById('game-canvas');
const ctx = canvas.getContext('2d');
let player, enemies, crystals, bullets, startTime, weaponTimers;
let persistentGold = save.gold;

function startGame() {
    document.getElementById('diff-menu').style.display = 'none';
    document.getElementById('ui').style.display = 'block';
    gameActive = true;
    startTime = Date.now();

    const base = { hp: 150, dmg: 1, speed: 3.5, magnet: 80 }; // –ë–∞–∑–æ–≤—ã–π –≥–µ—Ä–æ–π
    player = { 
        ...base, x: 0, y: 0, lvl: 1, exp: 0, nextLvl: 100, 
        skills: { gun: 1 }, cd: 1, expMod: 1 
    };
    
    enemies = []; crystals = []; bullets = [];
    weaponTimers = { gun: 0 };
    resize();
    update();
}

function update() {
    if (!gameActive) return;

    let now = Date.now();
    let secondsInRun = Math.floor((now - startTime) / 1000);
    let config = DIFFICULTY_SETTINGS[selectedDiff];

    // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –≤—Ä–µ–º–µ–Ω–∏ –∫–∞–∂–¥—ã–µ 10 —Å–µ–∫—É–Ω–¥
    if (secondsInRun > 0 && secondsInRun % 10 === 0) {
        if (selectedDiff === 'easy') save.totalTimeEasy += 1; // –£—Å–ª–æ–≤–Ω–æ –¥–æ–±–∞–≤–ª—è–µ–º —à–∞–≥
        if (selectedDiff === 'normal') save.totalTimeNormal += 1;
        // –î–ª—è —Ç–æ—á–Ω–æ—Å—Ç–∏ –ª—É—á—à–µ —Å–æ—Ö—Ä–∞–Ω—è—Ç—å –¥–µ–ª—å—Ç—É, –Ω–æ –∑–¥–µ—Å—å —É–ø—Ä–æ—Å—Ç–∏–º:
        save.gold = persistentGold;
        localStorage.setItem('surv_save_v11', JSON.stringify(save));
        checkDiffAchievements();
    }

    // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ (—É–ø—Ä–æ—â–µ–Ω–Ω–æ –∫–ª–∞–≤–∏—à–∏/–¥–∂–æ–π—Å—Ç–∏–∫)
    // ... (–∫–æ–¥ –¥–∂–æ–π—Å—Ç–∏–∫–∞ –∏–∑ –ø—Ä–µ–¥—ã–¥—É—â–∏—Ö —á–∞—Å—Ç–µ–π)

    // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤ —Å –º–Ω–æ–∂–∏—Ç–µ–ª—è–º–∏ —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    if (enemies.length < 50 + (secondsInRun / 5)) {
        let a = Math.random() * Math.PI * 2;
        let dist = 800;
        let hpBase = (60 + secondsInRun * 2) * config.hpMult;
        enemies.push({
            x: player.x + Math.cos(a) * dist,
            y: player.y + Math.sin(a) * dist,
            hp: hpBase,
            maxHp: hpBase,
            speed: (1.5 + (secondsInRun / 100)) * config.speedMult,
            size: 18 + (config.hpMult > 5 ? 5 : 0) // –ù–∞ –∞–¥—É –≤—Ä–∞–≥–∏ —á—É—Ç—å –±–æ–ª—å—à–µ
        });
    }

    // –õ–æ–≥–∏–∫–∞ –æ—Ä—É–∂–∏—è –∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
    enemies.forEach((e, ei) => {
        let dx = player.x - e.x;
        let dy = player.y - e.y;
        let dist = Math.sqrt(dx * dx + dy * dy);
        
        // –î–≤–∏–∂–µ–Ω–∏–µ –∫ –∏–≥—Ä–æ–∫—É
        e.x += (dx / dist) * e.speed;
        e.y += (dy / dist) * e.speed;

        // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
        if (dist < 25) {
            player.hp -= 0.5 * config.hpMult;
            if (player.hp <= 0) endGame();
        }
    });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞
    draw(secondsInRun);
    requestAnimationFrame(update);
}

function draw(elapsed) {
    ctx.clearRect(0, 0, canvas.width, canvas.height);
    const cx = canvas.width / 2, cy = canvas.height / 2;

    // –§–æ–Ω —Å–µ—Ç–∫–∞
    ctx.strokeStyle = '#111';
    for(let i=0; i<canvas.width; i+=50) { ctx.beginPath(); ctx.moveTo(i-((player.x)%50),0); ctx.lineTo(i-((player.x)%50),canvas.height); ctx.stroke(); }

    // –í—Ä–∞–≥–∏
    enemies.forEach(e => {
        ctx.fillStyle = selectedDiff === 'hard' ? '#ff00ff' : '#f44';
        ctx.beginPath();
        ctx.arc(e.x - player.x + cx, e.y - player.y + cy, e.size, 0, Math.PI * 2);
        ctx.fill();
    });

    // –ò–≥—Ä–æ–∫
    ctx.fillStyle = '#00d4ff';
    ctx.fillRect(cx - 15, cy - 15, 30, 30);

    // UI —Ç–µ–∫—Å—Ç
    document.getElementById('timer-ui').innerText = formatTime(elapsed);
    document.getElementById('gold-ui').innerText = `üí∞ ${Math.floor(persistentGold)}`;
    document.getElementById('hp-fill').style.width = (player.hp / 150 * 100) + '%';
}

function formatTime(s) {
    let m = Math.floor(s / 60);
    let rs = s % 60;
    return `${m.toString().padStart(2, '0')}:${rs.toString().padStart(2, '0')}`;
}

function endGame() {
    gameActive = false;
    // –ü—Ä–∏–±–∞–≤–ª—è–µ–º –≤—Ä–µ–º—è –∫ –æ–±—â–µ–º—É —Å—á–µ—Ç—á–∏–∫—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏
    let sessionTime = Math.floor((Date.now() - startTime) / 1000);
    if (selectedDiff === 'easy') save.totalTimeEasy += sessionTime;
    if (selectedDiff === 'normal') save.totalTimeNormal += sessionTime;
    
    save.gold = persistentGold;
    localStorage.setItem('surv_save_v11', JSON.stringify(save));
    alert(`–ò–≥—Ä–∞ –æ–∫–æ–Ω—á–µ–Ω–∞! –í—ã –ø—Ä–æ–¥–µ—Ä–∂–∞–ª–∏—Å—å ${formatTime(sessionTime)}`);
    location.reload();
}

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize);
</script>
</body>
</html>
