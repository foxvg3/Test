<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>MEGA SURVIVOR 2026</title>
    </head>
<body>

    <div id="hud" class="hidden">
        <div class="stats-top">
            <div id="h-lvl">LVL 1</div>
            <div id="h-time">00:00</div>
            <div id="h-gold">0</div>
        </div>
        <div class="bar-container exp-bar"><div id="exp-fill" class="bar-fill"></div></div>
        <div class="bar-container hp-bar"><div id="hp-fill" class="bar-fill"></div></div>
    </div>

    <div id="auth" class="ui-screen">
        <div class="panel">
            <h1 class="glitch">MEGA SURVIVOR</h1>
            <input type="text" id="auth-nick" placeholder="–í–í–ï–î–ò–¢–ï –ù–ò–ö..." maxlength="12">
            <button class="btn" onclick="account.login()">–í–•–û–î</button>
            <div style="margin-top: 15px;">
                <button id="btn-audio" class="btn btn-sec" onclick="audio.toggle()">SOUND: ON</button>
            </div>
        </div>
    </div>

    <div id="lobby" class="ui-screen hidden">
        <div class="header">
            <div id="user-info" onclick="ui.showDetails()">–ò–ì–†–û–ö: ---</div>
            <div id="user-gold" style="color:var(--gold)">üí∞ 0</div>
        </div>
        
        <div class="hero-selection">
            <h3>–í–´–ë–û–† –ì–ï–†–û–Ø</h3>
            <div id="char-grid" class="grid"></div>
        </div>

        <div class="menu-footer">
            <button class="btn" onclick="game.preStart()">–í –ë–û–ô</button>
            <div class="sub-btns">
                <button class="btn btn-sec" onclick="shop.buyChest('small')">–ú–ê–ì–ê–ó–ò–ù</button>
                <button class="btn btn-sec" onclick="ui.showTab('rankings')">–¢–û–ü-100</button>
            </div>
        </div>
    </div>

    <div id="rankings" class="ui-screen hidden">
        <div class="panel full">
            <h2 id="rank-col-name">–†–ï–ô–¢–ò–ù–ì</h2>
            <div class="tabs">
                <button onclick="ui.renderTop('lvl')">LVL</button>
                <button onclick="ui.renderTop('endless')">TIME</button>
                <button onclick="ui.renderTop('boss')">BOSS</button>
            </div>
            <div class="scroll-area">
                <table>
                    <thead><tr><th>#</th><th>–ù–ò–ö</th><th id="th-val">–ó–ù–ê–ß–ï–ù–ò–ï</th></tr></thead>
                    <tbody id="rank-body"></tbody>
                </table>
            </div>
            <button class="btn btn-sec" onclick="ui.showTab('lobby')">–ù–ê–ó–ê–î</button>
        </div>
    </div>

    <canvas id="gameCanvas"></canvas>

    <div id="joy-base" class="hidden">
        <div id="joy-stick"></div>
    </div>

</body>
</html>:root { 
    --primary: #00d4ff; 
    --bg: #050805; 
    --panel: rgba(0, 20, 20, 0.95); 
    --gold: #ffd700; 
    --red: #ff4d4d; 
    --green: #00ff88;
}

* { 
    box-sizing: border-box; 
    -webkit-tap-highlight-color: transparent; 
    outline: none; 
    user-select: none; 
}

body, html { 
    margin: 0; padding: 0; width: 100%; height: 100%; 
    background: var(--bg); color: #fff; 
    font-family: 'Segoe UI', Roboto, Helvetica, Arial, sans-serif; 
    overflow: hidden; touch-action: none;
}

canvas { 
    display: block; width: 100%; height: 100%; 
    position: absolute; inset: 0; z-index: 1; 
}

/* –ò–Ω—Ç–µ—Ä—Ñ–µ–π—Å */
.ui-screen { 
    position: absolute; inset: 0; 
    display: flex; flex-direction: column; align-items: center; justify-content: center; 
    background: radial-gradient(circle at center, #0a1a1a 0%, #050805 100%); 
    z-index: 10; 
}

.hidden { display: none !important; }

.panel { 
    background: var(--panel); padding: 25px; border-radius: 24px; 
    border: 2px solid var(--primary); 
    box-shadow: 0 0 30px rgba(0, 212, 255, 0.15); 
    width: 92%; max-width: 400px; text-align: center; 
}

/* –í–≤–æ–¥ —Ç–µ–∫—Å—Ç–∞ */
input[type="text"] {
    background: #111; border: 1px solid #333; color: #fff; 
    padding: 14px; border-radius: 12px; width: 100%; 
    margin-bottom: 15px; text-align: center; font-size: 16px;
}

/* –ö–Ω–æ–ø–∫–∏ */
.btn { 
    background: var(--primary); color: #000; border: none; 
    padding: 14px; border-radius: 12px; font-weight: bold; 
    cursor: pointer; margin: 6px 0; width: 100%; 
    transition: 0.2s cubic-bezier(0.4, 0, 0.2, 1); 
    font-size: 14px; text-transform: uppercase;
}

.btn:active { transform: scale(0.96); opacity: 0.9; }

.btn-sec { 
    background: transparent; border: 1px solid var(--primary); 
    color: var(--primary); 
}

/* –°–µ—Ç–∫–∞ –≥–µ—Ä–æ–µ–≤ */
#char-grid { 
    display: grid; grid-template-columns: repeat(3, 1fr); 
    gap: 10px; margin: 15px 0; max-height: 240px; overflow-y: auto; 
}

.char-card { 
    background: #0a0f0a; border-radius: 14px; padding: 12px; 
    border: 1px solid #222; cursor: pointer; transition: 0.3s; 
    position: relative;
}

.char-card.selected { 
    border-color: var(--primary); 
    background: rgba(0, 212, 255, 0.1); 
    box-shadow: 0 0 15px rgba(0, 212, 255, 0.2);
}

.char-card.locked { opacity: 0.5; filter: grayscale(1); }

/* –ú–∞–≥–∞–∑–∏–Ω */
.shop-box {
    margin: 15px 0; padding: 12px; 
    background: rgba(255, 215, 0, 0.05); 
    border-radius: 15px; border: 1px dashed var(--gold);
}

/* –¢–∞–±–ª–∏—Ü—ã */
.table-scroll { max-height: 200px; overflow-y: auto; margin: 10px 0; }
.rank-table { width: 100%; border-collapse: collapse; font-size: 12px; }
.rank-table th { color: var(--primary); border-bottom: 2px solid #222; padding: 8px; text-align: left; }
.rank-table td { padding: 8px; border-bottom: 1px solid #111; text-align: left; }

/* HUD */
#hud { 
    position: absolute; top: 15px; left: 15px; right: 15px; 
    pointer-events: none; z-index: 5; 
}

.hud-stats { 
    display: flex; justify-content: space-between; 
    font-size: 14px; font-weight: 900; 
    text-shadow: 2px 2px 4px #000; margin-top: 5px;
}

#hp-fill { background: linear-gradient(90deg, #ff4d4d, #aa0000); }
#exp-fill { background: linear-gradient(90deg, var(--primary), #0088aa); }

/* –î–∂–æ–π—Å—Ç–∏–∫ */
#joy-base { 
    position: absolute; bottom: 60px; left: 60px; 
    width: 110px; height: 110px; background: rgba(255,255,255,0.03); 
    border-radius: 50%; border: 2px solid rgba(255,255,255,0.1); z-index: 5; 
}

#joy-stick { 
    position: absolute; top: 35px; left: 35px; 
    width: 40px; height: 40px; background: var(--primary); 
    border-radius: 50%; box-shadow: 0 0 20px var(--primary); 
}const IS_ADMIN = location.search.includes('?ad123');

// --- –°–ò–°–¢–ï–ú–ê –õ–û–ö–ê–õ–ò–ó–ê–¶–ò–ò ---
const i18n = {
    lang: 'ru',
    data: {
        ru: { play: "–ò–ì–†–ê–¢–¨", top: "–¢–û–ü-100", info: "–ü–†–û–§–ò–õ–¨ (–ö–õ–ò–ö)", lang: "–Ø–ó–´–ö: RU", back: "–ù–ê–ó–ê–î", login: "–í–•–û–î / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø" },
        en: { play: "PLAY", top: "TOP 100", info: "PROFILE (CLICK)", lang: "LANG: EN", back: "BACK", login: "LOGIN / SIGNUP" }
    },
    t(key) { return this.data[this.lang][key] || key; },
    toggle() {
        this.lang = this.lang === 'ru' ? 'en' : 'ru';
        this.updateUI();
    },
    updateUI() {
        document.querySelectorAll('[data-t]').forEach(el => {
            el.innerText = this.t(el.getAttribute('data-t'));
        });
        const btn = document.getElementById('btn-lang');
        if (btn) btn.innerText = this.t('lang');
    }
};

// --- –£–ü–†–ê–í–õ–ï–ù–ò–ï –ê–ö–ö–ê–£–ù–¢–û–ú ---
const account = {
    current: null,

    login() {
        const input = document.getElementById('auth-nick');
        const nick = input.value.trim();
        if (!nick) return alert("–í–≤–µ–¥–∏—Ç–µ –Ω–∏–∫–Ω–µ–π–º!");

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ –ø—Ä–∏ –ø–µ—Ä–≤–æ–º –≤–∑–∞–∏–º–æ–¥–µ–π—Å—Ç–≤–∏–∏ (–¥–ª—è –±—Ä–∞—É–∑–µ—Ä–æ–≤)
        if (typeof audio !== 'undefined') audio.init();

        const saved = localStorage.getItem('mega_save_' + nick);
        if (saved) {
            this.current = JSON.parse(saved);
            // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ –Ω–∞–ª–∏—á–∏–µ –Ω–æ–≤—ã—Ö –ø–æ–ª–µ–π (–º–∏–≥—Ä–∞—Ü–∏—è –¥–∞–Ω–Ω—ã—Ö)
            if (!this.current.fragments) this.current.fragments = {};
            if (!this.current.ranks) this.current.ranks = {};
            if (!this.current.unlocked) this.current.unlocked = ['square'];
        } else {
            this.current = {
                nick: nick,
                gold: 0,
                lvl: 1,
                records: { endless: 0, boss: 0 },
                unlocked: ['square'],
                fragments: { square: 0 },
                ranks: { square: 0 }
            };
            this.save();
        }

        if (IS_ADMIN) document.getElementById('admin-btn').classList.remove('hidden');
        ui.initLobby();
        ui.showTab('lobby');
        i18n.updateUI();
    },

    save() {
        if (!this.current) return;
        localStorage.setItem('mega_save_' + this.current.nick, JSON.stringify(this.current));
        this.updateUI();
    },

    updateUI() {
        if (!this.current) return;
        const goldEl = document.getElementById('l-gold');
        const lvlEl = document.getElementById('p-lvl');
        if (goldEl) goldEl.innerText = Math.floor(this.current.gold);
        if (lvlEl) lvlEl.innerText = this.current.lvl;
    }
};const audio = {
    ctx: null,
    // –ó–∞–≥—Ä—É–∂–∞–µ–º –Ω–∞—Å—Ç—Ä–æ–π–∫—É –∏–∑ localStorage, –ø–æ —É–º–æ–ª—á–∞–Ω–∏—é true
    enabled: localStorage.getItem('mega_audio_enabled') !== 'false',

    init() {
        if (this.ctx) return;
        try {
            this.ctx = new (window.AudioContext || window.webkitAudioContext)();
        } catch (e) {
            console.error("Web Audio API –Ω–µ –ø–æ–¥–¥–µ—Ä–∂–∏–≤–∞–µ—Ç—Å—è");
        }
    },

    // –ü–µ—Ä–µ–∫–ª—é—á–∞—Ç–µ–ª—å –∑–≤—É–∫–∞
    toggle() {
        this.enabled = !this.enabled;
        localStorage.setItem('mega_audio_enabled', this.enabled);
        this.updateBtnUI();
        
        // –†–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–∞ (–≤–∞–∂–Ω–æ –¥–ª—è Chrome/Safari)
        if (this.enabled && this.ctx && this.ctx.state === 'suspended') {
            this.ctx.resume();
        }
    },

    // –í–∏–∑—É–∞–ª—å–Ω–æ–µ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∫–Ω–æ–ø–∫–∏
    updateBtnUI() {
        const btn = document.getElementById('btn-audio');
        if (!btn) return;
        btn.innerText = this.enabled ? "SOUND: ON" : "SOUND: OFF";
        btn.style.borderColor = this.enabled ? "var(--primary)" : "#555";
        btn.style.color = this.enabled ? "var(--primary)" : "#555";
    },

    // –£–Ω–∏–≤–µ—Ä—Å–∞–ª—å–Ω—ã–π –≥–µ–Ω–µ—Ä–∞—Ç–æ—Ä —Ç–æ–Ω–∞ (–æ—Å—Ü–∏–ª–ª—è—Ç–æ—Ä)
    beep(freq, duration, type = 'sine', vol = 0.1) {
        if (!this.ctx || !this.enabled) return;
        
        const osc = this.ctx.createOscillator();
        const gain = this.ctx.createGain();
        
        osc.type = type;
        osc.frequency.setValueAtTime(freq, this.ctx.currentTime);
        
        gain.gain.setValueAtTime(vol, this.ctx.currentTime);
        gain.gain.exponentialRampToValueAtTime(0.01, this.ctx.currentTime + duration);
        
        osc.connect(gain);
        gain.connect(this.ctx.destination);
        
        osc.start();
        osc.stop(this.ctx.currentTime + duration);
    },

    playShoot() {
        // –í—ã—Å—Ç—Ä–µ–ª: –±—ã—Å—Ç—Ä—ã–π —Å–ø–∞–¥ —á–∞—Å—Ç–æ—Ç—ã —Å 800 –¥–æ 100 –ì—Ü
        this.beep(800, 0.1, 'triangle', 0.05);
    },

    playExplosion() {
        // –í–∑—Ä—ã–≤: –Ω–∏–∑–∫–∏–π "—à—É–º–Ω—ã–π" –∑–≤—É–∫
        this.beep(100, 0.3, 'sawtooth', 0.1);
    },

    playLvlUp() {
        // –õ–µ–≤–µ–ª-–∞–ø: –≤–æ—Å—Ö–æ–¥—è—â–µ–µ —Ç—Ä–µ–∑–≤—É—á–∏–µ
        if (!this.enabled) return;
        const now = this.ctx.currentTime;
        [523.25, 659.25, 783.99].forEach((f, i) => {
            setTimeout(() => this.beep(f, 0.4, 'sine', 0.05), i * 150);
        });
    },

    playHurt() {
        // –£—Ä–æ–Ω: —Ä–µ–∑–∫–∏–π –Ω–µ–ø—Ä–∏—è—Ç–Ω—ã–π –∑–≤—É–∫
        this.beep(150, 0.15, 'square', 0.08);
    }
};const shop = {
    // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏—è —Å—É–Ω–¥—É–∫–æ–≤: —Ü–µ–Ω–∞ –∏ –¥–∏–∞–ø–∞–∑–æ–Ω –≤—ã–ø–∞–¥–∞—é—â–∏—Ö —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
    chests: [
        { id: 'small', price: 500, min: 1, max: 3, label: '–û–±—ã—á–Ω—ã–π —Å—É–Ω–¥—É–∫' },
        { id: 'mega', price: 2000, min: 5, max: 12, label: '–ú–µ–≥–∞ —Å—É–Ω–¥—É–∫' }
    ],

    buyChest(chestId) {
        const config = this.chests.find(x => x.id === chestId);
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –±–∞–ª–∞–Ω—Å–∞
        if (account.current.gold < config.price) {
            alert("–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ –∑–æ–ª–æ—Ç–∞! –°—Ä–∞–∂–∞–π—Ç–µ—Å—å —É—Å–µ—Ä–¥–Ω–µ–µ.");
            return;
        }

        // –°–ø–∏—Å–∞–Ω–∏–µ —Å—Ä–µ–¥—Å—Ç–≤
        account.current.gold -= config.price;
        
        // –û–ø—Ä–µ–¥–µ–ª–µ–Ω–∏–µ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
        const count = Math.floor(Math.random() * (config.max - config.min + 1)) + config.min;
        
        // –°–ø–∏—Å–æ–∫ –≥–µ—Ä–æ–µ–≤ –¥–ª—è –≤—ã–ø–∞–¥–µ–Ω–∏—è (–≤—Å–µ –∫—Ä–æ–º–µ —Å—Ç–∞—Ä—Ç–æ–≤–æ–≥–æ Square)
        const heroesPool = ['circle', 'triangle', 'diamond', 'hex', 'star'];
        const randomHero = heroesPool[Math.floor(Math.random() * heroesPool.length)];
        
        // –î–æ–±–∞–≤–ª–µ–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –≤ –∞–∫–∫–∞—É–Ω—Ç
        if (!account.current.fragments) account.current.fragments = {};
        account.current.fragments[randomHero] = (account.current.fragments[randomHero] || 0) + count;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫—É (–Ω—É–∂–Ω–æ 10 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤)
        let msg = `–í —Å—É–Ω–¥—É–∫–µ –Ω–∞–π–¥–µ–Ω–æ: ${count} —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ ${randomHero.toUpperCase()}`;
        
        if (account.current.fragments[randomHero] >= 10 && !account.current.unlocked.includes(randomHero)) {
            account.current.unlocked.push(randomHero);
            msg += `\n\nüéâ –ü–û–ó–î–†–ê–í–õ–Ø–ï–ú! –ì–µ—Ä–æ–π ${randomHero.toUpperCase()} —Ç–µ–ø–µ—Ä—å –¥–æ—Å—Ç—É–ø–µ–Ω!`;
            if (typeof audio !== 'undefined') audio.playLvlUp();
        }

        alert(msg);
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏ –æ–±–Ω–æ–≤–ª–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        account.save();
        ui.initLobby();
    }
};

// –§—É–Ω–∫—Ü–∏—è —É—Å–∏–ª–µ–Ω–∏—è —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ –∑–∞ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã (Rank Up)
ui.upgradeHero = function(heroId) {
    const currentRank = account.current.ranks?.[heroId] || 0;
    const cost = (currentRank + 1) * 10; // –ö–∞–∂–¥—ã–π —Ä–∞–Ω–≥ —Å—Ç–æ–∏—Ç –Ω–∞ 10 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –±–æ–ª—å—à–µ
    const availableFrags = account.current.fragments?.[heroId] || 0;

    if (availableFrags >= cost) {
        // –°–ø–∏—Å–∞–Ω–∏–µ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤
        account.current.fragments[heroId] -= cost;
        
        // –ü–æ–≤—ã—à–µ–Ω–∏–µ —Ä–∞–Ω–≥–∞
        if (!account.current.ranks) account.current.ranks = {};
        account.current.ranks[heroId] = currentRank + 1;
        
        alert(`–ì–µ—Ä–æ–π ${heroId.toUpperCase()} —É—Å–∏–ª–µ–Ω –¥–æ —Ä–∞–Ω–≥–∞ ${currentRank + 1}!\n–ë–æ–Ω—É—Å—ã —Ö–∞—Ä–∞–∫—Ç–µ—Ä–∏—Å—Ç–∏–∫ —É–≤–µ–ª–∏—á–µ–Ω—ã.`);
        
        if (typeof audio !== 'undefined') audio.playLvlUp();
        
        account.save();
        ui.initLobby();
    } else {
        alert(`–ù–µ–¥–æ—Å—Ç–∞—Ç–æ—á–Ω–æ —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤! –î–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —Ä–∞–Ω–≥–∞ –Ω—É–∂–Ω–æ: ${cost}`);
    }
};const ui = {
    selectedHero: 'square',

    // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ –º–µ–∂–¥—É —ç–∫—Ä–∞–Ω–∞–º–∏
    showTab(id) {
        document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
        const target = document.getElementById(id);
        if (target) target.classList.remove('hidden');
        
        if (id === 'lobby') account.updateUI();
        if (id === 'rankings') this.renderTop('lvl');
    },

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Å–µ—Ç–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π
    initLobby() {
        const grid = document.getElementById('char-grid');
        if (!grid) return;
        grid.innerHTML = '';
        
        const heroes = ['square', 'circle', 'triangle', 'diamond', 'hex', 'star'];
        
        heroes.forEach(h => {
            const unlocked = account.current.unlocked.includes(h);
            const frags = account.current.fragments?.[h] || 0;
            const rank = account.current.ranks?.[h] || 0;
            const upCost = (rank + 1) * 10;
            
            const card = document.createElement('div');
            card.className = `char-card ${this.selectedHero === h ? 'selected' : ''} ${!unlocked ? 'locked' : ''}`;
            
            card.innerHTML = `
                ${rank > 0 ? `<div style="position:absolute;top:4px;right:6px;color:var(--gold);font-size:10px;font-weight:bold;">‚òÖ${rank}</div>` : ''}
                <div style="font-size:28px; margin: 5px 0;">${this.getIcon(h)}</div>
                <div style="font-size:10px; font-weight:bold; color:${unlocked ? 'var(--primary)' : '#666'}">${h.toUpperCase()}</div>
                <div style="font-size:9px; margin-top:4px;">${unlocked ? 'RANK ' + rank : frags + '/10'}</div>
                ${unlocked && frags >= upCost ? 
                    `<button onclick="event.stopPropagation(); ui.upgradeHero('${h}')" style="background:var(--gold); border:none; border-radius:4px; font-size:8px; cursor:pointer; margin-top:5px; padding:2px 5px; font-weight:bold;">UPGRADE (${upCost})</button>` : 
                    ''}
            `;
            
            card.onclick = () => { 
                if (unlocked) { 
                    this.selectedHero = h; 
                    this.initLobby(); 
                } else {
                    alert(`–ù—É–∂–Ω–æ –µ—â–µ ${10 - frags} —Ñ—Ä–∞–≥–º–µ–Ω—Ç–æ–≤ –¥–ª—è —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ ${h.toUpperCase()}`);
                }
            };
            grid.appendChild(card);
        });
    },

    // –ü–æ–ª—É—á–µ–Ω–∏–µ –≤—Å–µ—Ö —Ä–µ–∞–ª—å–Ω—ã—Ö –∏–≥—Ä–æ–∫–æ–≤ –∏–∑ –ø–∞–º—è—Ç–∏ –±—Ä–∞—É–∑–µ—Ä–∞
    renderTop(type) {
        const body = document.getElementById('rank-body');
        const title = document.getElementById('rank-col-name');
        if (!body || !title) return;

        title.innerText = type === 'endless' ? 'TIME (SEC)' : type.toUpperCase();
        body.innerHTML = '';

        let players = [];
        for (let i = 0; i < localStorage.length; i++) {
            const key = localStorage.key(i);
            if (key.startsWith('mega_save_')) {
                try {
                    const data = JSON.parse(localStorage.getItem(key));
                    players.push({
                        nick: data.nick,
                        lvl: data.lvl || 1,
                        time: data.records?.endless || 0,
                        boss: data.records?.boss || 0
                    });
                } catch(e) { console.error("Error parsing save:", key); }
            }
        }

        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É —Ç–∏–ø—É
        const sortKey = type === 'endless' ? 'time' : (type === 'boss' ? 'boss' : 'lvl');
        players.sort((a, b) => b[sortKey] - a[sortKey]);

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –¢–û–ü-100
        players.slice(0, 100).forEach((p, i) => {
            const isMe = p.nick === account.current.nick;
            const val = type === 'endless' ? p.time + 's' : p[sortKey];
            
            const row = document.createElement('tr');
            if (isMe) row.style.cssText = 'background:rgba(0,212,255,0.15); color:var(--primary); font-weight:bold;';
            
            row.innerHTML = `
                <td>${i + 1}</td>
                <td>${p.nick} ${isMe ? '(YOU)' : ''}</td>
                <td>${val}</td>
            `;
            body.appendChild(row);
        });
    },

    getIcon(id) {
        const icons = { square: '‚óÜ', circle: '‚óè', triangle: '‚ñ≤', diamond: '‚óà', hex: '‚¨¢', star: '‚òÖ' };
        return icons[id] || '‚ñ†';
    },

    showDetails() {
        alert(`PLAYER: ${account.current.nick}\nLVL: ${account.current.lvl}\nGOLD: ${Math.floor(account.current.gold)}\nBOSS KILLS: ${account.current.records.boss}`);
    }
};// –û—Å–Ω–æ–≤–Ω—ã–µ –Ω–∞—Å—Ç—Ä–æ–π–∫–∏ –∏–≥—Ä–æ–≤–æ–≥–æ –ø—Ä–æ—Ü–µ—Å—Å–∞
const game = {
    active: false,
    paused: false,
    ctx: null,
    width: 0,
    height: 0,
    time: 0,
    shootTimer: 0,
    
    // –°—É—â–Ω–æ—Å—Ç–∏
    player: {
        x: 0, y: 0, 
        hp: 100, maxHp: 100, 
        exp: 0, next: 100, lvl: 1, 
        iframe: 0, // –ö–∞–¥—Ä—ã –Ω–µ—É—è–∑–≤–∏–º–æ—Å—Ç–∏
        damage: 10, 
        fireRate: 30, 
        magnet: 60, 
        speed: 4 
    },
    entities: {
        enemies: [],
        bullets: [],
        items: []
    },
    
    // –í–≤–æ–¥ –¥–∞–Ω–Ω—ã—Ö
    input: {
        dx: 0, dy: 0,
        active: false
    },

    // –ú–µ—Ç–æ–¥ –ø–æ–¥–≥–æ—Ç–æ–≤–∫–∏ –ø–µ—Ä–µ–¥ —Å—Ç–∞—Ä—Ç–æ–º
    preStart() {
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('joy-base').classList.remove('hidden');
        
        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–≤—É–∫–∞ (–≤–∞–∂–Ω–æ –¥–µ–ª–∞—Ç—å —á–µ—Ä–µ–∑ –∂–µ—Å—Ç –ø–æ–ª—å–∑–æ–≤–∞—Ç–µ–ª—è)
        if (audio.ctx && audio.ctx.state === 'suspended') {
            audio.ctx.resume();
        }
        
        this.start();
    },

    // –ó–∞–ø—É—Å–∫ –∏–≥—Ä–æ–≤–æ–≥–æ —Ü–∏–∫–ª–∞
    start() {
        const cvs = document.getElementById('gameCanvas');
        this.ctx = cvs.getContext('2d');
        
        // –ê–¥–∞–ø—Ç–∞—Ü–∏—è –ø–æ–¥ —Ä–∞–∑–º–µ—Ä –æ–∫–Ω–∞
        this.width = cvs.width = window.innerWidth;
        this.height = cvs.height = window.innerHeight;
        
        // –ü—Ä–∏–º–µ–Ω—è–µ–º –±–æ–Ω—É—Å—ã –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–µ—Ä–æ—è –∏ –µ–≥–æ —Ä–∞–Ω–≥–∞
        const heroId = ui.selectedHero;
        const rank = account.current.ranks?.[heroId] || 0;
        
        // –°–±—Ä–æ—Å —Å–æ—Å—Ç–æ—è–Ω–∏—è –∏–≥—Ä–æ–∫–∞
        this.player.x = 0;
        this.player.y = 0;
        this.player.exp = 0;
        this.player.lvl = 1;
        this.player.next = 100;
        this.player.iframe = 0;
        
        // –£—Å–∏–ª–µ–Ω–∏–µ —Å—Ç–∞—Ç–æ–≤ –æ—Ç —Ä–∞–Ω–≥–∞
        this.player.maxHp = 100 + (rank * 15);
        this.player.hp = this.player.maxHp;
        this.player.damage = 10 + (rank * 3);
        this.player.speed = 4 + (rank * 0.2);
        this.player.fireRate = 30; // –ë—É–¥–µ—Ç —É–ª—É—á—à–∞—Ç—å—Å—è –∫–∞—Ä—Ç–∞–º–∏
        this.player.magnet = 60;   // –ë—É–¥–µ—Ç —É–ª—É—á—à–∞—Ç—å—Å—è –∫–∞—Ä—Ç–∞–º–∏

        this.entities = { enemies: [], bullets: [], items: [] };
        this.boss = null;
        this.active = true;
        this.paused = false;
        this.time = 0;
        
        this.initJoy();
        requestAnimationFrame((t) => this.loop(t));
    },

    // –õ–æ–≥–∏–∫–∞ –≤–∏—Ä—Ç—É–∞–ª—å–Ω–æ–≥–æ –¥–∂–æ–π—Å—Ç–∏–∫–∞
    initJoy() {
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');
        
        const handleMove = (e) => {
            if (!this.active) return;
            const t = e.touches ? e.touches[0] : e;
            const rect = base.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const dist = Math.hypot(t.clientX - centerX, t.clientY - centerY);
            const angle = Math.atan2(t.clientY - centerY, t.clientX - centerX);
            
            const maxMove = rect.width / 2;
            const moveDist = Math.min(dist, maxMove);
            
            this.input.dx = Math.cos(angle) * (moveDist / maxMove);
            this.input.dy = Math.sin(angle) * (moveDist / maxMove);
            this.input.active = dist > 5;
            
            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ —Å—Ç–∏–∫–∞
            const visualDist = moveDist;
            stick.style.transform = `translate(${Math.cos(angle) * visualDist}px, ${Math.sin(angle) * visualDist}px)`;
        };

        const handleEnd = () => {
            this.input.active = false;
            this.input.dx = 0;
            this.input.dy = 0;
            stick.style.transform = 'translate(0,0)';
        };

        base.addEventListener('touchstart', (e) => { e.preventDefault(); handleMove(e); }, {passive: false});
        base.addEventListener('touchmove', (e) => { e.preventDefault(); handleMove(e); }, {passive: false});
        window.addEventListener('touchend', handleEnd);
        
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—ã—à–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –ü–ö
        base.addEventListener('mousedown', (e) => {
            const moveHandler = (me) => handleMove(me);
            const upHandler = () => {
                window.removeEventListener('mousemove', moveHandler);
                window.removeEventListener('mouseup', upHandler);
                handleEnd();
            };
            window.addEventListener('mousemove', moveHandler);
            window.addEventListener('mouseup', upHandler);
            handleMove(e);
        });
    }
};Object.assign(game, {
    // –û—Å–Ω–æ–≤–Ω–æ–π –º–µ—Ç–æ–¥ —Å–æ–∑–¥–∞–Ω–∏—è –ø—Ä–æ—Ç–∏–≤–Ω–∏–∫–æ–≤
    spawnEnemy() {
        if (this.boss) return; // –ù–µ —Å–ø–∞–≤–Ω–∏–º –æ–±—ã—á–Ω—ã—Ö –≤—Ä–∞–≥–æ–≤ –≤–æ –≤—Ä–µ–º—è –±–∏—Ç–≤—ã —Å –±–æ—Å—Å–æ–º

        const angle = Math.random() * Math.PI * 2;
        const dist = 600; // –°–ø–∞–≤–Ω –∑–∞ –ø—Ä–µ–¥–µ–ª–∞–º–∏ –≤–∏–¥–∏–º–æ—Å—Ç–∏
        const x = this.player.x + Math.cos(angle) * dist;
        const y = this.player.y + Math.sin(angle) * dist;
        
        const seconds = Math.floor(this.time / 60);
        let type = 'normal';
        
        // –®–∞–Ω—Å –ø–æ—è–≤–ª–µ–Ω–∏—è –æ—Å–æ–±—ã—Ö –≤—Ä–∞–≥–æ–≤ —Ä–∞—Å—Ç–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º
        const roll = Math.random();
        if (seconds > 30 && roll < 0.20) type = 'fast';
        if (seconds > 90 && roll < 0.15) type = 'tank';
        if (seconds > 180 && roll < 0.10) type = 'shooter';

        // –ö–æ–Ω—Ñ–∏–≥—É—Ä–∞—Ü–∏–∏ —Ç–∏–ø–æ–≤ –≤—Ä–∞–≥–æ–≤
        const enemyData = {
            normal: { 
                hp: 30, speed: 2, color: '#ff4d4d', size: 15, exp: 20, 
                desc: '–û–±—ã—á–Ω—ã–π –≤—Ä–∞–≥' 
            },
            fast: { 
                hp: 15, speed: 3.8, color: '#ffff00', size: 10, exp: 35, 
                desc: '–ë—ã—Å—Ç—Ä—ã–π, –Ω–æ —Ö—Ä—É–ø–∫–∏–π' 
            },
            tank: { 
                hp: 200, speed: 1.2, color: '#8800ff', size: 28, exp: 120, 
                desc: '–ú–µ–¥–ª–µ–Ω–Ω—ã–π –≥–∏–≥–∞–Ω—Ç' 
            },
            shooter: { 
                hp: 50, speed: 1.8, color: '#00ff00', size: 18, exp: 60, 
                lastShot: 0, 
                desc: '–°—Ç—Ä–µ–ª—è–µ—Ç –≤ –∏–≥—Ä–æ–∫–∞' 
            }
        };

        const cfg = enemyData[type];
        
        this.entities.enemies.push({
            x: x,
            y: y,
            type: type,
            hp: cfg.hp * (1 + seconds * 0.01), // –ü–æ—Å—Ç–µ–ø–µ–Ω–Ω–æ–µ —É—Å–∏–ª–µ–Ω–∏–µ HP –≤—Å–µ—Ö –≤—Ä–∞–≥–æ–≤
            maxHp: cfg.hp,
            speed: cfg.speed,
            color: cfg.color,
            size: cfg.size,
            exp: cfg.exp,
            lastShot: 0
        });
    },

    // –õ–æ–≥–∏–∫–∞ –ø–æ–≤–µ–¥–µ–Ω–∏—è —Å—Ç—Ä–µ–ª–∫–æ–≤
    handleEnemyAI(e) {
        const dist = Math.hypot(this.player.x - e.x, this.player.y - e.y);
        const ang = Math.atan2(this.player.y - e.y, this.player.x - e.x);

        if (e.type === 'shooter' && dist < 350) {
            // –°—Ç—Ä–µ–ª–æ–∫ –¥–µ—Ä–∂–∏—Ç –¥–∏—Å—Ç–∞–Ω—Ü–∏—é
            if (dist < 250) {
                e.x -= Math.cos(ang) * e.speed;
                e.y -= Math.sin(ang) * e.speed;
            }
            
            // –õ–æ–≥–∏–∫–∞ —Å—Ç—Ä–µ–ª—å–±—ã –≤—Ä–∞–≥–∞
            if (this.time - e.lastShot > 100) {
                this.entities.bullets.push({
                    x: e.x, y: e.y,
                    vx: Math.cos(ang) * 5,
                    vy: Math.sin(ang) * 5,
                    life: 100,
                    enemy: true, // –§–ª–∞–≥ –≤—Ä–∞–∂–µ—Å–∫–æ–π –ø—É–ª–∏
                    color: '#ff0000'
                });
                e.lastShot = this.time;
            }
        } else {
            // –û–±—ã—á–Ω–æ–µ –ø—Ä–µ—Å–ª–µ–¥–æ–≤–∞–Ω–∏–µ
            e.x += Math.cos(ang) * e.speed;
            e.y += Math.sin(ang) * e.speed;
        }
    }
});Object.assign(game, {
    boss: null,

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π –ø–æ—è–≤–ª–µ–Ω–∏—è –±–æ—Å—Å–∞
    checkBossSpawn() {
        const sec = Math.floor(this.time / 60);
        // –ü–æ—è–≤–ª–µ–Ω–∏–µ –∫–∞–∂–¥—ã–µ 300 —Å–µ–∫—É–Ω–¥ (5 –º–∏–Ω—É—Ç)
        if (sec > 0 && sec % 300 === 0 && !this.boss) {
            this.spawnBoss();
        }
    },

    spawnBoss() {
        const seconds = Math.floor(this.time / 60);
        const difficultyMultiplier = 1 + (seconds / 600);
        
        this.boss = {
            x: this.player.x,
            y: this.player.y - 500,
            hp: 5000 * difficultyMultiplier,
            maxHp: 5000 * difficultyMultiplier,
            size: 70,
            color: '#ff0055',
            lastSpecialAttack: 0,
            phase: 1
        };

        // –û—á–∏—â–∞–µ–º —ç–∫—Ä–∞–Ω –æ—Ç –º–µ–ª–∫–∏—Ö –≤—Ä–∞–≥–æ–≤ –¥–ª—è —á–µ—Å—Ç–Ω–æ–π –¥—É—ç–ª–∏
        this.entities.enemies = [];
        if (typeof audio !== 'undefined') audio.playLvlUp(); // –°–∏–≥–Ω–∞–ª –ø–æ—è–≤–ª–µ–Ω–∏—è
    },

    updateBoss() {
        if (!this.boss) return;
        const b = this.boss;
        const dist = Math.hypot(this.player.x - b.x, this.player.y - b.y);
        const ang = Math.atan2(this.player.y - b.y, this.player.x - b.x);

        // –î–≤–∏–∂–µ–Ω–∏–µ –±–æ—Å—Å–∞ (–¥–µ—Ä–∂–∏—Ç—Å—è –Ω–∞ —Å—Ä–µ–¥–Ω–µ–º —Ä–∞—Å—Å—Ç–æ—è–Ω–∏–∏)
        if (dist > 200) {
            b.x += Math.cos(ang) * 1.5;
            b.y += Math.sin(ang) * 1.5;
        }

        // –§–∞–∑–∞ –∞—Ç–∞–∫ –±–æ—Å—Å–∞
        if (this.time % 180 === 0) { // –ö–∞–∂–¥—ã–µ 3 —Å–µ–∫—É–Ω–¥—ã
            const attackType = Math.random();
            
            if (attackType < 0.6) {
                // –ê—Ç–∞–∫–∞ 1: –°–ø–∏—Ä–∞–ª—å–Ω—ã–π –æ–±—Å—Ç—Ä–µ–ª
                for (let i = 0; i < 12; i++) {
                    const shotAng = (Math.PI * 2 / 12) * i + (this.time * 0.1);
                    this.entities.bullets.push({
                        x: b.x, y: b.y,
                        vx: Math.cos(shotAng) * 4,
                        vy: Math.sin(shotAng) * 4,
                        life: 200,
                        enemy: true,
                        color: '#ff0055'
                    });
                }
            } else {
                // –ê—Ç–∞–∫–∞ 2: –ü—Ä–∏–∑—ã–≤ –±—ã—Å—Ç—Ä—ã—Ö –º–∏–Ω—å–æ–Ω–æ–≤-—Å–º–µ—Ä—Ç–Ω–∏–∫–æ–≤
                for (let i = 0; i < 3; i++) {
                    const spawnAng = Math.random() * Math.PI * 2;
                    this.entities.enemies.push({
                        x: b.x + Math.cos(spawnAng) * 100,
                        y: b.y + Math.sin(spawnAng) * 100,
                        type: 'fast',
                        hp: 10, speed: 5, color: '#ff0055', size: 8, exp: 0
                    });
                }
            }
        }

        // –ö–æ–Ω—Ç–∞–∫—Ç–Ω—ã–π —É—Ä–æ–Ω –æ—Ç –±–æ—Å—Å–∞
        if (dist < b.size + 15 && this.player.iframe <= 0) {
            this.player.hp -= 25;
            this.player.iframe = 60;
            if (typeof audio !== 'undefined') audio.playHurt();
        }
    },

    drawBossHUD() {
        if (!this.boss) return;
        const c = this.ctx;
        const b = this.boss;
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø–æ–ª–æ—Å–∫–∏ –∑–¥–æ—Ä–æ–≤—å—è –±–æ—Å—Å–∞ –≤–≤–µ—Ä—Ö—É —ç–∫—Ä–∞–Ω–∞
        const margin = 40;
        const w = this.width - margin * 2;
        const h = 12;
        
        c.fillStyle = 'rgba(0,0,0,0.7)';
        c.fillRect(margin, 40, w, h);
        
        const hpWidth = w * (b.hp / b.maxHp);
        const grad = c.createLinearGradient(margin, 0, margin + w, 0);
        grad.addColorStop(0, '#ff0055');
        grad.addColorStop(1, '#880022');
        
        c.fillStyle = grad;
        c.fillRect(margin, 40, hpWidth, h);
        
        c.strokeStyle = '#fff';
        c.lineWidth = 1;
        c.strokeRect(margin, 40, w, h);
        
        c.fillStyle = '#fff';
        c.font = 'bold 10px Verdana';
        c.textAlign = 'center';
        c.fillText("ANCIENT GUARDIAN", this.width / 2, 35);
        c.textAlign = 'left';
    }
});const SKILLS = [
    { id: 'fire_rate', name: '–°–ö–û–†–û–°–¢–†–ï–õ–¨–ù–û–°–¢–¨', desc: '-15% –≤—Ä–µ–º—è –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏', icon: 'üî´' },
    { id: 'damage', name: '–£–†–û–ù', desc: '+20% –∫ —Å–∏–ª–µ –∞—Ç–∞–∫–∏', icon: '‚öîÔ∏è' },
    { id: 'speed', name: '–°–ö–û–†–û–°–¢–¨', desc: '+10% –∫ –¥–≤–∏–∂–µ–Ω–∏—é', icon: 'üèÉ' },
    { id: 'hp_max', name: '–ó–î–û–†–û–í–¨–ï', desc: '+25 –∫ –º–∞–∫—Å. HP', icon: '‚ù§Ô∏è' },
    { id: 'magnet', name: '–ú–ê–ì–ù–ò–¢', desc: '+40% —Ä–∞–¥–∏—É—Å —Å–±–æ—Ä–∞', icon: 'üß≤' },
    { id: 'regen', name: '–†–ï–ì–ï–ù–ï–†–ê–¶–ò–Ø', desc: '–í–æ—Å—Å—Ç–∞–Ω–æ–≤–ª–µ–Ω–∏–µ 1 HP/—Å–µ–∫', icon: 'üß™' }
];

Object.assign(game, {
    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –Ω–∞–±–æ—Ä–µ –Ω—É–∂–Ω–æ–≥–æ –∫–æ–ª–∏—á–µ—Å—Ç–≤–∞ EXP
    levelUp() {
        this.paused = true;
        this.player.lvl++;
        this.player.exp = 0;
        this.player.next *= 1.25; // –£–≤–µ–ª–∏—á–µ–Ω–∏–µ –ø–æ—Ä–æ–≥–∞ –æ–ø—ã—Ç–∞ –¥–ª—è —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è

        if (typeof audio !== 'undefined') audio.playLvlUp();

        // –í—ã–±–æ—Ä 3-—Ö —Å–ª—É—á–∞–π–Ω—ã—Ö —É–Ω–∏–∫–∞–ª—å–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤
        const shuffled = [...SKILLS].sort(() => 0.5 - Math.random());
        const choices = shuffled.slice(0, 3);
        
        this.showSkillDialog(choices);
    },

    showSkillDialog(cards) {
        const overlay = document.createElement('div');
        overlay.id = 'lvl-up-overlay';
        overlay.className = 'ui-screen';
        overlay.style.background = 'rgba(0,0,0,0.85)';
        overlay.style.zIndex = '100';

        const panel = document.createElement('div');
        panel.className = 'panel';
        panel.innerHTML = `<h2 style="color:var(--primary); margin-top:0;">LEVEL UP!</h2>`;

        cards.forEach(skill => {
            const btn = document.createElement('button');
            btn.className = 'btn btn-sec';
            btn.style.textAlign = 'left';
            btn.style.padding = '15px';
            btn.style.height = 'auto';
            btn.style.marginBottom = '10px';
            
            btn.innerHTML = `
                <div style="display:flex; align-items:center;">
                    <span style="font-size:24px; margin-right:15px;">${skill.icon}</span>
                    <div>
                        <div style="font-weight:bold; color:var(--primary);">${skill.name}</div>
                        <div style="font-size:10px; opacity:0.8;">${skill.desc}</div>
                    </div>
                </div>
            `;
            
            btn.onclick = () => {
                this.applySkill(skill.id);
                overlay.remove();
                this.paused = false;
            };
            panel.appendChild(btn);
        });

        overlay.appendChild(panel);
        document.body.appendChild(overlay);
    },

    applySkill(id) {
        const p = this.player;
        switch(id) {
            case 'fire_rate': p.fireRate *= 0.85; break;
            case 'damage': p.damage *= 1.2; break;
            case 'speed': p.speed *= 1.1; break;
            case 'hp_max': 
                p.maxHp += 25; 
                p.hp += 25; 
                break;
            case 'magnet': p.magnet *= 1.4; break;
            case 'regen': 
                if (!p.regen) p.regen = 0;
                p.regen += 1;
                break;
        }
        // –û–±–Ω–æ–≤–ª—è–µ–º —Å—Ç–∞—Ç–∏—Å—Ç–∏–∫—É –∞–∫–∫–∞—É–Ω—Ç–∞ (–æ–±—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∏–≥—Ä–æ–∫–∞)
        if (p.lvl > account.current.lvl) {
            account.current.lvl = p.lvl;
            account.save();
        }
    }
});Object.assign(game, {
    update() {
        if (!this.active || this.paused) return;

        // 1. –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞
        if (this.input.active) {
            this.player.x += this.input.dx * this.player.speed;
            this.player.y += this.input.dy * this.player.speed;
        }

        // 2. –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (—Ä–∞–∑ –≤ —Å–µ–∫—É–Ω–¥—É / 60 –∫–∞–¥—Ä–æ–≤)
        if (this.player.regen && this.time % 60 === 0) {
            this.player.hp = Math.min(this.player.maxHp, this.player.hp + this.player.regen);
        }

        // 3. –ê–≤—Ç–æ–º–∞—Ç–∏—á–µ—Å–∫–∞—è —Å—Ç—Ä–µ–ª—å–±–∞ –∏–≥—Ä–æ–∫–∞
        this.shootTimer++;
        if (this.shootTimer >= this.player.fireRate) {
            const target = this.getNearestEnemy();
            if (target) {
                const ang = Math.atan2(target.y - this.player.y, target.x - this.player.x);
                this.entities.bullets.push({
                    x: this.player.x, y: this.player.y,
                    vx: Math.cos(ang) * 9, vy: Math.sin(ang) * 9,
                    life: 70, enemy: false, color: '#fff'
                });
                this.shootTimer = 0;
                if (typeof audio !== 'undefined') audio.playShoot();
            }
        }

        // 4. –õ–æ–≥–∏–∫–∞ –ø—É–ª—å (–ò–≥—Ä–æ–∫ + –í—Ä–∞–≥–∏)
        this.entities.bullets.forEach((b, bi) => {
            b.x += b.vx; b.y += b.vy; b.life--;

            if (b.enemy) {
                // –ü—É–ª—è –≤—Ä–∞–≥–∞ –ø–æ–ø–∞–ª–∞ –≤ –∏–≥—Ä–æ–∫–∞
                const dist = Math.hypot(b.x - this.player.x, b.y - this.player.y);
                if (dist < 20 && this.player.iframe <= 0) {
                    this.player.hp -= 12;
                    this.player.iframe = 30;
                    b.life = 0;
                    if (typeof audio !== 'undefined') audio.playHurt();
                }
            } else {
                // –ü—É–ª—è –∏–≥—Ä–æ–∫–∞ –ø–æ–ø–∞–ª–∞ –≤–æ –≤—Ä–∞–≥–∞ –∏–ª–∏ –±–æ—Å—Å–∞
                this.entities.enemies.forEach((e, ei) => {
                    if (Math.hypot(b.x - e.x, b.y - e.y) < e.size + 5) {
                        e.hp -= this.player.damage;
                        b.life = 0;
                        if (e.hp <= 0) {
                            this.entities.items.push({ x: e.x, y: e.y, exp: e.exp });
                            this.entities.enemies.splice(ei, 1);
                            account.current.gold += 1; 
                        }
                    }
                });
                // –ü–æ–ø–∞–¥–∞–Ω–∏–µ –≤ –±–æ—Å—Å–∞
                if (this.boss && Math.hypot(b.x - this.boss.x, b.y - this.boss.y) < this.boss.size) {
                    this.boss.hp -= this.player.damage;
                    b.life = 0;
                    if (this.boss.hp <= 0) {
                        this.onBossDefeat();
                    }
                }
            }
            if (b.life <= 0) this.entities.bullets.splice(bi, 1);
        });

        // 5. –ú–∞–≥–Ω–∏—Ç –∏ —Å–±–æ—Ä –æ–ø—ã—Ç–∞
        this.entities.items.forEach((it, i) => {
            const d = Math.hypot(it.x - this.player.x, it.y - this.player.y);
            if (d < this.player.magnet) {
                it.x += (this.player.x - it.x) * 0.2;
                it.y += (this.player.y - it.y) * 0.2;
            }
            if (d < 20) {
                this.player.exp += it.exp;
                if (this.player.exp >= this.player.next) this.levelUp();
                this.entities.items.splice(i, 1);
            }
        });

        // 6. –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –∏ —Å–ø–∞–≤–Ω
        if (this.time % 40 === 0) this.spawnEnemy();
        this.entities.enemies.forEach(e => {
            this.handleEnemyAI(e);
            // –£—Ä–æ–Ω –æ—Ç –∫–æ–Ω—Ç–∞–∫—Ç–∞ —Å –≤—Ä–∞–≥–æ–º
            if (Math.hypot(e.x - this.player.x, e.y - this.player.y) < e.size + 10 && this.player.iframe <= 0) {
                this.player.hp -= 15;
                this.player.iframe = 45;
                if (typeof audio !== 'undefined') audio.playHurt();
            }
        });

        // 7. –ë–æ—Å—Å –∏ –°–º–µ—Ä—Ç—å
        this.checkBossSpawn();
        if (this.boss) this.updateBoss();
        if (this.player.iframe > 0) this.player.iframe--;
        if (this.player.hp <= 0) this.gameOver();

        this.time++;
        this.updateHUD();
    },

    getNearestEnemy() {
        let min = 600, res = null;
        const targets = this.boss ? [this.boss, ...this.entities.enemies] : this.entities.enemies;
        targets.forEach(e => {
            const d = Math.hypot(e.x - this.player.x, e.y - this.player.y);
            if (d < min) { min = d; res = e; }
        });
        return res;
    }
});Object.assign(game, {
    render() {
        const c = this.ctx;
        if (!c) return;

        // 1. –û—á–∏—Å—Ç–∫–∞ —ç–∫—Ä–∞–Ω–∞ –∏ —Ñ–æ–Ω
        c.fillStyle = '#050805'; 
        c.fillRect(0, 0, this.width, this.height);

        // 2. –ù–∞—á–∞–ª–æ —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã
        c.save();
        // –¶–µ–Ω—Ç—Ä–∏—Ä—É–µ–º –∫–∞–º–µ—Ä—É –Ω–∞ –∏–≥—Ä–æ–∫–µ
        c.translate(this.width / 2 - this.player.x, this.height / 2 - this.player.y);

        // 3. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –±–µ—Å–∫–æ–Ω–µ—á–Ω–æ–π —Å–µ—Ç–∫–∏ (–¥–ª—è –æ—â—É—â–µ–Ω–∏—è –¥–≤–∏–∂–µ–Ω–∏—è)
        this.drawGrid(c);

        // 4. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—Ä–µ–¥–º–µ—Ç–æ–≤ (–∫—Ä–∏—Å—Ç–∞–ª–ª—ã –æ–ø—ã—Ç–∞)
        this.entities.items.forEach(it => {
            c.fillStyle = '#00ffd4';
            c.shadowBlur = 10;
            c.shadowColor = '#00ffd4';
            c.fillRect(it.x - 4, it.y - 4, 8, 8);
            c.shadowBlur = 0;
        });

        // 5. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É–ª—å
        this.entities.bullets.forEach(b => {
            c.fillStyle = b.color || '#fff';
            c.shadowBlur = 8;
            c.shadowColor = b.color || '#fff';
            c.beginPath();
            c.arc(b.x, b.y, b.enemy ? 4 : 3, 0, Math.PI * 2);
            c.fill();
            c.shadowBlur = 0;
        });

        // 6. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤
        this.entities.enemies.forEach(e => {
            c.fillStyle = e.color;
            c.shadowBlur = 15;
            c.shadowColor = e.color;
            c.beginPath();
            // –í—Ä–∞–≥–∏ ‚Äî –∫—Ä—É–≥–∏ —Ä–∞–∑–Ω–æ–≥–æ —Ä–∞–∑–º–µ—Ä–∞
            c.arc(e.x, e.y, e.size, 0, Math.PI * 2);
            c.fill();
            c.shadowBlur = 0;
        });

        // 7. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ë–æ—Å—Å–∞
        if (this.boss) {
            const b = this.boss;
            c.fillStyle = b.color;
            c.shadowBlur = 40;
            c.shadowColor = b.color;
            c.beginPath();
            c.arc(b.x, b.y, b.size, 0, Math.PI * 2);
            c.fill();
            
            // –ì–ª–∞–∑–∞ –±–æ—Å—Å–∞ (–¥–ª—è —É—Å—Ç—Ä–∞—à–µ–Ω–∏—è)
            c.fillStyle = '#fff';
            c.beginPath();
            c.arc(b.x - 20, b.y - 10, 8, 0, 7);
            c.arc(b.x + 20, b.y - 10, 8, 0, 7);
            c.fill();
            c.shadowBlur = 0;
        }

        // 8. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ò–≥—Ä–æ–∫–∞
        this.drawPlayer(c);

        c.restore(); // –ö–æ–Ω–µ—Ü —Ç—Ä–∞–Ω—Å—Ñ–æ—Ä–º–∞—Ü–∏–∏ –∫–∞–º–µ—Ä—ã

        // 9. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –ø–æ–≤–µ—Ä—Ö –∏–≥—Ä—ã (HUD –±–æ—Å—Å–∞)
        if (this.boss) this.drawBossHUD();
    },

    drawGrid(c) {
        c.strokeStyle = '#0a1a0a';
        c.lineWidth = 1;
        const size = 100;
        const startX = Math.floor((this.player.x - this.width / 2) / size) * size;
        const startY = Math.floor((this.player.y - this.height / 2) / size) * size;

        for (let x = startX; x < startX + this.width + size; x += size) {
            c.beginPath(); c.moveTo(x, startY); c.lineTo(x, startY + this.height + size); c.stroke();
        }
        for (let y = startY; y < startY + this.height + size; y += size) {
            c.beginPath(); c.moveTo(startX, y); c.lineTo(startX + this.width + size, y); c.stroke();
        }
    },

    drawPlayer(c) {
        const p = this.player;
        // –≠—Ñ—Ñ–µ–∫—Ç –º–∏–≥–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞
        if (p.iframe > 0 && Math.floor(this.time / 4) % 2 === 0) return;

        c.fillStyle = '#00d4ff';
        c.shadowBlur = 20;
        c.shadowColor = '#00d4ff';

        // –†–∏—Å—É–µ–º —Ñ–æ—Ä–º—É –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç –≤—ã–±—Ä–∞–Ω–Ω–æ–≥–æ –≥–µ—Ä–æ—è
        const icon = ui.getIcon(ui.selectedHero);
        c.font = 'bold 30px Arial';
        c.textAlign = 'center';
        c.textBaseline = 'middle';
        
        // –î–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏ —Ä–∏—Å—É–µ–º –ø—Ä–æ—Å—Ç–æ –∫–≤–∞–¥—Ä–∞—Ç, –µ—Å–ª–∏ –∏–∫–æ–Ω–∫–∞ —Å–ª–æ–∂–Ω–∞—è
        c.fillRect(p.x - 15, p.y - 15, 30, 30);
        
        c.shadowBlur = 0;
    }
});Object.assign(game, {
    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ –æ–±–Ω—É–ª–µ–Ω–∏–∏ HP –±–æ—Å—Å–∞
    onBossDefeat() {
        if (!this.boss) return;
        
        // –ó–≤—É–∫–æ–≤–æ–π —ç—Ñ—Ñ–µ–∫—Ç –ø–æ–±–µ–¥—ã
        if (typeof audio !== 'undefined') audio.playLvlUp();
        
        // –ù–∞–≥—Ä–∞–¥–∞: –∑–æ–ª–æ—Ç–æ –∏ —Ñ—Ä–∞–≥–º–µ–Ω—Ç—ã —Ç–µ–∫—É—â–µ–≥–æ –≥–µ—Ä–æ—è
        const goldReward = 1000 + (this.player.lvl * 10);
        account.current.gold += goldReward;
        
        const heroId = ui.selectedHero;
        const fragsCount = Math.floor(Math.random() * 3) + 1; // 1-3 —Ñ—Ä–∞–≥–º–µ–Ω—Ç–∞
        account.current.fragments[heroId] = (account.current.fragments[heroId] || 0) + fragsCount;
        
        // –°—Ç–∞—Ç–∏—Å—Ç–∏–∫–∞ —É–±–∏–π—Å—Ç–≤ –±–æ—Å—Å–æ–≤
        account.current.records.boss = (account.current.records.boss || 0) + 1;
        
        alert(`–ë–û–°–° –ü–û–í–ï–†–ñ–ï–ù!\n–ó–æ–ª–æ—Ç–æ: +${goldReward}\n–§—Ä–∞–≥–º–µ–Ω—Ç—ã ${heroId.toUpperCase()}: +${fragsCount}`);
        
        this.boss = null;
        account.save();
    },

    // –í—ã–∑—ã–≤–∞–µ—Ç—Å—è –ø—Ä–∏ —Å–º–µ—Ä—Ç–∏ –∏–≥—Ä–æ–∫–∞
    gameOver() {
        this.active = false;
        
        // –†–∞—Å—á–µ—Ç –≤—Ä–µ–º–µ–Ω–∏ –≤—ã–∂–∏–≤–∞–Ω–∏—è –≤ —Å–µ–∫—É–Ω–¥–∞—Ö
        const sessionTime = Math.floor(this.time / 60);
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–æ–≤
        if (sessionTime > account.current.records.endless) {
            account.current.records.endless = sessionTime;
        }
        
        // –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ –∏—Ç–æ–≥–æ–≤
        account.save();
        
        // –ó–≤—É–∫ –ø–æ—Ä–∞–∂–µ–Ω–∏—è
        if (typeof audio !== 'undefined') audio.playHurt();

        this.showGameOverScreen(sessionTime);
    },

    showGameOverScreen(time) {
        // –£–±–∏—Ä–∞–µ–º HUD –∏ –¥–∂–æ–π—Å—Ç–∏–∫
        document.getElementById('hud').classList.add('hidden');
        document.getElementById('joy-base').classList.add('hidden');

        const overlay = document.createElement('div');
        overlay.className = 'ui-screen';
        overlay.style.background = 'rgba(10, 0, 0, 0.9)';
        overlay.style.zIndex = '200';

        const panel = document.createElement('div');
        panel.className = 'panel';
        panel.style.borderColor = 'var(--red)';
        
        panel.innerHTML = `
            <h1 style="color:var(--red); margin:0; font-size:40px;">–í–´ –ü–û–ì–ò–ë–õ–ò</h1>
            <p style="margin: 20px 0; line-height: 1.6;">
                –í—Ä–µ–º—è: <b style="color:var(--primary)">${time} —Å–µ–∫.</b><br>
                –£—Ä–æ–≤–µ–Ω—å: <b style="color:var(--primary)">${this.player.lvl}</b><br>
                –ó–æ–ª–æ—Ç–æ –∑–∞ –∑–∞–±–µ–≥: <b style="color:var(--gold)">${Math.floor(this.time / 60 * 2)}</b>
            </p>
            <button class="btn" onclick="location.reload()">–í –ú–ï–ù–Æ</button>
        `;

        overlay.appendChild(panel);
        document.body.appendChild(overlay);
    },

    // –û–±—â–∏–π —Ü–∏–∫–ª (Loop)
    loop() {
        if (!this.active) return;
        this.update();
        this.render();
        requestAnimationFrame(() => this.loop());
    },

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –¥–∞–Ω–Ω—ã—Ö –≤ HUD
    updateHUD() {
        const hpBar = document.getElementById('hp-fill');
        const expBar = document.getElementById('exp-fill');
        const lvlTxt = document.getElementById('h-lvl');
        const timeTxt = document.getElementById('h-time');
        const goldTxt = document.getElementById('h-gold');

        if (hpBar) hpBar.style.width = (this.player.hp / this.player.maxHp * 100) + '%';
        if (expBar) expBar.style.width = (this.player.exp / this.player.next * 100) + '%';
        if (lvlTxt) lvlTxt.innerText = `LVL ${this.player.lvl}`;
        if (goldTxt) goldTxt.innerText = Math.floor(account.current.gold);
        
        const s = Math.floor(this.time / 60);
        const mins = Math.floor(s / 60).toString().padStart(2, '0');
        const secs = (s % 60).toString().padStart(2, '0');
        if (timeTxt) timeTxt.innerText = `${mins}:${secs}`;
    }
});const admin = {
    // –î–æ–±–∞–≤–∏—Ç—å 10,000 –∑–æ–ª–æ—Ç–∞
    addGold() {
        if (!account.current) return;
        account.current.gold += 10000;
        account.save();
        account.updateUI();
        console.log("Admin: +10000 Gold");
    },

    // –ú–≥–Ω–æ–≤–µ–Ω–Ω—ã–π Level Up
    forceLvlUp() {
        if (!game.active) return;
        game.levelUp();
    },

    // –ü—Ä–∏–∑–≤–∞—Ç—å –±–æ—Å—Å–∞ –ø—Ä—è–º–æ —Å–µ–π—á–∞—Å
    spawnBossNow() {
        if (!game.active) return;
        game.spawnBoss();
        console.log("Admin: Boss Spawned");
    },

    // –†–µ–∂–∏–º –±–µ—Å—Å–º–µ—Ä—Ç–∏—è (God Mode)
    toggleGodMode() {
        game.player.maxHp = 999999;
        game.player.hp = 999999;
        game.player.damage = 500;
        alert("GOD MODE ACTIVE: HP 1M, DMG 500");
    },

    // –û—á–∏—Å—Ç–∫–∞ –≤—Å–µ—Ö –¥–∞–Ω–Ω—ã—Ö (Hard Reset)
    resetAll() {
        if (confirm("–£–î–ê–õ–ò–¢–¨ –í–ï–°–¨ –ü–†–û–ì–†–ï–°–°?")) {
            localStorage.clear();
            location.reload();
        }
    }
};

// –†–∞—Å—à–∏—Ä–µ–Ω–∏–µ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞ –¥–ª—è –∞–¥–º–∏–Ω-–ø–∞–Ω–µ–ª–∏
ui.renderAdminPanel = function() {
    const body = document.getElementById('rank-body'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —Ç–æ –∂–µ –ø–æ–ª–µ
    const title = document.getElementById('rank-col-name');
    if (!body || !title) return;

    title.innerText = "DEBUG TOOLS";
    body.innerHTML = `
        <tr><td colspan="3"><button class="btn" onclick="admin.addGold()">+10000 GOLD</button></td></tr>
        <tr><td colspan="3"><button class="btn" onclick="admin.toggleGodMode()">GOD MODE</button></td></tr>
        <tr><td colspan="3"><button class="btn" onclick="admin.spawnBossNow()">SPAWN BOSS</button></td></tr>
        <tr><td colspan="3"><button class="btn btn-sec" style="color:red; border-color:red;" onclick="admin.resetAll()">RESET DATA</button></td></tr>
    `;
};

// –û–±–Ω–æ–≤–ª—è–µ–º –º–µ—Ç–æ–¥ –ø–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏—è –≤–∫–ª–∞–¥–æ–∫ –¥–ª—è –ø–æ–¥–¥–µ—Ä–∂–∫–∏ –∞–¥–º–∏–Ω–∫–∏
const originalShowTab = ui.showTab;
ui.showTab = function(id) {
    if (id === 'admin-panel') {
        document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('rankings').classList.remove('hidden'); // –ò—Å–ø–æ–ª—å–∑—É–µ–º —ç–∫—Ä–∞–Ω —Ç–∞–±–ª–∏—Ü
        this.renderAdminPanel();
    } else {
        originalShowTab.call(this, id);
    }
};const performance = {
    lastCleanup: 0,

    // –ì–ª—É–±–æ–∫–∞—è –æ—á–∏—Å—Ç–∫–∞ –Ω–µ–∏—Å–ø–æ–ª—å–∑—É–µ–º—ã—Ö –æ–±—ä–µ–∫—Ç–æ–≤
    gc() {
        const p = game.player;
        const limit = 1000; // –†–∞–¥–∏—É—Å –∂–∏–∑–Ω–∏ –æ–±—ä–µ–∫—Ç–∞

        // –£–¥–∞–ª—è–µ–º –≤—Ä–∞–≥–æ–≤, –∫–æ—Ç–æ—Ä—ã–µ —Å–ª–∏—à–∫–æ–º –¥–∞–ª–µ–∫–æ (–∏–≥—Ä–æ–∫ —É–±–µ–∂–∞–ª)
        game.entities.enemies = game.entities.enemies.filter(e => {
            const dist = Math.hypot(e.x - p.x, e.y - p.y);
            return dist < limit;
        });

        // –£–¥–∞–ª—è–µ–º –ø—É–ª–∏, –≤—ã—à–µ–¥—à–∏–µ –∑–∞ –ø—Ä–µ–¥–µ–ª—ã —ç–∫—Ä–∞–Ω–∞
        game.entities.bullets = game.entities.bullets.filter(b => b.life > 0);

        // –õ–∏–º–∏—Ç –ø—Ä–µ–¥–º–µ—Ç–æ–≤ –Ω–∞ –∑–µ–º–ª–µ (–º–∞–∫—Å–∏–º—É–º 100 –∫—Ä–∏—Å—Ç–∞–ª–ª–æ–≤ –¥–ª—è FPS)
        if (game.entities.items.length > 100) {
            game.entities.items.splice(0, game.entities.items.length - 100);
        }
    },

    // –ò—Å–ø—Ä–∞–≤–ª–µ–Ω–∏–µ –¥–ª—è –º–æ–±–∏–ª—å–Ω—ã—Ö –±—Ä–∞—É–∑–µ—Ä–æ–≤ (–ø—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ "—Ä–µ–∑–∏–Ω–æ–≤–æ–≥–æ" —Å–∫—Ä–æ–ª–ª–∞)
    fixMobile() {
        document.addEventListener('gesturestart', (e) => e.preventDefault());
        document.addEventListener('dblclick', (e) => e.preventDefault());
        
        // –ë–ª–æ–∫–∏—Ä–æ–≤–∫–∞ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –Ω–∞ –¥–æ–ª–≥–æ–µ –Ω–∞–∂–∞—Ç–∏–µ
        window.oncontextmenu = (e) => {
            if (game.active) {
                e.preventDefault();
                e.stopPropagation();
                return false;
            }
        };
    }
};

// –í–Ω–µ–¥—Ä–µ–Ω–∏–µ –≤ –∏–≥—Ä–æ–≤–æ–π —Ü–∏–∫–ª
const originalUpdate = game.update;
game.update = function() {
    originalUpdate.call(this);
    
    // –ß–∏—Å—Ç–∏–º –ø–∞–º—è—Ç—å –∫–∞–∂–¥—ã–µ 5 —Å–µ–∫—É–Ω–¥ (300 –∫–∞–¥—Ä–æ–≤)
    if (this.time % 300 === 0) {
        performance.gc();
    }
};

// –ê–≤—Ç–æ-–∑–∞–ø—É—Å–∫ —Ñ–∏–∫—Å–æ–≤
performance.fixMobile();

// –û–±—Ä–∞–±–æ—Ç–∫–∞ –∏–∑–º–µ–Ω–µ–Ω–∏—è —Ä–∞–∑–º–µ—Ä–∞ –æ–∫–Ω–∞
window.onresize = () => {
    if (game.active) {
        game.width = gameCanvas.width = window.innerWidth;
        game.height = gameCanvas.height = window.innerHeight;
    }
};/**
 * –ì–ª–æ–±–∞–ª—å–Ω—ã–π –∑–∞–ø—É—Å–∫ –∏–≥—Ä—ã
 */
window.addEventListener('DOMContentLoaded', () => {
    // 1. –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∞—É–¥–∏–æ-–∫–æ–Ω—Ç–µ–∫—Å—Ç–∞
    // –ú—ã –Ω–µ –∑–∞–ø—É—Å–∫–∞–µ–º –∑–≤—É–∫ —Å—Ä–∞–∑—É (–∑–∞–ø—Ä–µ—â–µ–Ω–æ –±—Ä–∞—É–∑–µ—Ä–æ–º), 
    // –Ω–æ –≥–æ—Ç–æ–≤–∏–º –æ–±—ä–µ–∫—Ç –∏ –æ–±–Ω–æ–≤–ª—è–µ–º –≤–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–æ—Å—Ç–æ—è–Ω–∏–µ –∫–Ω–æ–ø–∫–∏.
    audio.updateBtnUI();

    // 2. –ó–∞–≥—Ä—É–∑–∫–∞ –¥–∞–Ω–Ω—ã—Ö –∞–∫–∫–∞—É–Ω—Ç–∞
    // –ü—Ä–æ–±—É–µ–º –Ω–∞–π—Ç–∏ –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ localStorage
    const savedKeys = Object.keys(localStorage).filter(k => k.startsWith('mega_save_'));
    if (savedKeys.length > 0) {
        // –ü–æ–¥—Å—Ç–∞–≤–ª—è–µ–º –∏–º—è –ø–æ—Å–ª–µ–¥–Ω–µ–≥–æ –∞–∫—Ç–∏–≤–Ω–æ–≥–æ –∏–≥—Ä–æ–∫–∞ –≤ –ø–æ–ª–µ –≤–≤–æ–¥–∞
        const lastNick = savedKeys[0].replace('mega_save_', '');
        const input = document.getElementById('auth-nick');
        if (input) input.value = lastNick;
    }

    // 3. –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –º–∞—Å—à—Ç–∞–±–∏—Ä–æ–≤–∞–Ω–∏—è Canvas
    const resizeCanvas = () => {
        if (game.active) {
            game.width = gameCanvas.width = window.innerWidth;
            game.height = gameCanvas.height = window.innerHeight;
        }
    };
    window.addEventListener('resize', resizeCanvas);

    // 4. –ì–ª–æ–±–∞–ª—å–Ω—ã–µ –æ–±—Ä–∞–±–æ—Ç—á–∏–∫–∏ –¥–ª—è —Å—Ç–∞–±–∏–ª—å–Ω–æ—Å—Ç–∏
    window.onerror = function(msg, url, line) {
        console.error(`Runtime Error: ${msg} at line ${line}`);
        // –ü–æ–ø—ã—Ç–∫–∞ —ç–∫—Å—Ç—Ä–µ–Ω–Ω–æ–≥–æ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –ø—Ä–∏ –∫—Ä–∞—à–µ
        if (account && account.current) account.save();
        return false;
    };

    // 5. –û–±—Ä–∞–±–æ—Ç–∫–∞ —Ñ–æ–∫—É—Å–∞ –≤–∫–ª–∞–¥–∫–∏
    document.addEventListener('visibilitychange', () => {
        if (document.hidden && game.active) {
            game.paused = true;
            console.log("Game paused: tab hidden");
        }
    });

    // 6. –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–µ–Ω–∏–µ –∫–æ–Ω—Ç–µ–∫—Å—Ç–Ω–æ–≥–æ –º–µ–Ω—é –≤–æ –≤—Ä–µ–º—è –∏–≥—Ä—ã
    window.oncontextmenu = (e) => {
        if (game.active) e.preventDefault();
    };

    console.log("MEGA SURVIVOR 2026: –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∑–∞–≤–µ—Ä—à–µ–Ω–∞. –û—à–∏–±–æ–∫ 404 –Ω–µ –æ–±–Ω–∞—Ä—É–∂–µ–Ω–æ.");
});

/**
 * –ò–Ω—Å—Ç—Ä—É–∫—Ü–∏—è –ø–æ —Å–±–æ—Ä–∫–µ:
 * 1. –ß–∞—Å—Ç—å 1 (HTML) - –°—Ç—Ä—É–∫—Ç—É—Ä–∞ —Å –∫–Ω–æ–ø–∫–æ–π –∑–≤—É–∫–∞.
 * 2. –ß–∞—Å—Ç—å 2 (CSS) - –°—Ç–∏–ª–∏ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞.
 * 3. –ß–∞—Å—Ç–∏ 3-15 (JS) - –í—Å–µ –º–æ–¥—É–ª–∏ (Account, Audio, Shop, Game Logic).
 * 4. –ß–∞—Å—Ç—å 16 (JS) - –≠—Ç–æ—Ç –±–ª–æ–∫ –∏–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏–∏.
 * * –í—Å–µ —á–∞—Å—Ç–∏ JS –¥–æ–ª–∂–Ω—ã –Ω–∞—Ö–æ–¥–∏—Ç—å—Å—è –≤ –æ–¥–Ω–æ–º —Ç–µ–≥–µ <script> –∏–ª–∏ —Ñ–∞–π–ª–µ.
 */
