<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivor.io Clone - Part 1</title>
    <style>
        body { margin: 0; background: #020202; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; }
        
        /* –°—Ç–∏–ª–∏ –æ–≤–µ—Ä–ª–µ–µ–≤ –∏ –º–æ–¥–∞–ª—å–Ω—ã—Ö –æ–∫–æ–Ω */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.95); z-index: 100; display: flex; flex-direction: column; align-items: center; justify-content: center; padding: 20px; }
        .modal { background: #111; padding: 25px; border-radius: 20px; border: 2px solid #00d4ff; width: 95%; max-width: 450px; text-align: center; max-height: 85vh; overflow-y: auto; position: relative; }
        
        /* –ò–≥—Ä–æ–≤–æ–π UI */
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        #exp-bar { width: 100%; height: 10px; background: #1a1a1a; border-radius: 5px; border: 1px solid #333; overflow: hidden; }
        #exp-fill { width: 0%; height: 100%; background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
        #hp-bar { width: 140px; height: 14px; background: #333; margin-top: 8px; border-radius: 7px; border: 2px solid #000; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; transition: width 0.3s; }
        
        /* –ö–Ω–æ–ø–∫–∏ –∏ –ö–∞—Ä—Ç–æ—á–∫–∏ */
        .btn { background: #222; border: 2px solid #00d4ff; color: #00d4ff; padding: 12px 20px; border-radius: 10px; cursor: pointer; font-weight: bold; margin: 5px; display: inline-block; pointer-events: all; text-decoration: none; }
        .btn:active { transform: scale(0.95); }
        .btn-gold { border-color: #ffd700; color: #ffd700; }
        .btn-red { border-color: #ff4d4d; color: #ff4d4d; }
        .card { background: #1a1a1a; border: 2px solid #333; border-radius: 12px; padding: 15px; margin: 10px 0; cursor: pointer; text-align: left; }
        .card.selected { border-color: #00ff00; background: #0a1f0a; }
        .card.locked { opacity: 0.5; cursor: not-allowed; }
        
        /* –ê–¥–º–∏–Ω-–ø–∞–Ω–µ–ª—å */
        .tabs { display: flex; gap: 5px; margin-bottom: 15px; }
        .tab-btn { flex: 1; padding: 8px; background: #222; border: 1px solid #444; color: #888; border-radius: 5px; cursor: pointer; font-size: 11px; }
        .tab-btn.active { background: #00d4ff; color: #000; font-weight: bold; }
        .tab-content { display: none; flex-direction: column; gap: 8px; }
        .tab-content.active { display: flex; }
        
        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #joystick-container { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; }
        #joystick-base { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 50%; border: 1px solid rgba(255,255,255,0.1); display: flex; align-items: center; justify-content: center; }
        #joystick-stick { width: 40px; height: 40px; background: #00d4ff; border-radius: 50%; opacity: 0.4; }
    </style>
</head>
<body>

<div id="start-screen" class="overlay">
    <div class="modal">
        <h1 style="color:#00d4ff; margin:0 0 15px 0;">SURVIVOR AI</h1>
        <div id="diff-list">
            <div id="d-easy" class="card selected" onclick="setD('easy')"><b>–õ–ï–ì–ö–û</b><small>–ù–∞–≥—Ä–∞–¥—ã x1.0</small></div>
            <div id="d-norm" class="card locked" onclick="setD('normal')"><b>–ù–û–†–ú–ê–õ–¨–ù–û</b><small id="t-norm">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</small></div>
            <div id="d-hard" class="card locked" onclick="setD('hard')"><b>–ê–î</b><small id="t-hard">–ó–∞–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω–æ</small></div>
        </div>
        <div class="btn" style="width:80%;" onclick="showShop()">–ú–ê–ì–ê–ó–ò–ù –ì–ï–†–û–ï–í</div>
        <div class="btn" style="width:80%; background:#00d4ff; color:#000;" onclick="initGame()">–ò–ì–†–ê–¢–¨</div>
    </div>
</div>

<div id="shop-screen" class="overlay" style="display:none">
    <div class="modal">
        <h2>–ì–ï–†–û–ò</h2>
        <div id="char-list" style="max-height: 350px; overflow-y: auto;"></div>
        <div class="btn btn-red" onclick="hideShop()">–ù–ê–ó–ê–î</div>
    </div>
</div>

<div id="admin-screen" class="overlay" style="display:none">
    <div class="modal">
        <h3>ADMIN PANEL</h3>
        <div class="tabs">
            <button class="tab-btn active" onclick="tab(event, 'tp')">PLAYER</button>
            <button class="tab-btn" onclick="tab(event, 'tw')">WORLD</button>
            <button class="tab-btn" onclick="tab(event, 'tr')">RESET</button>
        </div>
        <div id="tp" class="tab-content active">
            <div class="btn" onclick="godMode=!godMode">GOD MODE: TOGGLE</div>
            <div class="btn" onclick="player.hp=player.maxHp; updateDraw()">HEAL</div>
            <div class="btn" onclick="levelUp()">LEVEL UP</div>
        </div>
        <div id="tw" class="tab-content">
            <div class="btn" onclick="enemies=[]">KILL ALL</div>
            <div class="btn" onclick="spawnEnemy(DIFF_SETTINGS[selectedDiff], 300)">SPAWN BOSS</div>
        </div>
        <div id="tr" class="tab-content">
            <div class="btn btn-gold" onclick="persistentGold+=10000; saveGame(); updateUIMenu();">+10k GOLD</div>
            <div class="btn btn-red" onclick="localStorage.clear(); location.reload();">WIPE ALL</div>
        </div>
        <div class="btn" onclick="toggleAdmin()">CLOSE</div>
    </div>
</div>

<div id="ui" style="display:none">
    <div id="exp-bar"><div id="exp-fill"></div></div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div style="display:flex; justify-content:space-between; margin-top:5px; font-weight:bold;">
        <span id="g-ui" style="color:#ffd700">üí∞ 0</span>
        <span id="t-ui">00:00</span>
    </div>
</div>

<div id="adm-btn" style="position:fixed; top:80px; right:15px; background:rgba(0,212,255,0.3); padding:5px; border-radius:5px; z-index:200; cursor:pointer;" onclick="toggleAdmin()">ADM</div>
<div id="level-menu" class="overlay" style="display:none"><div class="modal"><h2>–í–´–ë–û–† –ù–ê–í–´–ö–ê</h2><div id="skill-cards"></div></div></div>

<canvas id="game"></canvas>
<div id="joystick-container"><div id="joystick-base"><div id="joystick-stick"></div></div></div><script>
/** --- 1. –ö–û–ù–°–¢–ê–ù–¢–´ –ò –ù–ê–°–¢–†–û–ô–ö–ò --- **/
const CHARACTER_DATA = {
    square: { id: 'square', name: '–ö–≤–∞–¥—Ä–∞—Ç', hp: 150, dmg: 1.0, speed: 3.2, magnet: 70, shape: 'rect', price: 0 },
    triangle: { id: 'triangle', name: '–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', hp: 90, dmg: 1.8, speed: 4.2, magnet: 60, shape: 'tri', price: 1500 },
    circle: { id: 'circle', name: '–ö—Ä—É–≥', hp: 120, dmg: 1.0, speed: 5.5, magnet: 130, shape: 'circle', price: 2500 },
    star: { id: 'star', name: '–ó–≤–µ–∑–¥–∞', hp: 200, dmg: 2.2, speed: 4.5, magnet: 160, shape: 'star', price: 20000 }
};

const ALL_SKILLS = [
    { id: 'gun', name: '–ü—É—à–∫–∞', desc: '–°—Ç—Ä–µ–ª—è–µ—Ç —Å–Ω–∞—Ä—è–¥–∞–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞', type: 'atk' },
    { id: 'field', name: '–ê—É—Ä–∞', desc: '–ù–∞–Ω–æ—Å–∏—Ç –ø–æ—Å—Ç–æ—è–Ω–Ω—ã–π —É—Ä–æ–Ω –≤–æ–∫—Ä—É–≥ –≥–µ—Ä–æ—è', type: 'atk' },
    { id: 'p_hp', name: '–ñ–∏–ª–µ—Ç', desc: '–£–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç –º–∞–∫—Å. HP –Ω–∞ +35', type: 'pas' },
    { id: 'p_speed', name: '–ö–µ–¥—ã', desc: '–°–∫–æ—Ä–æ—Å—Ç—å –ø–µ—Ä–µ–¥–≤–∏–∂–µ–Ω–∏—è +0.4', type: 'pas' },
    { id: 'p_dmg', name: '–°–≤–∏—Ç–æ–∫', desc: '–í–µ—Å—å –Ω–∞–Ω–æ—Å–∏–º—ã–π —É—Ä–æ–Ω +15%', type: 'pas' }
];

const DIFF_SETTINGS = {
    easy: { hpM: 1, spM: 1, gM: 1, req: 0 },
    normal: { hpM: 2.5, spM: 1.3, gM: 1.8, req: 1800 },
    hard: { hpM: 6, spM: 1.7, gM: 3.5, req: 1800 }
};

/** --- 2. –ì–õ–û–ë–ê–õ–¨–ù–û–ï –°–û–°–¢–û–Ø–ù–ò–ï --- **/
let save = JSON.parse(localStorage.getItem('surv_mega_v2')) || { 
    gold: 0, 
    selectedId: 'square', 
    unlocked: ['square'], 
    timeEasy: 0, 
    timeNormal: 0, 
    achDone: [] 
};

let gameActive = false, isPaused = false, godMode = false;
let selectedDiff = 'easy', persistentGold = save.gold;
let player, enemies = [], bullets = [], crystals = [], decor = [];
let startTime, timeOffset = 0, weaponTimers = { gun: 0 };
let joy = { active: false, x: 0, y: 0 };

const canvas = document.getElementById('game'), ctx = canvas.getContext('2d');
const tileCanvas = document.createElement('canvas');
const tCtx = tileCanvas.getContext('2d');

/** --- 3. –§–£–ù–ö–¶–ò–ò –°–û–•–†–ê–ù–ï–ù–ò–Ø –ò –ú–ï–ù–Æ --- **/
function saveGame() { 
    save.gold = persistentGold; 
    localStorage.setItem('surv_mega_v2', JSON.stringify(save)); 
}

function updateUIMenu() {
    document.getElementById('g-ui').innerText = `üí∞ ${Math.floor(persistentGold)}`;
    
    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Å–ª–æ–≤–∏–π —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∫–∏
    const tNorm = document.getElementById('t-norm');
    if (save.timeEasy >= 1800) {
        document.getElementById('d-norm').classList.remove('locked');
        tNorm.innerText = "–î–æ—Å—Ç—É–ø–Ω–æ!";
    } else {
        tNorm.innerText = `–ù—É–∂–Ω–æ –µ—â–µ ${Math.ceil((1800 - save.timeEasy)/60)} –º–∏–Ω. –Ω–∞ –ª–µ–≥–∫–æ–º`;
    }

    const tHard = document.getElementById('t-hard');
    if (save.timeNormal >= 1800) {
        document.getElementById('d-hard').classList.remove('locked');
        tHard.innerText = "–î–æ—Å—Ç—É–ø–Ω–æ!";
    } else {
        tHard.innerText = `–ù—É–∂–Ω–æ –µ—â–µ ${Math.ceil((1800 - save.timeNormal)/60)} –º–∏–Ω. –Ω–∞ –Ω–æ—Ä–º.`;
    }
}

function setD(d) {
    if ((d === 'normal' && save.timeEasy < 1800) || (d === 'hard' && save.timeNormal < 1800)) return;
    selectedDiff = d;
    document.querySelectorAll('.card').forEach(c => c.classList.remove('selected'));
    document.getElementById('d-' + (d === 'easy' ? 'easy' : d === 'normal' ? 'norm' : 'hard')).classList.add('selected');
}

function showShop() {
    document.getElementById('start-screen').style.display = 'none';
    document.getElementById('shop-screen').style.display = 'flex';
    const list = document.getElementById('char-list');
    list.innerHTML = '';

    Object.values(CHARACTER_DATA).forEach(char => {
        const isOwned = save.unlocked.includes(char.id);
        const card = document.createElement('div');
        card.className = `card ${save.selectedId === char.id ? 'selected' : ''}`;
        card.innerHTML = `
            <b>${char.name}</b>
            <small>HP: ${char.hp} | –£—Ä–æ–Ω: ${char.dmg}x</small>
            ${isOwned ? 
                `<div class="btn" onclick="selectChar('${char.id}')">–í–´–ë–†–ê–¢–¨</div>` : 
                `<div class="btn btn-gold" onclick="buyChar('${char.id}', ${char.price})">–ö–£–ü–ò–¢–¨ –ó–ê ${char.price}üí∞</div>`
            }
        `;
        list.appendChild(card);
    });
}

function buyChar(id, price) {
    if (persistentGold >= price) {
        persistentGold -= price;
        save.unlocked.push(id);
        saveGame();
        showShop();
    }
}

function selectChar(id) {
    save.selectedId = id;
    saveGame();
    showShop();
}

function hideShop() {
    document.getElementById('shop-screen').style.display = 'none';
    document.getElementById('start-screen').style.display = 'flex';
    updateUIMenu();
}

function toggleAdmin() {
    isPaused = !isPaused;
    document.getElementById('admin-screen').style.display = isPaused ? 'flex' : 'none';
}

function tab(e, id) {
    document.querySelectorAll('.tab-content').forEach(c => c.classList.remove('active'));
    document.querySelectorAll('.tab-btn').forEach(b => b.classList.remove('active'));
    document.getElementById(id).classList.add('active');
    e.currentTarget.classList.add('active');
}/** --- 4. –°–ò–°–¢–ï–ú–ê –§–û–ù–ê –ò –û–¢–†–ò–°–û–í–ö–ò --- **/
function initBackground() {
    tileCanvas.width = 100; tileCanvas.height = 100;
    // –¢–µ–∫—Å—Ç—É—Ä–∞ –ø–ª–∏—Ç–∫–∏
    tCtx.fillStyle = '#1a2b1a'; tCtx.fillRect(0,0,100,100);
    tCtx.strokeStyle = 'rgba(0,0,0,0.15)'; tCtx.lineWidth = 2;
    tCtx.strokeRect(0,0,100,100);
    // –î–µ—Ç–∞–ª–∏ –Ω–∞ –ø–ª–∏—Ç–∫–µ
    for(let i=0; i<12; i++) { 
        tCtx.fillStyle='rgba(255,255,255,0.03)'; 
        tCtx.fillRect(Math.random()*100, Math.random()*100, 2, 2); 
    }
    // –ì–µ–Ω–µ—Ä–∞—Ü–∏—è –¥–µ–∫–æ—Ä–∞ (–∫–∞–º–Ω–∏/—Ç—Ä–∞–≤–∞) –Ω–∞ –±–æ–ª—å—à–æ–π –∫–∞—Ä—Ç–µ
    for(let i=0; i<100; i++) {
        decor.push({ 
            x: (Math.random()-0.5)*5000, 
            y: (Math.random()-0.5)*5000, 
            s: Math.random()*4+2, 
            t: Math.random()>0.5?'s':'g' 
        });
    }
}

/** --- 5. –ì–ï–ô–ú–ü–õ–ï–ô –ò –õ–û–ì–ò–ö–ê --- **/
function initGame() {
    document.getElementById('start-screen').style.display='none'; 
    document.getElementById('ui').style.display='block';
    canvas.width = window.innerWidth; canvas.height = window.innerHeight;
    
    const char = CHARACTER_DATA[save.selectedId];
    player = { 
        ...char, x:0, y:0, lvl:1, exp:0, nextLvl:100, 
        skills:{gun:1, field:0, p_hp:0, p_speed:0, p_dmg:0}, 
        maxHp:char.hp, hp:char.hp, cd:1, expMod:1, kills:0, runG:0 
    };

    enemies=[]; bullets=[]; crystals=[]; gameActive=true; startTime=Date.now();
    loop();
}

function spawnEnemy(cfg, time) {
    const a = Math.random()*Math.PI*2;
    const isBoss = time > 0 && time % 300 === 0 && !enemies.some(e => e.boss);
    enemies.push({ 
        x: player.x + Math.cos(a)*850, 
        y: player.y + Math.sin(a)*850, 
        hp: (isBoss ? 5000 : 60) * cfg.hpM, 
        speed: (isBoss ? 1.1 : 1.6) * cfg.spM, 
        boss: isBoss, 
        size: isBoss ? 55 : 18 
    });
}

function loop() {
    if(!gameActive || isPaused) return requestAnimationFrame(loop);
    const now = Date.now(), elapsed = Math.floor((now-startTime)/1000) + timeOffset;
    const cfg = DIFF_SETTINGS[selectedDiff];
    
    if(joy.active) { player.x += joy.x * player.speed; player.y += joy.y * player.speed; }
    if(enemies.length < 45 + (elapsed/8)) spawnEnemy(cfg, elapsed);

    // –õ–æ–≥–∏–∫–∞ –æ—Ä—É–∂–∏—è (–ü—É—à–∫–∞)
    if(now - weaponTimers.gun > 850 * player.cd) {
        let e = getNear(); if(e) {
            let a = Math.atan2(e.y-player.y, e.x-player.x);
            bullets.push({ 
                x:player.x, y:player.y, 
                vx:Math.cos(a)*13, vy:Math.sin(a)*13, 
                p:player.skills.gun>=6?5:1 
            });
            weaponTimers.gun = now;
        }
    }

    // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –≤—Ä–∞–≥–æ–≤ –∏ —Å—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–π
    enemies.forEach((e, i) => {
        let dx = player.x-e.x, dy = player.y-e.y, d = Math.sqrt(dx*dx+dy*dy);
        e.x += (dx/d)*e.speed; e.y += (dy/d)*e.speed;
        if(d < e.size+12 && !godMode) { 
            player.hp -= 0.5 * cfg.hpM; 
            if(player.hp<=0) endGame(elapsed); 
        }
    });

    // –ü—É–ª–∏
    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        enemies.forEach((e, ei) => {
            if(Math.sqrt((b.x-e.x)**2+(b.y-e.y)**2) < e.size+10) {
                e.hp -= (45 + player.skills.gun*15)*player.dmg; b.p--;
                if(b.p<=0) bullets.splice(i,1);
                if(e.hp<=0) { 
                    player.kills++; 
                    let g=5*cfg.gM; player.runG+=g; persistentGold+=g; 
                    crystals.push({x:e.x, y:e.y}); 
                    enemies.splice(ei,1); 
                }
            }
        });
        if(Math.abs(b.x-player.x)>1100) bullets.splice(i,1);
    });

    // –°–±–æ—Ä –æ–ø—ã—Ç–∞
    crystals.forEach((c, i) => {
        let d = Math.sqrt((c.x-player.x)**2+(c.y-player.y)**2);
        if(d < player.magnet) {
            player.exp += 40; crystals.splice(i,1); 
            if(player.exp >= player.nextLvl) levelUp();
        }
    });

    draw(elapsed);
    requestAnimationFrame(loop);
}

function levelUp() {
    isPaused=true; document.getElementById('level-menu').style.display='flex';
    const cont = document.getElementById('skill-cards'); cont.innerHTML = '';
    
    ALL_SKILLS.filter(s=>player.skills[s.id]<6).sort(()=>0.5-Math.random()).slice(0,3).forEach(s => {
        let l = player.skills[s.id]+1;
        let card = document.createElement('div');
        card.className = `card ${l===6?'selected':''}`;
        card.innerHTML = `<b>${s.name} [${l===6?'‚òÖ':l}]</b><small>${s.desc}</small>`;
        card.onclick = () => { 
            player.skills[s.id]++; 
            if(s.id==='p_hp'){ player.maxHp+=35; player.hp+=35; } 
            if(s.id==='p_speed') player.speed+=0.4; 
            player.exp=0; player.lvl++; player.nextLvl *= 1.3; 
            document.getElementById('level-menu').style.display='none'; isPaused=false; 
        };
        cont.appendChild(card);
    });
}

/** --- 6. –û–¢–†–ò–°–û–í–ö–ê --- **/
function draw(el) {
    const cx = canvas.width/2, cy = canvas.height/2;
    ctx.clearRect(0,0,canvas.width,canvas.height);

    // 1. –û—Ç—Ä–∏—Å–æ–≤–∫–∞ —Ñ–æ–Ω–∞
    const offX = -player.x % 100, offY = -player.y % 100;
    for(let x = offX-100; x<canvas.width+100; x+=100) 
        for(let y = offY-100; y<canvas.height+100; y+=100) ctx.drawImage(tileCanvas, x, y);

    // 2. –î–µ–∫–æ—Ä –Ω–∞ –∫–∞—Ä—Ç–µ
    decor.forEach(d => {
        let sx = d.x-player.x+cx, sy = d.y-player.y+cy;
        if(sx>-50 && sx<canvas.width+50 && sy>-50 && sy<canvas.height+50) {
            ctx.fillStyle = d.t==='s'?'#444':'#2d4d2d';
            if(d.t==='s'){ ctx.beginPath(); ctx.arc(sx, sy, d.s, 0, Math.PI*2); ctx.fill(); } else ctx.fillRect(sx, sy, 2, d.s*2);
        }
    });

    // 3. –ö—Ä–∏—Å—Ç–∞–ª–ª—ã –∏ –í—Ä–∞–≥–∏
    crystals.forEach(c => { ctx.fillStyle='#0ff'; ctx.fillRect(c.x-player.x+cx-4, c.y-player.y+cy-4, 8, 8); });
    enemies.forEach(e => {
        ctx.fillStyle='rgba(0,0,0,0.3)'; ctx.beginPath(); ctx.ellipse(e.x-player.x+cx, e.y-player.y+cy+e.size, e.size, e.size/3, 0, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle=e.boss?'#ff0055':'#f44'; ctx.beginPath(); ctx.arc(e.x-player.x+cx, e.y-player.y+cy, e.size, 0, Math.PI*2); ctx.fill();
    });
    bullets.forEach(b => { ctx.fillStyle='#ff0'; ctx.fillRect(b.x-player.x+cx-5, b.y-player.y+cy-5, 10, 10); });

    // 4. –ò–≥—Ä–æ–∫
    ctx.fillStyle='rgba(0,0,0,0.4)'; ctx.beginPath(); ctx.ellipse(cx, cy+15, 15, 5, 0, 0, Math.PI*2); ctx.fill();
    ctx.fillStyle=godMode?'gold':'#00d4ff';
    if(player.shape==='rect') ctx.fillRect(cx-15,cy-15,30,30);
    else if(player.shape==='circle'){ ctx.beginPath(); ctx.arc(cx,cy,16,0,Math.PI*2); ctx.fill(); }
    else { ctx.beginPath(); ctx.moveTo(cx,cy-15); ctx.lineTo(cx-15,cy+15); ctx.lineTo(cx+15,cy+15); ctx.fill(); }

    // 5. –í–∏–Ω—å–µ—Ç–∫–∞
    const g = ctx.createRadialGradient(cx, cy, canvas.width/4, cx, cy, canvas.width);
    g.addColorStop(0, 'rgba(0,0,0,0)'); g.addColorStop(1, 'rgba(0,0,0,0.45)'); 
    ctx.fillStyle=g; ctx.fillRect(0,0,canvas.width,canvas.height);

    // 6. UI
    document.getElementById('exp-fill').style.width = (player.exp/player.nextLvl*100)+'%';
    document.getElementById('hp-fill').style.width = (player.hp/player.maxHp*100)+'%';
    document.getElementById('g-ui').innerText = `üí∞ ${Math.floor(persistentGold)}`;
    document.getElementById('t-ui').innerText = formatTime(el);
}

/** --- 7. –í–°–ü–û–ú–û–ì–ê–¢–ï–õ–¨–ù–´–ï –§–£–ù–ö–¶–ò–ò --- **/
function getNear() {
    let n=null, md=850; 
    enemies.forEach(e=>{ let d=Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2); if(d<md){md=d;n=e;} }); 
    return n;
}
function formatTime(s) { 
    return Math.floor(s/60).toString().padStart(2,'0')+":"+(s%60).toString().padStart(2,'0'); 
}
function endGame(t) {
    gameActive=false; 
    if(selectedDiff==='easy') save.timeEasy += t; 
    if(selectedDiff==='normal') save.timeNormal += t;
    saveGame(); 
    alert(`–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê! –°–æ–±—Ä–∞–Ω–æ –∑–æ–ª–æ—Ç–∞: ${Math.floor(player.runG)}`); 
    location.reload();
}

/** --- 8. –£–ü–†–ê–í–õ–ï–ù–ò–ï --- **/
window.addEventListener('resize', () => { canvas.width=window.innerWidth; canvas.height=window.innerHeight; });
document.addEventListener('touchstart', e => { if(!isPaused) joy.active=true; moveJoy(e); });
document.addEventListener('touchmove', e => { if(joy.active){ e.preventDefault(); moveJoy(e); } }, {passive:false});
document.addEventListener('touchend', () => { joy.active=false; document.getElementById('joystick-stick').style.transform='translate(0,0)'; });

function moveJoy(e) {
    const t=e.touches[0], b=document.getElementById('joystick-base').getBoundingClientRect();
    const dx=t.clientX-(b.left+50), dy=t.clientY-(b.top+50);
    const d=Math.min(Math.sqrt(dx*dx+dy*dy), 40), a=Math.atan2(dy,dx);
    joy.x=Math.cos(a)*(d/40); joy.y=Math.sin(a)*(d/40);
    document.getElementById('joystick-stick').style.transform=`translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
}

initBackground(); 
updateUIMenu();
</script>
</body>
</html>
