<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivor.io - Private Edition</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; }
        .hidden { display: none !important; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .top-bar { display: flex; align-items: center; gap: 10px; }
        #exp-bar { flex-grow: 1; height: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; overflow: hidden; }
        #exp-fill { width: 0%; height: 100%; background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
        #timer { font-size: 20px; font-weight: bold; text-align: center; margin-top: 5px; color: #fff; }
        #hp-bar { width: 120px; height: 12px; background: #333; margin-top: 5px; border-radius: 6px; border: 2px solid #000; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; transition: width 0.2s; }
        
        /* Панель создателя (скрыта по умолчанию) */
        #dev-panel { position: absolute; bottom: 10px; right: 10px; z-index: 20; display: none; flex-direction: column; gap: 5px; pointer-events: all; }
        .dev-btn { background: rgba(0,0,0,0.8); border: 1px solid #00d4ff; color: #00d4ff; padding: 8px 12px; border-radius: 5px; font-size: 12px; font-weight: bold; }

        #joystick-container { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; z-index: 5; }
        #joystick-base { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(0,212,255,0.2); display: flex; align-items: center; justify-content: center; }
        #joystick-stick { width: 40px; height: 40px; background: #00d4ff; border-radius: 50%; opacity: 0.6; }
        
        #level-up { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 3px solid #00d4ff; width: 85%; max-width: 400px; text-align: center; }
        .card { background: #2a2a2a; border: 2px solid #444; padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; pointer-events: all; }
    </style>
</head>
<body>

<div id="ui">
    <div class="top-bar">
        <div style="font-weight: bold; color: #00d4ff;">Lvl <span id="lvl">1</span></div>
        <div id="exp-bar"><div id="exp-fill"></div></div>
    </div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div id="timer">00:00</div>
</div>

<div id="dev-panel">
    <div class="dev-btn" onclick="devSkipTime()">+1 МИНУТА</div>
    <div class="dev-btn" onclick="devKillAll()">УБИТЬ ВСЕХ</div>
    <div class="dev-btn" onclick="devLevelUp()">LVL UP</div>
    <div id="god-btn" class="dev-btn" onclick="devGodMode()">БОГ: ВЫКЛ</div>
</div>

<canvas id="game"></canvas>
<div id="joystick-container"><div id="joystick-base"><div id="joystick-stick"></div></div></div>
<div id="level-up" class="hidden"><div class="modal"><h2 style="color: #00d4ff;">ВЫБЕРИ НАВЫК</h2><div id="cards-container"></div></div></div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let gameActive = true, isPaused = false, godMode = false;
    let startTime = Date.now(), timeOffset = 0, lastBossSpawn = 0;

    // ПРОВЕРКА ПАРОЛЯ В URL
    if (window.location.search.includes('ad')) {
        document.getElementById('dev-panel').style.display = 'flex';
    }

    const player = {
        x: 0, y: 0, hp: 100, maxHp: 100, lvl: 1, exp: 0, nextLvl: 100, speed: 3.5,
        skills: { bulletCount: 1, fieldLvl: 0, brickLvl: 0 }
    };

    let enemies = [], bullets = [], bricks = [], crystals = [];
    let stats = { fireRate: 800, lastShot: 0, lastBrick: 0, damage: 15 };

    // Функции создателя
    function devSkipTime() { timeOffset += 60; }
    function devKillAll() { enemies.forEach(e => crystals.push({x: e.x, y: e.y, big: e.boss})); enemies = []; }
    function devLevelUp() { showLevelUp(); }
    function devGodMode() { godMode = !godMode; document.getElementById('god-btn').innerText = "БОГ: " + (godMode ? "ВКЛ" : "ВЫКЛ"); player.hp = player.maxHp; }

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    let joystick = { active: false, x: 0, y: 0 };
    const stick = document.getElementById('joystick-stick'), jBase = document.getElementById('joystick-base');

    function handleInput(e) {
        if(!joystick.active && e.type !== 'touchstart') return;
        const t = e.touches ? e.touches[0] : e;
        const b = jBase.getBoundingClientRect();
        const dx = t.clientX - (b.left + b.width/2), dy = t.clientY - (b.top + b.height/2);
        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
        const a = Math.atan2(dy, dx);
        joystick.x = Math.cos(a) * (d/40); joystick.y = Math.sin(a) * (d/40);
        stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    }

    document.addEventListener('touchstart', e => { joystick.active = true; handleInput(e); });
    document.addEventListener('touchmove', e => { if(joystick.active) { e.preventDefault(); handleInput(e); } }, {passive: false});
    document.addEventListener('touchend', () => { joystick.active = false; stick.style.transform = 'translate(0,0)'; });

    function spawnEnemy() {
        let a = Math.random()*Math.PI*2, dist = 550, type = Math.random();
        let e = { x: player.x+Math.cos(a)*dist, y: player.y+Math.sin(a)*dist, boss: false };
        if (type < 0.15) { e.hp = 150 + player.lvl*20; e.speed = 0.8; e.size = 25; e.color = '#8b0000'; } 
        else if (type < 0.40) { e.hp = 10; e.speed = 3.8; e.size = 10; e.color = '#ff8c00'; } 
        else { e.hp = 30 + player.lvl*5; e.speed = 1.6; e.size = 15; e.color = '#ff4444'; }
        enemies.push(e);
    }

    function update() {
        if(!gameActive || isPaused) return requestAnimationFrame(update);
        let elapsed = Math.floor((Date.now() - startTime) / 1000) + timeOffset;
        let mins = Math.floor(elapsed / 60), secs = elapsed % 60;
        document.getElementById('timer').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;

        if (mins > 0 && mins % 5 === 0 && mins !== lastBossSpawn) {
            enemies.push({x: player.x+400, y: player.y, hp: 3000, boss: true, size: 50, color: '#ff0000', speed: 1});
            lastBossSpawn = mins;
        }

        if(joystick.active) { player.x += joystick.x * player.speed; player.y += joystick.y * player.speed; }

        if(Date.now() - stats.lastShot > stats.fireRate) {
            let near = getNearestEnemy(600);
            if(near) {
                let angle = Math.atan2(near.y - player.y, near.x - player.x);
                for(let i=0; i < player.skills.bulletCount; i++) {
                    let spread = (i - (player.skills.bulletCount-1)/2) * 0.2;
                    bullets.push({x: player.x, y: player.y, vx: Math.cos(angle+spread)*10, vy: Math.sin(angle+spread)*10});
                }
                stats.lastShot = Date.now();
            }
        }

        bullets.forEach((b, bi) => {
            b.x += b.vx; b.y += b.vy;
            enemies.forEach((e, ei) => {
                if(Math.sqrt((b.x-e.x)**2 + (b.y-e.y)**2) < e.size) {
                    e.hp -= stats.damage; bullets.splice(bi, 1);
                    if(e.hp <= 0) { crystals.push({x: e.x, y: e.y, big: e.boss}); enemies.splice(ei, 1); }
                }
            });
            if(Math.abs(b.x-player.x) > 850) bullets.splice(bi, 1);
        });

        if(enemies.length < 30) spawnEnemy();
        enemies.forEach(e => {
            let a = Math.atan2(player.y-e.y, player.x-e.x);
            e.x += Math.cos(a)*e.speed; e.y += Math.sin(a)*e.speed;
            if(Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2) < e.size + 10) {
                if(!godMode) player.hp -= e.boss ? 1.5 : 0.4;
                if(player.hp <= 0) location.reload();
            }
        });

        crystals.forEach((c, i) => {
            if(Math.sqrt((c.x-player.x)**2 + (c.y-player.y)**2) < 45) {
                player.exp += c.big ? 1200 : 40; crystals.splice(i, 1);
                if(player.exp >= player.nextLvl) showLevelUp();
            }
        });

        draw();
        requestAnimationFrame(update);
    }

    function getNearestEnemy(range) {
        let near = null, minD = range;
        enemies.forEach(e => {
            let d = Math.sqrt((e.x-player.x)**2 + (e.y-player.y)**2);
            if(d < minD) { minD = d; near = e; }
        });
        return near;
    }

    function showLevelUp() {
        isPaused = true;
        const cont = document.getElementById('cards-container'); cont.innerHTML = '';
        document.getElementById('level-up').classList.remove('hidden');
        const pool = [
            {n: "СКОРОСТРЕЛЬНОСТЬ", d: "Оружие бьет чаще", f: () => stats.fireRate *= 0.85},
            {n: "СИЛОВОЕ ПОЛЕ", d: "Аура вокруг героя", f: () => player.skills.fieldLvl++},
            {n: "ДОП. ПУЛЯ", d: "+1 снаряд в веере", f: () => player.skills.bulletCount++},
            {n: "РЕГЕНЕРАЦИЯ", d: "Полное здоровье", f: () => player.hp = player.maxHp}
        ];
        pool.sort(()=>0.5-Math.random()).slice(0,3).forEach(o => {
            let d = document.createElement('div'); d.className = 'card';
            d.innerHTML = `<b>${o.n}</b><br><span>${o.d}</span>`;
            d.onclick = () => { o.f(); player.lvl++; player.exp = 0; player.nextLvl *= 1.35; isPaused = false; document.getElementById('level-up').classList.add('hidden'); };
            cont.appendChild(d);
        });
    }

    function draw() {
        ctx.fillStyle = '#0a0d0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
        const cx = canvas.width/2, cy = canvas.height/2;
        ctx.strokeStyle = '#151a15';
        for(let x = -player.x % 100; x < canvas.width; x += 100) { ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke(); }
        for(let y = -player.y % 100; y < canvas.height; y += 100) { ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke(); }

        crystals.forEach(c => { ctx.fillStyle = c.big ? '#ff00ff' : '#00f2ff'; ctx.fillRect(c.x-player.x+cx-4, c.y-player.y+cy-4, c.big ? 15 : 8, c.big ? 15 : 8); });
        enemies.forEach(e => {
            ctx.fillStyle = e.color; ctx.beginPath(); ctx.arc(e.x-player.x+cx, e.y-player.y+cy, e.size, 0, Math.PI*2); ctx.fill();
            if(e.boss) { ctx.fillStyle = '#ffd700'; ctx.fillRect(e.x-player.x+cx-20, e.y-player.y+cy-e.size-20, 40, 10); }
        });
        ctx.fillStyle = '#ffff00'; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x-player.x+cx, b.y-player.y+cy, 5, 0, Math.PI*2); ctx.fill(); });
        if(player.skills.fieldLvl > 0) {
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.2)'; ctx.lineWidth = 2;
            ctx.beginPath(); ctx.arc(cx, cy, 80 + player.skills.fieldLvl*20, 0, Math.PI*2); ctx.stroke();
        }
        ctx.fillStyle = '#ffe0bd'; ctx.beginPath(); ctx.arc(cx, cy-18, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = godMode ? '#ffd700' : '#0066ff'; ctx.fillRect(cx-8, cy-8, 16, 20);
        document.getElementById('lvl').innerText = player.lvl;
        document.getElementById('exp-fill').style.width = (player.exp/player.nextLvl*100)+'%';
        document.getElementById('hp-fill').style.width = (player.hp/player.maxHp*100)+'%';
    }
    requestAnimationFrame(update);
</script>
</body>
</html>
