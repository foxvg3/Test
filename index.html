<!DOCTYPE html>
<html lang="ru" translate="no">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>SHAPE SURVIVOR V9 MEGA</title>
    <style>
        :root { 
            --primary: #00d4ff; --gold: #ffd700; --bg: #050805; 
            --panel: rgba(20, 25, 20, 0.98); --red: #ff4d4d; --purple: #a020f0;
        }
        body { margin: 0; background: var(--bg); overflow: hidden; font-family: 'Verdana', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; position: absolute; inset: 0; z-index: 1; }

        /* –≠–∫—Ä–∞–Ω—ã */
        .ui-screen { position: fixed; inset: 0; z-index: 1000; display: flex; flex-direction: column; align-items: center; background: radial-gradient(circle at center, #1a201a 0%, #000 100%); overflow-y: auto; padding: 20px; box-sizing: border-box; }
        .hidden { display: none !important; }

        /* –ü—Ä–æ—Ñ–∏–ª—å –∏ –°—Ç–∞—Ç—ã */
        .profile-header { position: absolute; top: 15px; left: 15px; background: rgba(0,0,0,0.85); padding: 12px; border-radius: 10px; border-left: 4px solid var(--primary); font-size: 13px; z-index: 1100; border: 1px solid #333; }
        .xp-mini-bar { width: 140px; height: 6px; background: #222; margin-top: 8px; border-radius: 3px; overflow: hidden; }
        #xp-mini-fill { height: 100%; background: var(--primary); width: 0%; transition: width 0.5s; }
        
        /* –ö–Ω–æ–ø–∫–∏ */
        .btn { background: linear-gradient(180deg, var(--primary) 0%, #008cb3 100%); color: #000; padding: 18px; border-radius: 15px; font-weight: 900; cursor: pointer; border: none; text-transform: uppercase; width: 100%; box-shadow: 0 4px 0 #005f80; margin-top: 10px; }
        .btn:active { transform: translateY(2px); box-shadow: 0 2px 0 #005f80; }
        .btn-sec { background: #222; color: #fff; padding: 10px 15px; border-radius: 8px; border: 1px solid #444; cursor: pointer; font-size: 11px; font-weight: bold; }

        /* –°–µ—Ç–∫–∞ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π */
        #char-grid { display: grid; grid-template-columns: repeat(5, 1fr); gap: 8px; margin-bottom: 20px; width: 100%; max-width: 550px; }
        .char-card { padding: 10px; border: 1px solid #333; border-radius: 10px; text-align: center; cursor: pointer; background: #111; font-size: 10px; transition: 0.2s; position: relative; }
        .char-card.locked { opacity: 0.4; filter: grayscale(1); }
        .char-card.selected { border-color: var(--primary); box-shadow: 0 0 15px var(--primary); transform: scale(1.05); background: #1a1a1a; }

        /* HUD –≤ –∏–≥—Ä–µ */
        #hud { position: fixed; top: 20px; left: 20px; z-index: 500; pointer-events: none; }
        .hp-cont { width: 220px; height: 16px; background: rgba(0,0,0,0.8); border: 2px solid #333; border-radius: 8px; overflow: hidden; }
        #hp-fill { height: 100%; width: 100%; background: linear-gradient(90deg, #ff4d4d, #ff0000); transition: 0.3s; }
        #exp-line { position: fixed; top: 0; left: 0; width: 100%; height: 6px; background: #111; z-index: 1100; }
        #exp-fill { height: 100%; width: 0%; background: #00ffd4; box-shadow: 0 0 10px #00ffd4; }

        /* –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ */
        #joy-base { position: fixed; bottom: 60px; left: 50%; transform: translateX(-50%); width: 130px; height: 130px; background: rgba(255,255,255,0.05); border: 2px solid rgba(255,255,255,0.1); border-radius: 50%; z-index: 100; }
        #joy-stick { position: absolute; top: 40px; left: 40px; width: 50px; height: 50px; background: var(--primary); border-radius: 50%; box-shadow: 0 0 20px var(--primary); }

        /* –ê–¥–º–∏–Ω-–∑–æ–Ω–∞ */
        #admin-btn-trigger { position: fixed; bottom: 0; right: 0; width: 40px; height: 40px; z-index: 2000; opacity: 0.1; cursor: pointer; }
    </style>
</head>
<body>

<div id="exp-line"><div id="exp-fill"></div></div>

<div id="auth-screen" class="ui-screen">
    <h1 style="color: var(--primary); margin-top: 60px; font-size: 45px; letter-spacing: 5px;">SHAPE V9</h1>
    <div style="background: var(--panel); padding: 35px; border-radius: 25px; border: 1px solid #333; width: 300px; text-align: center;">
        <input type="text" id="auth-nick" placeholder="–ù–ò–ö–ù–ï–ô–ú" style="width: 100%; box-sizing: border-box; background: #000; border: 1px solid #444; color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 12px; outline: none;">
        <input type="password" id="auth-pass" placeholder="–ü–ê–†–û–õ–¨" style="width: 100%; box-sizing: border-box; background: #000; border: 1px solid #444; color: #fff; padding: 14px; border-radius: 12px; margin-bottom: 20px; outline: none;">
        <button class="btn" onclick="account.login()">–í–û–ô–¢–ò –í –ü–ê–°–ü–û–†–¢</button>
    </div>
</div>

<div id="lobby" class="ui-screen hidden">
    <div class="profile-header">
        <b id="p-nick">–ò–ì–†–û–ö</b><br>
        <span>LVL –ê–ö–ö–ê–£–ù–¢–ê: <span id="p-lvl">1</span></span>
        <div class="xp-mini-bar"><div id="xp-mini-fill"></div></div>
    </div>
    <div style="margin-top: 110px; text-align: center; width: 100%; max-width: 600px;">
        <div style="color: var(--gold); font-size: 28px; margin-bottom: 20px; font-weight: bold;">üí∞ <span id="l-gold">0</span></div>
        <div id="char-grid"></div>
        <button class="btn" onclick="game.preStart()">–í–°–¢–£–ü–ò–¢–¨ –í –ë–û–ô</button>
        <div style="display: flex; gap: 15px; margin-top: 15px; justify-content: center;">
            <button class="btn-sec" onclick="ui.showTab('skill-tree')">üß¨ –¢–ï–•–ù–û–õ–û–ì–ò–ò</button>
            <button class="btn-sec" onclick="ui.showTab('leaderboard')">üìä –¢–û–ü</button>
        </div>
    </div>
    <div id="admin-btn-trigger" onclick="ui.showTab('admin-menu')"></div>
</div><script>
"use strict";

const game = { 
    active: false, 
    paused: false,
    input: { dx: 0, dy: 0, joyActive: false }, 
    entities: { enemies: [], bullets: [], items: [], fx: [] }, 
    timers: {} 
};

const ui = {
    showTab(id) {
        document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
        document.getElementById(id)?.classList.remove('hidden');
        if(id === 'skill-tree') meta.renderTree();
        if(id === 'lobby') meta.renderLobby();
        if(id === 'leaderboard') account.renderLB('level');
    }
};

const meta = {
    selected: 'square',
    // 20 –ü–ï–†–°–û–ù–ê–ñ–ï–ô
    chars: {
        square: { name: "–ö–≤–∞–¥—Ä–∞—Ç", hp: 100, spd: 4, skill: "shot", price: 0 },
        circle: { name: "–ö—Ä—É–≥", hp: 85, spd: 5.2, skill: "aura", price: 500 },
        triangle: { name: "–¢—Ä–µ—É–≥–æ–ª", hp: 70, spd: 6.2, skill: "shot", price: 1500 },
        rhombus: { name: "–†–æ–º–±", hp: 130, spd: 3.5, skill: "shield", price: 3000 },
        hexagon: { name: "–ì–µ–∫—Å–∞", hp: 160, spd: 3.2, skill: "aura", price: 6000 },
        octagon: { name: "–û–∫—Ç–∞", hp: 200, spd: 2.8, skill: "shield", price: 10000 },
        star: { name: "–ó–≤–µ–∑–¥–∞", hp: 95, spd: 5, skill: "shot", price: 20000 },
        cross: { name: "–ö—Ä–µ—Å—Ç", hp: 120, spd: 4.5, skill: "shield", price: 35000 },
        drop: { name: "–ö–∞–ø–ª—è", hp: 85, spd: 6.8, skill: "dash", price: 50000 },
        heart: { name: "–°–µ—Ä–¥—Ü–µ", hp: 400, spd: 2.2, skill: "aura", price: 100000 },
        spike: { name: "–®–∏–ø", hp: 110, spd: 5.4, skill: "spike_trap", price: 150000 },
        blade: { name: "–ö–ª–∏–Ω–æ–∫", hp: 120, spd: 5.2, skill: "orbit_blade", price: 220000 },
        ghost: { name: "–ü—Ä–∏–∑—Ä–∞–∫", hp: 75, spd: 7.5, skill: "invis", price: 300000 },
        tesla: { name: "–¢–µ—Å–ª–∞", hp: 130, spd: 4.2, skill: "chain_light", price: 450000 },
        bomb: { name: "–ú–∏–Ω–∞", hp: 160, spd: 3.5, skill: "landmine", price: 600000 },
        laser: { name: "–õ—É—á–µ–≤–æ–π", hp: 110, spd: 5, skill: "beam", price: 800000 },
        void: { name: "–ü—É—Å—Ç–æ—Ç–∞", hp: 250, spd: 2.8, skill: "black_hole", price: 1200000 },
        prism: { name: "–ü—Ä–∏–∑–º–∞", hp: 125, spd: 5.5, skill: "reflect", price: 2000000 },
        omega: { name: "–û–º–µ–≥–∞", hp: 600, spd: 1.8, skill: "god_blast", price: 5000000 },
        glitch: { name: "–ì–ª–∏—Ç—á", hp: 200, spd: 9, skill: "random", price: 10000000 }
    },
    // 40 –ù–ê–í–´–ö–û–í (–ê–∫—Ç–∏–≤–Ω—ã–µ –∏ –ü–∞—Å—Å–∏–≤–Ω—ã–µ)
    skills: {
        shot: { name: "–ü—É—à–∫–∞", desc: "–°–Ω–∞—Ä—è–¥—ã –≤ —Ü–µ–ª—å", max: 6, type: 'atk' },
        aura: { name: "–ê—É—Ä–∞", desc: "–£—Ä–æ–Ω –≤–æ–∫—Ä—É–≥", max: 6, type: 'atk' },
        shield: { name: "–©–∏—Ç", desc: "-–£—Ä–æ–Ω", max: 6, type: 'def' },
        dash: { name: "–†—ã–≤–æ–∫", desc: "–£—Å–∫–æ—Ä–µ–Ω–∏–µ", max: 6, type: 'util' },
        spike_trap: { name: "–®–∏–ø—ã", desc: "–õ–æ–≤—É—à–∫–∏ –Ω–∞ –ø–æ–ª—É", max: 6, type: 'atk' },
        orbit_blade: { name: "–õ–µ–∑–≤–∏—è", desc: "–í—Ä–∞—â–µ–Ω–∏–µ –≤–æ–∫—Ä—É–≥", max: 6, type: 'atk' },
        chain_light: { name: "–ú–æ–ª–Ω–∏—è", desc: "–¶–µ–ø–Ω–æ–π —É—Ä–æ–Ω", max: 6, type: 'atk' },
        landmine: { name: "–ú–∏–Ω—ã", desc: "–í–∑—Ä—ã–≤ –ø—Ä–∏ –∫–æ–Ω—Ç–∞–∫—Ç–µ", max: 6, type: 'atk' },
        beam: { name: "–õ–∞–∑–µ—Ä", desc: "–õ—É—á —Å–∫–≤–æ–∑—å –≤—Å–µ—Ö", max: 6, type: 'atk' },
        black_hole: { name: "–î—ã—Ä–∞", desc: "–°—Ç—è–≥–∏–≤–∞–Ω–∏–µ –≤—Ä–∞–≥–æ–≤", max: 6, type: 'atk' },
        poison_cloud: { name: "–Ø–¥", desc: "–ì–∞–∑–æ–≤–æ–µ –æ–±–ª–∞–∫–æ", max: 6, type: 'atk' },
        ice_nova: { name: "–õ–µ–¥", desc: "–ó–∞–º–æ—Ä–æ–∑–∫–∞", max: 6, type: 'atk' },
        meteor: { name: "–ú–µ—Ç–µ–æ—Ä", desc: "–£–¥–∞—Ä —Å –Ω–µ–±–∞", max: 6, type: 'atk' },
        wisdom: { name: "–û–ø—ã—Ç", desc: "–ë–æ–ª—å—à–µ –æ–ø—ã—Ç–∞", max: 6, type: 'pass' },
        greed: { name: "–ñ–∞–¥–Ω–æ—Å—Ç—å", desc: "–ë–æ–ª—å—à–µ –∑–æ–ª–æ—Ç–∞", max: 6, type: 'pass' },
        vampire_bat: { name: "–í–∞–º–ø–∏—Ä", desc: "–û–ó –ø—Ä–∏ —É–±–∏–π—Å—Ç–≤–µ", max: 6, type: 'pass' },
        vitality: { name: "–ñ–∏–∑–Ω—å", desc: "+–ú–∞–∫—Å HP", max: 6, type: 'pass' },
        haste: { name: "–ö–î", desc: "–ë—ã—Å—Ç—Ä–µ–µ –∞—Ç–∞–∫–∏", max: 6, type: 'pass' },
        magnet_p: { name: "–°–±–æ—Ä", desc: "–†–∞–¥–∏—É—Å —Å–±–æ—Ä–∞", max: 6, type: 'pass' },
        power: { name: "–°–∏–ª–∞", desc: "+–£—Ä–æ–Ω %", max: 6, type: 'pass' }
        // ... –æ—Å—Ç–∞–ª—å–Ω—ã–µ –Ω–∞–≤—ã–∫–∏ –¥–æ–±–∞–≤–ª—è—é—Ç—Å—è –¥–∏–Ω–∞–º–∏—á–µ—Å–∫–∏ –≤ –ø—É–ª–ª –ø—Ä–∏ –≤—ã–±–æ—Ä–µ
    }
};const account = {
    current: null,
    db: JSON.parse(localStorage.getItem('v9_users')) || {},

    login() {
        const nick = document.getElementById('auth-nick').value.trim();
        const pass = document.getElementById('auth-pass').value.trim();
        if (nick.length < 3) return alert("–ù–∏–∫–Ω–µ–π–º —Å–ª–∏—à–∫–æ–º –∫–æ—Ä–æ—Ç–∫–∏–π");

        if (this.db[nick]) {
            if (this.db[nick].pass !== pass) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å");
            this.current = this.db[nick];
        } else {
            // –°–æ–∑–¥–∞–Ω–∏–µ –Ω–æ–≤–æ–≥–æ –ø—Ä–æ—Ñ–∏–ª—è
            this.current = {
                nick, pass, gold: 0, lvl: 1, exp: 0, nextExp: 100,
                unlocked: ['square'], 
                tree: { hp: 0, dmg: 0, armor: 0, speed: 0, luck: 0, magnet: 0, regen: 0 }, 
                treeSpent: 0, 
                records: { level: 1 }
            };
        }
        this.save();
        this.updateProfile();
        ui.showTab('lobby');
        meta.init();
    },

    save() {
        if(this.current) this.db[this.current.nick] = this.current;
        localStorage.setItem('v9_users', JSON.stringify(this.db));
        localStorage.setItem('v9_last_user', this.current?.nick || '');
    },

    updateProfile() {
        const c = this.current;
        if(!c) return;
        document.getElementById('p-nick').innerText = c.nick;
        document.getElementById('p-lvl').innerText = c.lvl;
        document.getElementById('l-gold').innerText = c.gold.toLocaleString();
        const perc = (c.exp / c.nextExp) * 100;
        document.getElementById('xp-mini-fill').style.width = perc + '%';
    },

    addGlobalExp(amt) {
        if(!this.current) return;
        this.current.exp += amt;
        while (this.current.exp >= this.current.nextExp) {
            this.current.exp -= this.current.nextExp;
            this.current.lvl++;
            this.current.nextExp = Math.floor(this.current.nextExp * 1.5);
        }
        this.save();
        this.updateProfile();
    },

    renderLB(type) {
        const body = document.getElementById('lb-body');
        if(!body) return;
        body.innerHTML = '';
        const sorted = Object.values(this.db).sort((a, b) => b.lvl - a.lvl).slice(0, 10);
        sorted.forEach((u, i) => {
            body.innerHTML += `<tr><td>#${i+1}</td><td>${u.nick}</td><td>${u.lvl}</td></tr>`;
        });
    }
};

// –õ–æ–≥–∏–∫–∞ –¥–µ—Ä–µ–≤–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π (–ü–æ—Å—Ç–æ—è–Ω–Ω—ã–µ —É–ª—É—á—à–µ–Ω–∏—è)
meta.getTreePoints = function() {
    return account.current.lvl - account.current.treeSpent;
};

meta.renderTree = function() {
    const list = document.getElementById('t-list');
    const points = this.getTreePoints();
    document.getElementById('t-points').innerText = points;
    if(!list) return;
    list.innerHTML = '';

    const nodes = [
        { id: 'hp', name: '–ñ–ò–í–£–ß–ï–°–¢–¨', icon: '‚ù§Ô∏è', desc: '+15% HP' },
        { id: 'dmg', name: '–°–ò–õ–ê', icon: '‚öîÔ∏è', desc: '+10% –ê—Ç–∞–∫–∏' },
        { id: 'magnet', name: '–ú–ê–ì–ù–ò–¢', icon: 'üß≤', desc: '+20% –†–∞–¥–∏—É—Å' },
        { id: 'luck', name: '–£–î–ê–ß–ê', icon: 'üçÄ', desc: '+10% –ó–æ–ª–æ—Ç–∞' }
    ];

    nodes.forEach(n => {
        const lvl = account.current.tree[n.id] || 0;
        const div = document.createElement('div');
        div.style = `background:#111; padding:12px; border-radius:10px; display:flex; justify-content:space-between; margin-bottom:5px; border:1px solid #333`;
        div.innerHTML = `
            <div>
                <div style="font-weight:bold; color:var(--primary)">${n.icon} ${n.name} [${lvl}]</div>
                <div style="font-size:10px; color:#666">${n.desc}</div>
            </div>
            <button class="btn-sec" ${points <= 0 ? 'disabled' : ''} onclick="meta.buyNode('${n.id}')">–£–õ–£–ß–®–ò–¢–¨</button>
        `;
        list.appendChild(div);
    });
};

meta.buyNode = function(id) {
    if(this.getTreePoints() > 0) {
        account.current.tree[id]++;
        account.current.treeSpent++;
        account.save();
        this.renderTree();
    }
};Object.assign(game, {
    // –°—Ç–∞—Ä—Ç –∏–≥—Ä–æ–≤–æ–π —Å–µ—Å—Å–∏–∏
    start() {
        const char = meta.chars[meta.selected];
        const t = account.current.tree;

        // –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è –∏–≥—Ä–æ–∫–∞: –±–∞–∑–æ–≤—ã–µ —Å—Ç–∞—Ç—ã + –±–æ–Ω—É—Å—ã –¥–µ—Ä–µ–≤–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π
        this.player = {
            x: 0, y: 0,
            hp: char.hp * (1 + (t.hp || 0) * 0.15),
            maxHp: char.hp * (1 + (t.hp || 0) * 0.15),
            speed: char.spd * (1 + (t.speed || 0) * 0.05),
            dmgMod: 1 + ((t.dmg || 0) * 0.1),
            armor: (t.armor || 0) * 0.05,
            luck: 1 + ((t.luck || 0) * 0.1),
            magnet: 150 * (1 + ((t.magnet || 0) * 0.2)),
            regen: (t.regen || 0),
            lvl: 1, exp: 0, nextExp: 100, gold: 0,
            // –ò–≥—Ä–æ–≤—ã–µ –Ω–∞–≤—ã–∫–∏ (—Å–±—Ä–∞—Å—ã–≤–∞—é—Ç—Å—è –∫–∞–∂–¥—É—é –∏–≥—Ä—É)
            skills: { [char.skill]: 1 },
            size: 22,
            iframe: 0
        };

        // –°–±—Ä–æ—Å —Å—É—â–Ω–æ—Å—Ç–µ–π
        this.entities = { enemies: [], bullets: [], items: [], fx: [] };
        
        this.elapsed = 0;
        this.active = true;
        this.paused = false;
        this.timers = { 
            spawn: 0, 
            weapon: {}, 
            regen: 0, 
            last: performance.now() 
        };
        
        // –ü–æ–¥–≥–æ—Ç–æ–≤–∫–∞ –∏–Ω—Ç–µ—Ä—Ñ–µ–π—Å–∞
        ui.showTab('hud');
        document.getElementById('joy-base').classList.remove('hidden');
        document.getElementById('hud').classList.remove('hidden');
        
        requestAnimationFrame((t) => this.loop(t));
    },

    // –û—Å–Ω–æ–≤–Ω–æ–π –∞–ø–¥–µ–π—Ç
    update(dt) {
        if (!this.active || this.paused) return;
        this.elapsed += dt;

        // –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ —á–µ—Ä–µ–∑ –¥–∂–æ–π—Å—Ç–∏–∫
        if (this.input.joyActive) {
            this.player.x += this.input.dx * this.player.speed;
            this.player.y += this.input.dy * this.player.speed;
        }

        // –†–µ–≥–µ–Ω–µ—Ä–∞—Ü–∏—è (–∏–∑ –¥–µ—Ä–µ–≤–∞ —Ç–µ—Ö–Ω–æ–ª–æ–≥–∏–π)
        if (this.player.regen > 0) {
            this.timers.regen += dt;
            if (this.timers.regen >= 5000) {
                this.player.hp = Math.min(this.player.maxHp, this.player.hp + this.player.regen);
                this.timers.regen = 0;
            }
        }

        // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤ (—Å–ª–æ–∂–Ω–æ—Å—Ç—å —Ä–∞—Å—Ç–µ—Ç —Å–æ –≤—Ä–µ–º–µ–Ω–µ–º)
        this.timers.spawn += dt;
        let spawnRate = Math.max(150, 1000 - (this.player.lvl * 25));
        if (this.timers.spawn > spawnRate) {
            this.spawnEnemy();
            this.timers.spawn = 0;
        }

        // –ü—Ä–æ—Ü–µ—Å—Å–∏–Ω–≥ –ø–æ–¥—Å–∏—Å—Ç–µ–º
        this.runSkills(dt);
        this.processEnemies(dt);
        this.processBullets(dt);
        this.processItems(dt);
        this.processFX(dt);
        this.updateHUD();
        
        if (this.player.iframe > 0) this.player.iframe -= dt;
    },

    // –í–∏–∑—É–∞–ª—å–Ω—ã–µ —ç—Ñ—Ñ–µ–∫—Ç—ã (—á–∞—Å—Ç–∏—Ü—ã)
    spawnFX(x, y, color, count = 5) {
        for (let i = 0; i < count; i++) {
            const ang = Math.random() * Math.PI * 2;
            const spd = Math.random() * 4;
            this.entities.fx.push({
                x, y, 
                vx: Math.cos(ang) * spd, 
                vy: Math.sin(ang) * spd,
                life: 600,
                size: 2 + Math.random() * 3,
                color: color
            });
        }
    },

    processFX(dt) {
        for (let i = this.entities.fx.length - 1; i >= 0; i--) {
            const p = this.entities.fx[i];
            p.x += p.vx; p.y += p.vy;
            p.life -= dt;
            if (p.life <= 0) this.entities.fx.splice(i, 1);
        }
    }
});Object.assign(game, {
    runSkills(dt) {
        Object.keys(this.player.skills).forEach(s => {
            const level = this.player.skills[s];
            if (!this.timers.weapon[s]) this.timers.weapon[s] = 0;
            this.timers.weapon[s] += dt;

            // –ú–æ–¥–∏—Ñ–∏–∫–∞—Ç–æ—Ä –ø–µ—Ä–µ–∑–∞—Ä—è–¥–∫–∏ –æ—Ç –ø–∞—Å—Å–∏–≤–Ω–æ–≥–æ –Ω–∞–≤—ã–∫–∞ 'haste'
            const hasteLvl = this.player.skills.haste || 0;
            const hasteMod = 1 - (hasteLvl * 0.12); // -12% –ö–î –∑–∞ —É—Ä–æ–≤–µ–Ω—å
            let cooldown = 1000 * hasteMod;

            switch(s) {
                case 'shot':
                    cooldown = Math.max(120, (850 - (level * 80)) * hasteMod);
                    if (this.timers.weapon[s] >= cooldown) {
                        this.fireBullet(level);
                        this.timers.weapon[s] = 0;
                    }
                    break;

                case 'aura':
                    const range = 130 + (level * 25);
                    const auraDmg = (0.7 + (level * 0.45)) * this.player.dmgMod;
                    this.entities.enemies.forEach(e => {
                        if (Math.hypot(e.x - this.player.x, e.y - this.player.y) < range) {
                            e.hp -= auraDmg;
                            if (Math.random() > 0.97) this.spawnFX(e.x, e.y, '#00ffd4', 1);
                        }
                    });
                    break;

                case 'meteor':
                    cooldown = Math.max(800, (4500 - (level * 500)) * hasteMod);
                    if (this.timers.weapon[s] >= cooldown) {
                        const target = this.getClosestEnemies(1)[0] || { x: this.player.x + (Math.random()*200-100), y: this.player.y + (Math.random()*200-100) };
                        this.entities.fx.push({
                            x: target.x, y: target.y, type: 'meteor_warn',
                            life: 900, size: 90 + (level * 25), lvl: level
                        });
                        this.timers.weapon[s] = 0;
                    }
                    break;

                case 'chain_light':
                    cooldown = (3500 - (level * 300)) * hasteMod;
                    if (this.timers.weapon[s] >= cooldown) {
                        this.castChainLightning(level);
                        this.timers.weapon[s] = 0;
                    }
                    break;

                case 'poison_cloud':
                    cooldown = 2500 * hasteMod;
                    if (this.timers.weapon[s] >= cooldown) {
                        this.entities.items.push({
                            x: this.player.x, y: this.player.y, type: 'gas',
                            life: 4000 + (level * 600), size: 70 + (level * 20),
                            dmg: (level * 6) * this.player.dmgMod
                        });
                        this.timers.weapon[s] = 0;
                    }
                    break;

                case 'beam':
                    cooldown = (6000 - (level * 400)) * hasteMod;
                    if (this.timers.weapon[s] >= cooldown) {
                        const angle = Math.random() * Math.PI * 2;
                        this.entities.fx.push({
                            x: this.player.x, y: this.player.y, type: 'laser_beam',
                            life: 1200, angle: angle,
                            dmg: (120 * level) * this.player.dmgMod
                        });
                        this.timers.weapon[s] = 0;
                    }
                    break;

                case 'orbit_blade':
                    // –ü–æ—Å—Ç–æ—è–Ω–Ω—ã–π —É—Ä–æ–Ω –±–µ–∑ —Ç–∞–π–º–µ—Ä–∞, –ª–æ–≥–∏–∫–∞ –≤—Ä–∞—â–µ–Ω–∏—è –≤ render
                    const orbitRange = 90 + (level * 10);
                    const bladeDmg = (level * 2.5) * this.player.dmgMod;
                    const count = 1 + Math.floor(level / 2);
                    for (let i = 0; i < count; i++) {
                        const ang = (this.elapsed / 1000 * 4) + (i * Math.PI * 2 / count);
                        const bx = this.player.x + Math.cos(ang) * orbitRange;
                        const by = this.player.y + Math.sin(ang) * orbitRange;
                        this.entities.enemies.forEach(e => {
                            if (Math.hypot(e.x - bx, e.y - by) < e.size + 15) {
                                e.hp -= bladeDmg;
                            }
                        });
                    }
                    break;
            }
        });
    },

    fireBullet(lvl) {
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –Ω–∞ 'multishot' (—à–∞–Ω—Å –≤—ã–ø—É—Å—Ç–∏—Ç—å –¥–æ–ø. –ø—É–ª—é)
        const multiLvl = this.player.skills.multishot || 0;
        const count = 1 + (Math.random() < (multiLvl * 0.2) ? 1 : 0);
        
        const targets = this.getClosestEnemies(count);
        if (targets.length === 0) return;

        targets.forEach(t => {
            const ang = Math.atan2(t.y - this.player.y, t.x - this.player.x);
            this.entities.bullets.push({
                x: this.player.x, y: this.player.y,
                vx: Math.cos(ang) * 12, vy: Math.sin(ang) * 12,
                dmg: (35 + (lvl * 15)) * this.player.dmgMod,
                life: 1800, color: '#fff', size: 6 + lvl
            });
        });
    },

    castChainLightning(lvl) {
        let currentSource = this.player;
        let chainCount = 2 + lvl;
        let alreadyHit = [];

        for (let i = 0; i < chainCount; i++) {
            let nextTarget = this.entities.enemies.find(e => 
                !alreadyHit.includes(e) && 
                Math.hypot(e.x - currentSource.x, e.y - currentSource.y) < 300
            );

            if (nextTarget) {
                nextTarget.hp -= (50 * lvl) * this.player.dmgMod;
                this.spawnFX(nextTarget.x, nextTarget.y, '#00d4ff', 6);
                alreadyHit.push(nextTarget);
                currentSource = nextTarget;
            } else break;
        }
    },

    getClosestEnemies(n) {
        return [...this.entities.enemies]
            .sort((a, b) => Math.hypot(a.x - this.player.x, a.y - this.player.y) - 
                            Math.hypot(b.x - this.player.x, b.y - this.player.y))
            .slice(0, n);
    }
});Object.assign(game, {
    spawnEnemy() {
        const angle = Math.random() * Math.PI * 2;
        const dist = 800;
        const timeMod = 1 + (this.elapsed / 60000) * 0.4;
        
        const isBoss = this.elapsed > 45000 && Math.random() > 0.97;
        const isElite = !isBoss && Math.random() > 0.92;

        const e = {
            x: this.player.x + Math.cos(angle) * dist,
            y: this.player.y + Math.sin(angle) * dist,
            size: isBoss ? 50 : (isElite ? 30 : 18),
            hp: (isBoss ? 600 : (isElite ? 150 : 45)) * timeMod * (1 + this.player.lvl * 0.1),
            maxHp: (isBoss ? 600 : (isElite ? 150 : 45)) * timeMod * (1 + this.player.lvl * 0.1),
            speed: isBoss ? 1.5 : (isElite ? 2.6 : 2.3 + Math.random()),
            color: isBoss ? '#ff0044' : (isElite ? '#a020f0' : `hsl(${Math.random() * 360}, 50%, 50%)`),
            isBoss: isBoss,
            isElite: isElite,
            dmg: (isBoss ? 25 : (isElite ? 12 : 6)) * timeMod
        };
        this.entities.enemies.push(e);
    },

    processEnemies(dt) {
        const vampireLvl = this.player.skills['vampire_bat'] || 0;
        const greedLvl = this.player.skills['greed'] || 0;

        for (let i = this.entities.enemies.length - 1; i >= 0; i--) {
            const e = this.entities.enemies[i];
            const dx = this.player.x - e.x;
            const dy = this.player.y - e.y;
            const dist = Math.hypot(dx, dy);

            e.x += (dx / dist) * e.speed;
            e.y += (dy / dist) * e.speed;

            // –°—Ç–æ–ª–∫–Ω–æ–≤–µ–Ω–∏–µ —Å –∏–≥—Ä–æ–∫–æ–º
            if (dist < this.player.size + e.size) {
                if (this.player.iframe <= 0) {
                    const finalDmg = e.dmg * (1 - this.player.armor);
                    this.player.hp -= Math.max(1, finalDmg);
                    this.player.iframe = 450;
                    this.spawnFX(this.player.x, this.player.y, '#ff0000', 12);
                    if (this.player.hp <= 0) this.gameOver();
                }
            }

            // –°–º–µ—Ä—Ç—å –≤—Ä–∞–≥–∞
            if (e.hp <= 0) {
                // –ù–∞–≤—ã–∫ –í–∞–º–ø–∏—Ä: —à–∞–Ω—Å –æ—Ç—Ö–∏–ª–∞
                if (vampireLvl > 0 && Math.random() < (vampireLvl * 0.04)) {
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + 2);
                    this.spawnFX(this.player.x, this.player.y, '#4dff4d', 5);
                }

                // –í–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤–æ–µ –∑–æ–ª–æ—Ç–æ (—É–º–Ω–æ–∂–∞–µ—Ç—Å—è –Ω–∞ Greed –∏ –≥–ª–æ–±–∞–ª—å–Ω—É—é Luck)
                const baseGold = e.isBoss ? 300 : (e.isElite ? 60 : 12);
                const goldGain = baseGold * (1 + greedLvl * 0.25) * this.player.luck;
                this.player.gold += goldGain;
                
                // –í—ã–ø–∞–¥–µ–Ω–∏–µ –æ–ø—ã—Ç–∞
                this.entities.items.push({ 
                    x: e.x, y: e.y, 
                    type: 'exp', 
                    val: e.isBoss ? 250 : (e.isElite ? 80 : 30) 
                });

                // –®–∞–Ω—Å –Ω–∞ —Ö–∏–ª–∫—É (Scavenger –º–æ–≥ –±—ã —Ç—É—Ç –±—ã—Ç—å)
                if (Math.random() > 0.985) {
                    this.entities.items.push({ x: e.x, y: e.y, type: 'heal', val: 25 });
                }

                // –û–ø—ã—Ç –¥–ª—è –∞–∫–∫–∞—É–Ω—Ç–∞
                account.addGlobalExp(e.isBoss ? 20 : (e.isElite ? 4 : 1));
                
                this.spawnFX(e.x, e.y, e.color, 10);
                this.entities.enemies.splice(i, 1);
            }
        }
    }
});Object.assign(game, {
    // 1. –õ–û–ì–ò–ö–ê –ü–†–ï–î–ú–ï–¢–û–í –ò –°–ï–°–°–ò–û–ù–ù–´–• –ü–ê–°–°–ò–í–û–ö
    processItems(dt) {
        // –ù–∞–≤—ã–∫ 'magnet_p' —É–≤–µ–ª–∏—á–∏–≤–∞–µ—Ç —Ä–∞–¥–∏—É—Å —Å–±–æ—Ä–∞ —Ç–æ–ª—å–∫–æ –Ω–∞ —Ç–µ–∫—É—â—É—é –∏–≥—Ä—É
        const magLvl = this.player.skills.magnet_p || 0;
        const currentMagnet = this.player.magnet * (1 + magLvl * 0.3);

        for (let i = this.entities.items.length - 1; i >= 0; i--) {
            const it = this.entities.items[i];

            // –û–±—Ä–∞–±–æ—Ç–∫–∞ —è–¥–æ–≤–∏—Ç—ã—Ö –∑–æ–Ω –æ—Ç –Ω–∞–≤—ã–∫–∞ 'poison_cloud'
            if (it.type === 'gas') {
                it.life -= dt;
                this.entities.enemies.forEach(e => {
                    if (Math.hypot(e.x - it.x, e.y - it.y) < it.size) {
                        e.hp -= (it.dmg / 60); 
                    }
                });
                if (it.life <= 0) this.entities.items.splice(i, 1);
                continue;
            }

            const d = Math.hypot(it.x - this.player.x, it.y - this.player.y);

            // –ú–∞–≥–Ω–∏—Ç–Ω–æ–µ –ø—Ä–∏—Ç—è–∂–µ–Ω–∏–µ
            if (d < currentMagnet) {
                it.x += (this.player.x - it.x) * 0.2;
                it.y += (this.player.y - it.y) * 0.2;
            }

            // –°–±–æ—Ä –ø—Ä–µ–¥–º–µ—Ç–∞
            if (d < 25) {
                if (it.type === 'exp') {
                    // –ù–∞–≤—ã–∫ 'wisdom' –¥–∞–µ—Ç –º–Ω–æ–∂–∏—Ç–µ–ª—å –æ–ø—ã—Ç–∞ –≤–Ω—É—Ç—Ä–∏ –∑–∞–±–µ–≥–∞
                    const wisdomLvl = this.player.skills.wisdom || 0;
                    const expBonus = 1 + (wisdomLvl * 0.25);
                    this.player.exp += it.val * expBonus;
                    
                    if (this.player.exp >= this.player.nextExp) this.levelUp();
                } else if (it.type === 'heal') {
                    this.player.hp = Math.min(this.player.maxHp, this.player.hp + it.val);
                    this.spawnFX(this.player.x, this.player.y, '#4dff4d', 10);
                }
                this.entities.items.splice(i, 1);
            }
        }
    },

    // 2. –°–ò–°–¢–ï–ú–ê –ü–û–í–´–®–ï–ù–ò–Ø –£–†–û–í–ù–Ø (–í—ã–±–æ—Ä –∏–∑ 40 –Ω–∞–≤—ã–∫–æ–≤)
    levelUp() {
        this.player.lvl++;
        this.player.exp = 0;
        this.player.nextExp = Math.floor(this.player.nextExp * 1.35);

        // –§–æ—Ä–º–∏—Ä—É–µ–º –ø—É–ª –¥–æ—Å—Ç—É–ø–Ω—ã—Ö –Ω–∞–≤—ã–∫–æ–≤ (–º–∞–∫—Å —É—Ä–æ–≤–µ–Ω—å –∫–∞–∂–¥–æ–≥–æ - 6)
        const pool = Object.keys(meta.skills).filter(s => (this.player.skills[s] || 0) < 6);
        
        if (pool.length > 0) {
            const choice = pool[Math.floor(Math.random() * pool.length)];
            if (this.player.skills[choice]) this.player.skills[choice]++;
            else this.player.skills[choice] = 1;
        }

        // –ë–æ–Ω—É—Å –≤—ã–∂–∏–≤–∞–µ–º–æ—Å—Ç–∏ –ø—Ä–∏ –Ω–æ–≤–æ–º —É—Ä–æ–≤–Ω–µ
        this.player.hp = Math.min(this.player.maxHp, this.player.hp + (this.player.maxHp * 0.2));
        this.spawnFX(this.player.x, this.player.y, '#fff', 30);
        this.updateHUD();
    },

    // 3. –ó–ê–í–ï–†–®–ï–ù–ò–ï –ò–ì–†–´ –ò –°–û–•–†–ê–ù–ï–ù–ò–ï –í –ü–ê–°–ü–û–†–¢
    gameOver() {
        this.active = false;
        const earnedGold = Math.floor(this.player.gold);
        
        // –ù–∞—á–∏—Å–ª–µ–Ω–∏–µ –∑–æ–ª–æ—Ç–∞ –Ω–∞ –∞–∫–∫–∞—É–Ω—Ç
        account.current.gold += earnedGold;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ —Ä–µ–∫–æ—Ä–¥–∞ —É—Ä–æ–≤–Ω—è
        if (this.player.lvl > (account.current.records.level || 0)) {
            account.current.records.level = this.player.lvl;
        }
        
        account.save();
        alert(`–ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê\n\n–í–∞—à —É—Ä–æ–≤–µ–Ω—å: ${this.player.lvl}\n–ó–æ–ª–æ—Ç–∞ –≤ –±–∞–Ω–∫: ${earnedGold}`);
        location.reload(); 
    }
});

// 4. –ü–û–õ–ù–ê–Ø –ê–î–ú–ò–ù-–ü–ê–ù–ï–õ–¨ (V9)
const admin = {
    addGold(amt) {
        if(!account.current) return;
        account.current.gold += amt;
        account.save();
        account.updateProfile();
        alert(`–î–æ–±–∞–≤–ª–µ–Ω–æ ${amt} –∑–æ–ª–æ—Ç–∞`);
    },
    unlockAll() {
        if(!account.current) return;
        account.current.unlocked = Object.keys(meta.chars);
        account.save();
        meta.renderLobby();
        alert("–í—Å–µ –ø–µ—Ä—Å–æ–Ω–∞–∂–∏ —Ä–∞–∑–±–ª–æ–∫–∏—Ä–æ–≤–∞–Ω—ã!");
    },
    resetAcc() {
        if(confirm("–°–±—Ä–æ—Å–∏—Ç—å –≤–µ—Å—å –ø—Ä–æ–≥—Ä–µ—Å—Å –∞–∫–∫–∞—É–Ω—Ç–∞?")) {
            localStorage.clear();
            location.reload();
        }
    }
};

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è UI –ê–¥–º–∏–Ω–∫–∏
(function createAdminInterface() {
    const adminDiv = document.createElement('div');
    adminDiv.id = 'admin-menu';
    adminDiv.className = 'ui-screen hidden';
    adminDiv.style.background = 'rgba(20, 0, 0, 0.98)';
    adminDiv.innerHTML = `
        <h1 style="color:#ff4d4d; text-shadow: 0 0 10px #f00;">CONSOLE ADMIN V9</h1>
        <div style="display:grid; gap:15px; width:300px;">
            <button class="btn" onclick="admin.addGold(100000)">+100k GOLD</button>
            <button class="btn" onclick="admin.unlockAll()">UNLOCK ALL</button>
            <button class="btn" onclick="admin.resetAcc()" style="background:#400">HARD RESET</button>
            <button class="btn" onclick="ui.showTab('lobby')" style="background:#222; margin-top:20px;">BACK</button>
        </div>
    `;
    document.body.appendChild(adminDiv);
})();Object.assign(game, {
    // 1. –ì–õ–ê–í–ù–´–ô –¶–ò–ö–õ –û–¢–†–ò–°–û–í–ö–ò
    render() {
        const ctx = this.ctx;
        const cx = this.width / 2;
        const cy = this.height / 2;

        // –û—á–∏—Å—Ç–∫–∞ —Ñ–æ–Ω–∞
        ctx.fillStyle = '#050805';
        ctx.fillRect(0, 0, this.width, this.height);

        ctx.save();
        // –ö–∞–º–µ—Ä–∞ —Å–ª–µ–¥—É–µ—Ç –∑–∞ –∏–≥—Ä–æ–∫–æ–º
        ctx.translate(cx - this.player.x, cy - this.player.y);

        // 2. –û–¢–†–ò–°–û–í–ö–ê –ü–†–ï–î–ú–ï–¢–û–í –ò –ó–û–ù
        this.entities.items.forEach(it => {
            if (it.type === 'gas') {
                ctx.fillStyle = 'rgba(0, 255, 100, 0.12)';
                ctx.beginPath(); ctx.arc(it.x, it.y, it.size, 0, Math.PI * 2); ctx.fill();
            } else {
                ctx.fillStyle = it.type === 'exp' ? '#00ffd4' : '#ff4d4d';
                ctx.beginPath(); ctx.arc(it.x, it.y, 5, 0, Math.PI * 2); ctx.fill();
            }
        });

        // 3. –°–ü–ï–¶–≠–§–§–ï–ö–¢–´ (–ú–µ—Ç–µ–æ—Ä—ã, –õ–∞–∑–µ—Ä—ã, –ß–∞—Å—Ç–∏—Ü—ã)
        this.entities.fx.forEach(f => {
            if (f.type === 'meteor_warn') {
                ctx.strokeStyle = 'rgba(255, 60, 0, 0.6)';
                ctx.lineWidth = 4;
                ctx.beginPath(); ctx.arc(f.x, f.y, f.size * (1 - f.life/900), 0, Math.PI*2); ctx.stroke();
                if (f.life < 40) { // –ú–æ–º–µ–Ω—Ç —É–¥–∞—Ä–∞
                    game.spawnFX(f.x, f.y, '#ff4400', 15);
                }
            } else if (f.type === 'laser_beam') {
                ctx.strokeStyle = '#fff';
                ctx.lineWidth = 20 * (f.life/1200);
                ctx.shadowBlur = 15; ctx.shadowColor = '#00d4ff';
                ctx.beginPath(); ctx.moveTo(f.x, f.y);
                ctx.lineTo(f.x + Math.cos(f.angle)*1200, f.y + Math.sin(f.angle)*1200); ctx.stroke();
                ctx.shadowBlur = 0;
            } else {
                ctx.globalAlpha = f.life / 600;
                ctx.fillStyle = f.color;
                ctx.fillRect(f.x, f.y, f.size, f.size);
            }
        });
        ctx.globalAlpha = 1;

        // 4. –í–†–ê–ì–ò –ò –ü–£–õ–ò
        this.entities.bullets.forEach(b => {
            ctx.fillStyle = b.color;
            ctx.beginPath(); ctx.arc(b.x, b.y, b.size, 0, Math.PI*2); ctx.fill();
        });

        this.entities.enemies.forEach(e => {
            ctx.fillStyle = e.color;
            ctx.beginPath(); ctx.arc(e.x, e.y, e.size, 0, Math.PI*2); ctx.fill();
            // –ü–æ–ª–æ—Å–∫–∞ HP –≤—Ä–∞–≥–∞
            ctx.fillStyle = '#222'; ctx.fillRect(e.x - 15, e.y - e.size - 10, 30, 4);
            ctx.fillStyle = '#f00'; ctx.fillRect(e.x - 15, e.y - e.size - 10, (e.hp/e.maxHp)*30, 4);
        });

        // 5. –ò–ì–†–û–ö
        this.drawPlayer(ctx);
        ctx.restore();

        // –≠–∫—Ä–∞–Ω –ø–∞—É–∑—ã
        if (this.paused) {
            ctx.fillStyle = 'rgba(0,0,0,0.7)';
            ctx.fillRect(0, 0, this.width, this.height);
            ctx.fillStyle = '#fff'; ctx.font = 'bold 40px Verdana'; ctx.textAlign = 'center';
            ctx.fillText('–ü–ê–£–ó–ê', cx, cy);
        }
    },

    drawPlayer(ctx) {
        ctx.save();
        ctx.translate(this.player.x, this.player.y);
        
        // –≠—Ñ—Ñ–µ–∫—Ç –º–µ—Ä—Ü–∞–Ω–∏—è –ø—Ä–∏ –ø–æ–ª—É—á–µ–Ω–∏–∏ —É—Ä–æ–Ω–∞
        if (this.player.iframe > 0 && Math.floor(Date.now()/60) % 2) ctx.globalAlpha = 0.3;
        
        ctx.shadowBlur = 20; ctx.shadowColor = '#00d4ff';
        meta.drawCharIcon(ctx, meta.selected, 0, 0, this.player.size);
        ctx.restore();
    }
});

// 6. –ì–ï–ù–ï–†–ê–¢–û–† –ì–ï–û–ú–ï–¢–†–ò–ß–ï–°–ö–ò–• –ò–ö–û–ù–û–ö
meta.drawCharIcon = function(ctx, id, x, y, s) {
    ctx.save();
    ctx.translate(x, y);
    ctx.fillStyle = '#00d4ff';
    ctx.strokeStyle = '#fff';
    ctx.lineWidth = 2;

    switch(id) {
        case 'square': ctx.fillRect(-s, -s, s*2, s*2); break;
        case 'circle': ctx.beginPath(); ctx.arc(0,0,s,0,Math.PI*2); ctx.fill(); break;
        case 'triangle': 
            ctx.beginPath(); ctx.moveTo(0,-s); ctx.lineTo(s,s); ctx.lineTo(-s,s); ctx.closePath(); ctx.fill(); 
            break;
        case 'blade':
            ctx.rotate(Date.now()/150);
            for(let i=0; i<4; i++) { ctx.rotate(Math.PI/2); ctx.fillRect(s/2, -2, s, 4); }
            ctx.beginPath(); ctx.arc(0,0,s/2,0,Math.PI*2); ctx.fill();
            break;
        case 'star':
            for(let i=0; i<5; i++) {
                ctx.rotate(Math.PI*2/5); ctx.lineTo(0, -s); ctx.rotate(Math.PI*2/10); ctx.lineTo(0, -s/2);
            }
            ctx.closePath(); ctx.fill();
            break;
        default: // –†–æ–º–±–æ–≤–∏–¥–Ω–∞—è —Ñ–æ—Ä–º–∞ –¥–ª—è –æ—Å—Ç–∞–ª—å–Ω—ã—Ö
            ctx.beginPath(); ctx.moveTo(0,-s); ctx.lineTo(s,0); ctx.lineTo(0,s); ctx.lineTo(-s,0); ctx.closePath(); ctx.fill();
    }
    ctx.stroke();
    ctx.restore();
};

// 7. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ì–†–ò–î–ê –ü–ï–†–°–û–ù–ê–ñ–ï–ô –í –õ–û–ë–ë–ò
meta.renderLobby = function() {
    const grid = document.getElementById('char-grid');
    if (!grid) return;
    grid.innerHTML = '';

    Object.keys(this.chars).forEach(id => {
        const c = this.chars[id];
        const isUnlocked = account.current.unlocked.includes(id);
        const card = document.createElement('div');
        card.className = `char-card ${!isUnlocked ? 'locked' : ''} ${this.selected === id ? 'selected' : ''}`;
        
        card.innerHTML = `
            <canvas id="prev-${id}" width="50" height="50"></canvas>
            <div style="font-weight:bold; margin-top:5px;">${c.name}</div>
            <div style="color:#ffd700; font-size:11px;">${isUnlocked ? '–í–´–ë–†–ê–¢–¨' : c.price + ' üí∞'}</div>
        `;

        card.onclick = () => {
            if (isUnlocked) {
                this.selected = id;
                this.renderLobby();
            } else if (account.current.gold >= c.price) {
                account.current.gold -= c.price;
                account.current.unlocked.push(id);
                account.save();
                account.updateProfile();
                this.renderLobby();
            }
        };

        grid.appendChild(card);
        const pCtx = document.getElementById(`prev-${id}`).getContext('2d');
        meta.drawCharIcon(pCtx, id, 25, 25, 15);
    });
};Object.assign(game, {
    // 1. –ò–ù–ò–¶–ò–ê–õ–ò–ó–ê–¶–ò–Ø –£–ü–†–ê–í–õ–ï–ù–ò–Ø (Mobile + PC)
    initInput() {
        const base = document.getElementById('joy-base');
        const stick = document.getElementById('joy-stick');
        if (!base || !stick) return;

        const handleMove = (e) => {
            // –ü—Ä–µ–¥–æ—Ç–≤—Ä–∞—â–∞–µ–º —Å–∫—Ä–æ–ª–ª —Å—Ç—Ä–∞–Ω–∏—Ü—ã –ø—Ä–∏ –∏–≥—Ä–µ
            if (e.cancelable) e.preventDefault();
            
            const t = e.touches ? e.touches[0] : e;
            const rect = base.getBoundingClientRect();
            const centerX = rect.left + rect.width / 2;
            const centerY = rect.top + rect.height / 2;
            
            const dx = t.clientX - centerX;
            const dy = t.clientY - centerY;
            const distance = Math.hypot(dx, dy);
            const angle = Math.atan2(dy, dx);
            const maxRadius = 45; // –†–∞–¥–∏—É—Å —Ö–æ–¥–∞ —Å—Ç–∏–∫–∞

            this.input.joyActive = true;
            const moveDist = Math.min(distance, maxRadius);
            
            // –ù–æ—Ä–º–∞–ª–∏–∑–∞—Ü–∏—è –≤–µ–∫—Ç–æ—Ä–∞ –¥–≤–∏–∂–µ–Ω–∏—è (0.0 - 1.0)
            this.input.dx = Math.cos(angle) * (moveDist / maxRadius);
            this.input.dy = Math.sin(angle) * (moveDist / maxRadius);

            // –í–∏–∑—É–∞–ª—å–Ω–æ–µ —Å–º–µ—â–µ–Ω–∏–µ —Å—Ç–∏–∫–∞
            stick.style.transform = `translate(${Math.cos(angle) * moveDist}px, ${Math.sin(angle) * moveDist}px)`;
        };

        const handleStop = () => {
            this.input.joyActive = false;
            this.input.dx = 0;
            this.input.dy = 0;
            stick.style.transform = 'translate(0, 0)';
        };

        // –°–ª—É—à–∞—Ç–µ–ª–∏ —Å–æ–±—ã—Ç–∏–π —Å —Ñ–ª–∞–≥–æ–º passive: false –¥–ª—è –±–ª–æ–∫–∏—Ä–æ–≤–∫–∏ —Å–∫—Ä–æ–ª–ª–∞
        base.addEventListener('touchstart', handleMove, { passive: false });
        base.addEventListener('touchmove', handleMove, { passive: false });
        base.addEventListener('touchend', handleStop);
        
        // –ü–æ–¥–¥–µ—Ä–∂–∫–∞ –º—ã—à–∏ –¥–ª—è —Ç–µ—Å—Ç–æ–≤ –Ω–∞ –ü–ö
        base.addEventListener('mousedown', (e) => {
            handleMove(e);
            const mouseMove = (me) => handleMove(me);
            const mouseUp = () => {
                handleStop();
                window.removeEventListener('mousemove', mouseMove);
                window.removeEventListener('mouseup', mouseUp);
            };
            window.addEventListener('mousemove', mouseMove);
            window.addEventListener('mouseup', mouseUp);
        });

        // –ü–∞—É–∑–∞ –Ω–∞ Escape
        window.addEventListener('keydown', (e) => {
            if (e.code === 'Escape' && this.active) this.paused = !this.paused;
        });
    },

    // 2. –û–ë–ù–û–í–õ–ï–ù–ò–ï –ò–ì–†–û–í–û–ì–û –ò–ù–¢–ï–†–§–ï–ô–°–ê (HUD)
    updateHUD() {
        // –≠–ª–µ–º–µ–Ω—Ç—ã –ø–æ–ª–æ—Å–æ–∫
        const hpFill = document.getElementById('hp-fill');
        const expFill = document.getElementById('exp-fill');
        
        // –¢–µ–∫—Å—Ç–æ–≤—ã–µ –¥–∞–Ω–Ω—ã–µ
        const goldTxt = document.getElementById('h-gold');
        const lvlTxt = document.getElementById('h-lvl');
        const timeTxt = document.getElementById('h-time');

        if (hpFill) {
            const hpPerc = Math.max(0, (this.player.hp / this.player.maxHp) * 100);
            hpFill.style.width = hpPerc + '%';
            // –¶–≤–µ—Ç –ø–æ–ª–æ—Å–∫–∏ –º–µ–Ω—è–µ—Ç—Å—è –ø—Ä–∏ –∫—Ä–∏—Ç–∏—á–µ—Å–∫–æ–º HP
            hpFill.style.background = hpPerc < 30 ? '#ff0000' : 'linear-gradient(90deg, #ff4d4d, #ff0000)';
        }

        if (expFill) {
            expFill.style.width = Math.min(100, (this.player.exp / this.player.nextExp) * 100) + '%';
        }

        if (goldTxt) goldTxt.innerText = Math.floor(this.player.gold);
        if (lvlTxt) lvlTxt.innerText = `LVL ${this.player.lvl}`;

        // –¢–∞–π–º–µ—Ä –≤—ã–∂–∏–≤–∞–Ω–∏—è
        const totalSec = Math.floor(this.elapsed / 1000);
        const min = Math.floor(totalSec / 60).toString().padStart(2, '0');
        const sec = (totalSec % 60).toString().padStart(2, '0');
        if (timeTxt) timeTxt.innerText = `${min}:${sec}`;
    },

    // 3. –û–°–ù–û–í–ù–û–ô –ò–ì–†–û–í–û–ô –¶–ò–ö–õ (Game Loop)
    loop(timestamp) {
        if (!this.active) return;
        
        // –í—ã—á–∏—Å–ª–µ–Ω–∏–µ Delta Time
        if (!this.timers.last) this.timers.last = timestamp;
        const dt = timestamp - this.timers.last;
        this.timers.last = timestamp;

        if (!this.paused) {
            // –û–≥—Ä–∞–Ω–∏—á–∏–≤–∞–µ–º dt (–∑–∞—â–∏—Ç–∞ –æ—Ç —Å–∫–∞—á–∫–æ–≤ –ø—Ä–∏ –ø–æ—Ç–µ—Ä–µ —Ñ–æ–∫—É—Å–∞)
            this.update(Math.min(dt, 50));
        }
        
        this.render();
        requestAnimationFrame((t) => this.loop(t));
    },

    // 4. –ü–†–ï–î–ò–ì–†–û–í–û–ô –ó–ê–ü–£–°–ö
    preStart() {
        if (!account.current) return alert("–°–Ω–∞—á–∞–ª–∞ –≤–æ–π–¥–∏—Ç–µ –≤ —Å–∏—Å—Ç–µ–º—É!");
        
        // –ü–µ—Ä–µ–∫–ª—é—á–µ–Ω–∏–µ —ç–∫—Ä–∞–Ω–æ–≤
        document.querySelectorAll('.ui-screen').forEach(s => s.classList.add('hidden'));
        document.getElementById('hud').classList.remove('hidden');
        document.getElementById('joy-base').classList.remove('hidden');
        
        // –ó–∞–ø—É—Å–∫ –¥–≤–∏–∂–∫–∞
        this.start();
    }
});

// –ò–Ω–∏—Ü–∏–∞–ª–∏–∑–∞—Ü–∏—è —Å–∏—Å—Ç–µ–º—ã –ø—Ä–∏ –∑–∞–≥—Ä—É–∑–∫–µ
window.addEventListener('load', () => {
    // –ù–∞—Å—Ç—Ä–æ–π–∫–∞ –∫–∞–Ω–≤–∞—Å–∞
    const canvas = document.getElementById('gameCanvas');
    if (canvas) {
        game.ctx = canvas.getContext('2d');
        window.addEventListener('resize', () => {
            game.width = canvas.width = window.innerWidth;
            game.height = canvas.height = window.innerHeight;
        });
        window.dispatchEvent(new Event('resize'));
    }

    // –ü—Ä–æ–≤–µ—Ä–∫–∞ —Å–æ—Ö—Ä–∞–Ω–µ–Ω–Ω–æ–≥–æ –Ω–∏–∫–∞
    const lastUser = localStorage.getItem('v9_last_user');
    if (lastUser) {
        const nickInput = document.getElementById('auth-nick');
        if (nickInput) nickInput.value = lastUser;
    }
});
