<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivalist</title>
    <style>
        :root { --p: #00d4ff; --r: #ff0055; --g: #ffcc00; --bg: #050805; --panel: rgba(0, 20, 0, 0.95); --ev: #ff3333; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; width: 100vw; height: 100vh; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        
        .ui { position: absolute; inset: 0; z-index: 100; background: var(--bg); display: flex; flex-direction: column; }
        .hidden { display: none !important; }
        
        /* –ü–∞–Ω–µ–ª–∏ –∏ –∫–Ω–æ–ø–∫–∏ */
        .auth-panel, .mode-panel { background: var(--panel); padding: 25px; border: 2px solid var(--p); border-radius: 20px; text-align: center; width: 90%; max-width: 380px; box-shadow: 0 0 20px var(--p); }
        .btn-action { width: 100%; padding: 15px; margin: 8px 0; background: rgba(0,212,255,0.1); border: 1px solid var(--p); color: #fff; border-radius: 10px; font-weight: bold; cursor: pointer; transition: 0.2s; }
        .btn-action:disabled { opacity: 0.3; cursor: not-allowed; border-color: #444; }
        .btn-action:active:not(:disabled) { background: var(--p); color: #000; }

        /* –ü—Ä–æ—Ñ–∏–ª—å */
        .top-profile { position: absolute; top: 20px; left: 20px; display: flex; align-items: center; gap: 12px; cursor: pointer; z-index: 110; }
        .lvl-box { width: 45px; height: 45px; border: 2px solid var(--p); border-radius: 50%; display: flex; justify-content: center; align-items: center; font-weight: bold; background: rgba(0,0,0,0.6); }

        /* –ì–ª–∞–≤–Ω–æ–µ –º–µ–Ω—é */
        .lobby-content { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; padding-bottom: 80px; }
        .btn-play-big { width: 160px; height: 160px; border-radius: 50%; background: var(--p); color: #000; border: 8px solid rgba(255,255,255,0.2); font-size: 22px; font-weight: 900; cursor: pointer; box-shadow: 0 0 25px var(--p); transition: 0.2s; }

        /* –ù–∞–≤–∏–≥–∞—Ü–∏—è */
        .nav-bar { position: absolute; bottom: 0; left: 0; width: 100%; height: 70px; border-top: 2px solid #222; display: flex; background: #080a08; }
        .nav-tab { flex: 1; display: flex; flex-direction: column; justify-content: center; align-items: center; font-size: 10px; color: #555; cursor: pointer; }
        .nav-tab.active { color: var(--p); background: rgba(0, 212, 255, 0.05); }

        /* –¢–∞–±–ª–∏—Ü–∞ –ª–∏–¥–µ—Ä–æ–≤ */
        .rank-tabs { display: flex; gap: 5px; margin-bottom: 15px; overflow-x: auto; padding-bottom: 5px; }
        .r-sub-tab { padding: 8px 12px; background: #111; border-radius: 5px; font-size: 11px; white-space: nowrap; border: 1px solid #333; }
        .r-sub-tab.active { border-color: var(--p); color: var(--p); }
        .tab-view { width: 100%; height: 100%; padding: 80px 15px 80px; overflow-y: auto; }
        .rank-item { display: flex; justify-content: space-between; padding: 12px; background: rgba(255,255,255,0.03); margin-bottom: 4px; border-radius: 8px; font-size: 14px; }

        /* –≠–∫—Ä–∞–Ω—ã –≤—ã–±–æ—Ä–∞ */
        .overlay-screen { position: absolute; inset: 0; background: rgba(0,0,0,0.9); display: flex; justify-content: center; align-items: center; z-index: 150; }
        
        /* HUD */
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; pointer-events: none; z-index: 50; }
        .bar { width: 100%; height: 6px; background: rgba(255,255,255,0.1); margin-top: 4px; border-radius: 3px; overflow: hidden; }
        .fill { height: 100%; width: 0%; transition: width 0.2s; }
        
        input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--p); color: #fff; text-align: center; margin-bottom: 10px; border-radius: 8px; }
    </style>
</head>
<body>

<div id="hud" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items: center; font-size: 14px;">
        <div id="h-lvl" style="background:var(--p); color:#000; padding:3px 10px; border-radius:15px; font-weight:bold;">LVL 1</div>
        <div id="h-time" style="font-family: monospace; font-size: 18px;">00:00</div>
        <div id="h-gold" style="color:var(--g); font-weight:bold;">üí∞ 0</div>
    </div>
    <div class="bar"><div id="hp-fill" class="fill" style="background:var(--r); width:100%"></div></div>
    <div class="bar"><div id="exp-fill" class="fill" style="background:var(--p)"></div></div>
</div>

<div id="auth" class="ui">
    <div class="auth-panel">
        <h1 style="color:var(--p); margin-bottom: 15px; letter-spacing: 2px;">SURVIVALIST</h1>
        <input type="text" id="nick" placeholder="–õ–û–ì–ò–ù">
        <input type="password" id="pass" placeholder="–ü–ê–†–û–õ–¨">
        <button class="btn-action" style="background: var(--p); color:#000;" onclick="account.login()">–í–•–û–î / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<div id="mode-select" class="ui hidden" style="justify-content:center; align-items:center;">
    <div class="mode-panel">
        <h2 style="margin-bottom: 15px;">–í–´–ë–û–† –†–ï–ñ–ò–ú–ê</h2>
        <button class="btn-action" onclick="ui.showDifficulty()">–û–ë–´–ß–ù–´–ô (30 –ú–ò–ù)</button>
        <button id="btn-mode-inf" class="btn-action" onclick="game.setup('infinite')">–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô (LVL 3)</button>
        <button id="btn-mode-boss" class="btn-action" onclick="game.setup('boss')">–û–•–û–¢–ê –ù–ê –ë–û–°–°–û–í (LVL 10)</button>
        <button class="btn-action" style="border-color:var(--r); color:var(--r); margin-top:10px;" onclick="ui.closeModes()">–û–¢–ú–ï–ù–ê</button>
    </div>
</div>

<div id="diff-select" class="ui hidden" style="justify-content:center; align-items:center; background:rgba(0,0,0,0.95);">
    <div class="mode-panel">
        <h2 style="margin-bottom: 15px;">–°–õ–û–ñ–ù–û–°–¢–¨</h2>
        <button class="btn-action" onclick="game.setup('normal', 1)">–õ–ï–ì–ö–û</button>
        <button id="btn-diff-2" class="btn-action" onclick="game.setup('normal', 2)">–ù–û–†–ú–ê–õ–¨–ù–û (–ù–£–ñ–ï–ù "–õ–ï–ì–ö–û")</button>
        <button id="btn-diff-3" class="btn-action" onclick="game.setup('normal', 3)">–ê–î (–ù–£–ñ–ï–ù "–ù–û–†–ú–ê–õ–¨–ù–û")</button>
        <button class="btn-action" style="border-color:var(--r);" onclick="ui.hideDifficulty()">–ù–ê–ó–ê–î</button>
    </div>
</div>

<div id="card-screen" class="ui hidden" style="justify-content:center; align-items:center; background:rgba(0,0,0,0.8);">
    <h2 style="margin-bottom: 20px;">–ù–û–í–´–ô –ù–ê–í–´–ö</h2>
    <div class="card-list" id="card-list"></div>
</div>

<div id="lobby" class="ui hidden">
    <div class="top-profile" onclick="game.showLvlInfo()">
        <div class="lvl-box" id="u-lvl">1</div>
        <div style="font-weight:bold; text-transform:uppercase;" id="u-nick">–ì–ï–†–û–ô</div>
    </div>
    <div id="tab-main" class="tab-view">
        <div class="lobby-content">
            <div style="color:var(--g); font-size: 28px; font-weight: bold; margin-bottom: 20px;">üí∞ <span id="u-gold">0</span></div>
            <button class="btn-play-big" onclick="ui.openModes()">–ò–ì–†–ê–¢–¨</button>
        </div>
    </div>
    <div id="tab-rank" class="tab-view hidden">
        <h2 style="text-align:center; color:var(--p); margin-bottom: 15px;">–†–ï–ô–¢–ò–ù–ì</h2>
        <div class="rank-tabs">
            <div class="r-sub-tab active" onclick="account.renderLeaderboard('gold', this)">–î–ï–ù–¨–ì–ò</div>
            <div class="r-sub-tab" onclick="account.renderLeaderboard('lvl', this)">–£–†–û–í–ï–ù–¨</div>
            <div class="r-sub-tab" onclick="account.renderLeaderboard('infTime', this)">–ë–ï–°–ö–û–ù–ï–ß–ù–´–ô</div>
            <div class="r-sub-tab" onclick="account.renderLeaderboard('bossTime', this)">–û–•–û–¢–ê</div>
        </div>
        <div id="rankings"></div>
    </div>
    <div class="nav-bar">
        <div class="nav-tab active" onclick="ui.setTab('main', this)"><span>–ì–õ–ê–í–ù–ê–Ø</span></div>
        <div class="nav-tab" onclick="ui.setTab('rank', this)"><span>–†–ï–ô–¢–ò–ù–ì</span></div>
    </div>
</div>

<div id="joy-base" class="hidden"><div id="joy-stick"></div></div>
<canvas id="cvs"></canvas><script>
// --- –ö–û–ù–§–ò–ì–£–†–ê–¶–ò–Ø –ò –î–ê–ù–ù–´–ï ---
const SKILLS_DB = {
    "–≤—ã—Å—Ç—Ä–µ–ª": { icon: "üî´", desc: "–°—Ç—Ä–µ–ª—è–µ—Ç –ø—É–ª—è–º–∏ –≤ –±–ª–∏–∂–∞–π—à–µ–≥–æ –≤—Ä–∞–≥–∞" },
    "–º–æ–ª–Ω–∏—è": { icon: "‚ö°", desc: "–ë—å–µ—Ç —Å–ª—É—á–∞–π–Ω–æ–≥–æ –≤—Ä–∞–≥–∞ –º–æ–ª–Ω–∏–µ–π" },
    "–∫–∏—Ä–ø–∏—á": { icon: "üß±", desc: "–ü–∞–¥–∞–µ—Ç —Å–≤–µ—Ä—Ö—É –Ω–∞ –≤—Ä–∞–≥–æ–≤" },
    "—Å–∏–ª–æ–≤–æ–µ –ø–æ–ª–µ": { icon: "üîò", desc: "–ê—É—Ä–∞ —É—Ä–æ–Ω–∞ –≤–æ–∫—Ä—É–≥ –∏–≥—Ä–æ–∫–∞" },
    "—Ä–∞–∫–µ—Ç–∞": { icon: "üöÄ", desc: "–õ–µ—Ç–∏—Ç –≤ —Å–ª—É—á–∞–π–Ω–æ–º –Ω–∞–ø—Ä–∞–≤–ª–µ–Ω–∏–∏" }
};

const ui = {
    setTab(name, el) {
        document.querySelectorAll('.tab-view').forEach(t => t.classList.add('hidden'));
        document.querySelectorAll('.nav-tab').forEach(n => n.classList.remove('active'));
        document.getElementById('tab-' + name).classList.remove('hidden');
        el.classList.add('active');
        if(name === 'rank') account.renderLeaderboard('gold');
    },
    openModes() {
        document.getElementById('mode-select').classList.remove('hidden');
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ —É—Ä–æ–≤–Ω–µ–π –¥–ª—è –¥–æ—Å—Ç—É–ø–∞ –∫ —Ä–µ–∂–∏–º–∞–º
        document.getElementById('btn-mode-inf').disabled = account.curr.lvl < 3;
        document.getElementById('btn-mode-boss').disabled = account.curr.lvl < 10;
    },
    closeModes() { document.getElementById('mode-select').classList.add('hidden'); },
    showDifficulty() {
        document.getElementById('diff-select').classList.remove('hidden');
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –æ—Ç–∫—Ä—ã—Ç—ã—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π
        const un = account.curr.unlocks || {};
        document.getElementById('btn-diff-2').disabled = !un.normal2;
        document.getElementById('btn-diff-3').disabled = !un.normal3;
    },
    hideDifficulty() { document.getElementById('diff-select').classList.add('hidden'); }
};

// --- –°–ò–°–¢–ï–ú–ê –ê–ö–ö–ê–£–ù–¢–ê ---
const account = {
    curr: null,
    init() {
        const last = localStorage.getItem('last_user');
        if(last) {
            const data = localStorage.getItem('user_' + last);
            if(data) { this.curr = JSON.parse(data); this.openLobby(); }
        }
    },
    login() {
        const n = document.getElementById('nick').value.trim().toLowerCase();
        const p = document.getElementById('pass').value.trim();
        if(!n || !p) return alert("–í–≤–µ–¥–∏—Ç–µ –¥–∞–Ω–Ω—ã–µ!");
        
        const saved = localStorage.getItem('user_' + n);
        if(saved) {
            const data = JSON.parse(saved);
            if(data.pass !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            this.curr = data;
        } else {
            // –ù–æ–≤—ã–π –∏–≥—Ä–æ–∫
            this.curr = { 
                nick: n, pass: p, gold: 0, lvl: 1, exp: 0, 
                infTime: 0, bossTime: 0, 
                unlocks: { normal2: false, normal3: false } 
            };
        }
        localStorage.setItem('last_user', n);
        this.save();
        this.openLobby();
    },
    save() {
        if(this.curr) localStorage.setItem('user_' + this.curr.nick, JSON.stringify(this.curr));
    },
    openLobby() {
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('lobby').classList.remove('hidden');
        document.getElementById('u-nick').innerText = this.curr.nick;
        document.getElementById('u-lvl').innerText = this.curr.lvl;
        document.getElementById('u-gold').innerText = this.curr.gold;
    },
    renderLeaderboard(type, el) {
        if(el) {
            document.querySelectorAll('.r-sub-tab').forEach(t => t.classList.remove('active'));
            el.classList.add('active');
        }
        const list = document.getElementById('rankings');
        let users = [];
        for(let i=0; i<localStorage.length; i++){
            const key = localStorage.key(i);
            if(key.startsWith('user_')) users.push(JSON.parse(localStorage.getItem(key)));
        }
        
        // –°–æ—Ä—Ç–∏—Ä–æ–≤–∫–∞ –ø–æ –≤—ã–±—Ä–∞–Ω–Ω–æ–º—É –ø–æ–ª—é
        users.sort((a,b) => (b[type] || 0) - (a[type] || 0));
        
        list.innerHTML = users.slice(0, 100).map((u, i) => {
            let displayVal = u[type] || 0;
            if(type.includes('Time')) displayVal = Math.floor(displayVal / 60) + "–º " + (displayVal % 60) + "—Å";
            return `<div class="rank-item">
                <span>${i+1}. ${u.nick}</span>
                <span style="color:var(--p)">${displayVal}</span>
            </div>`;
        }).join('');
    }
};

// --- –ö–û–ù–¢–†–û–õ–õ–ï–† –î–ñ–û–ô–°–¢–ò–ö–ê ---
const joy = {
    active: false, x: 0, y: 0, origin: {x:0, y:0},
    base: document.getElementById('joy-base'),
    stick: document.getElementById('joy-stick'),
    init() {
        const start = (e) => {
            if(!game.active || game.paused) return;
            this.active = true;
            const t = e.touches ? e.touches[0] : e;
            this.origin = { x: t.clientX, y: t.clientY };
            this.base.style.left = this.origin.x + 'px';
            this.base.style.top = this.origin.y + 'px';
            this.base.classList.remove('hidden');
        };
        const move = (e) => {
            if(!this.active) return;
            const t = e.touches ? e.touches[0] : e;
            const dx = t.clientX - this.origin.x, dy = t.clientY - this.origin.y;
            const dist = Math.hypot(dx, dy), max = 40;
            const angle = Math.atan2(dy, dx);
            const moveX = Math.min(dist, max) * Math.cos(angle);
            const moveY = Math.min(dist, max) * Math.sin(angle);
            this.stick.style.transform = `translate(${moveX}px, ${moveY}px)`;
            this.x = moveX / max; this.y = moveY / max;
        };
        const stop = () => { this.active = false; this.x = 0; this.y = 0; this.base.classList.add('hidden'); };
        window.addEventListener('touchstart', start);
        window.addEventListener('touchmove', move);
        window.addEventListener('touchend', stop);
    }
};

account.init();
const game = {
    active: false, paused: false, time: 0, enemies: [], bullets: [], 
    sessionGold: 0, sessionExp: 0, playerSkills: {}, mode: '', diff: 1,

    setup(mode, diff = 1) {
        this.mode = mode; this.diff = diff;
        ui.closeModes(); ui.hideDifficulty();
        this.start();
    },

    start() {
        this.active = true; this.paused = false; this.time = 0; 
        this.enemies = []; this.bullets = []; this.sessionGold = 0; this.sessionExp = 0;
        this.playerSkills = { "–≤—ã—Å—Ç—Ä–µ–ª": 1 };
        
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        this.w = cvs.width = window.innerWidth; this.h = cvs.height = window.innerHeight;
        
        // –ü–∞—Ä–∞–º–µ—Ç—Ä—ã –∏–≥—Ä–æ–∫–∞ (–≤–Ω—É—Ç—Ä–∏–∏–≥—Ä–æ–≤—ã–µ)
        this.p = { 
            x: this.w/2, y: this.h/2, hp: 100, mHp: 100, 
            r: 15, s: 3.5, last: 0, pLvl: 1, pExp: 0 
        };
        
        joy.init(); this.loop();
    },

    spawn() {
        // –û–≥—Ä–∞–Ω–∏—á–µ–Ω–∏–µ –∫–æ–ª-–≤–∞ –º–æ–±–æ–≤ –¥–ª—è –ø—Ä–æ–∏–∑–≤–æ–¥–∏—Ç–µ–ª—å–Ω–æ—Å—Ç–∏
        const maxEnemies = this.mode === 'boss' ? 10 : (30 + this.diff * 10);
        if(this.enemies.length > maxEnemies) return;

        const side = Math.floor(Math.random()*4);
        const isBoss = (this.mode === 'boss') || (Math.random() < 0.05 * this.diff);
        let x, y;

        if(side===0){x=Math.random()*this.w; y=-30} 
        else if(side===1){x=this.w+30; y=Math.random()*this.h}
        else if(side===2){x=Math.random()*this.w; y=this.h+30} 
        else {x=-30; y=Math.random()*this.h}
        
        this.enemies.push({ 
            x, y, 
            hp: (isBoss ? 40 : 2) * this.diff, 
            r: isBoss ? 28 : 14, 
            s: (isBoss ? 0.7 : 1.6) + (this.diff * 0.2), 
            boss: isBoss 
        });
    },

    update() {
        if(this.paused) return;
        this.time++;
        
        // –ü—Ä–æ–≤–µ—Ä–∫–∞ –≤—Ä–µ–º–µ–Ω–∏ –¥–ª—è –û–±—ã—á–Ω–æ–≥–æ —Ä–µ–∂–∏–º–∞ (30 –º–∏–Ω)
        if(this.mode === 'normal' && this.time >= 108000) return this.over(true);

        // –î–≤–∏–∂–µ–Ω–∏–µ –∏–≥—Ä–æ–∫–∞ —á–µ—Ä–µ–∑ –¥–∂–æ–π—Å—Ç–∏–∫
        this.p.x = Math.max(15, Math.min(this.w-15, this.p.x + joy.x * this.p.s));
        this.p.y = Math.max(15, Math.min(this.h-15, this.p.y + joy.y * this.p.s));
        
        // –°–ø–∞–≤–Ω –≤—Ä–∞–≥–æ–≤ (—á–∞—Å—Ç–æ—Ç–∞ –∑–∞–≤–∏—Å–∏—Ç –æ—Ç —Å–ª–æ–∂–Ω–æ—Å—Ç–∏)
        let spawnRate = Math.max(15, 60 - this.diff * 10);
        if(this.time % spawnRate === 0) this.spawn();

        // 1. –ù–ê–í–´–ö: –í–´–°–¢–†–ï–õ
        let fireCooldown = 40 - (this.playerSkills['–≤—ã—Å—Ç—Ä–µ–ª'] * 5);
        if(this.time - this.p.last > fireCooldown) {
            let target = null, dMin = 500;
            this.enemies.forEach(e => {
                const d = Math.hypot(e.x-this.p.x, e.y-this.p.y);
                if(d < dMin) { dMin = d; target = e; }
            });
            if(target) {
                const isEvo = this.playerSkills['–≤—ã—Å—Ç—Ä–µ–ª'] === 6;
                this.bullets.push({
                    x:this.p.x, y:this.p.y, 
                    a:Math.atan2(target.y-this.p.y, target.x-this.p.x), 
                    s: isEvo ? 15 : 10, evo: isEvo
                });
                this.p.last = this.time;
            }
        }

        // –î–≤–∏–∂–µ–Ω–∏–µ –ø—É–ª—å
        this.bullets.forEach((b, i) => {
            b.x += Math.cos(b.a)*b.s; b.y += Math.sin(b.a)*b.s;
            if(b.x<0 || b.x>this.w || b.y<0 || b.y>this.h) this.bullets.splice(i,1);
        });

        // 2. –ù–ê–í–´–ö: –°–ò–õ–û–í–û–ï –ü–û–õ–ï
        if(this.playerSkills['—Å–∏–ª–æ–≤–æ–µ –ø–æ–ª–µ']) {
            let range = 50 + this.playerSkills['—Å–∏–ª–æ–≤–æ–µ –ø–æ–ª–µ'] * 10;
            let dps = this.playerSkills['—Å–∏–ª–æ–≤–æ–µ –ø–æ–ª–µ'] === 6 ? 0.5 : 0.1;
            this.enemies.forEach(e => {
                if(Math.hypot(e.x-this.p.x, e.y-this.p.y) < range) e.hp -= dps;
            });
        }

        // –û–±—Ä–∞–±–æ—Ç–∫–∞ –≤—Ä–∞–≥–æ–≤
        this.enemies.forEach((e, i) => {
            const angle = Math.atan2(this.p.y-e.y, this.p.x-e.x);
            e.x += Math.cos(angle)*e.s; e.y += Math.sin(angle)*e.s;
            
            // –ö–æ–ª–ª–∏–∑–∏—è —Å –ø—É–ª—è–º–∏
            this.bullets.forEach((b, bi) => {
                if(Math.hypot(e.x-b.x, e.y-b.y) < e.r) {
                    e.hp -= (b.evo ? 10 : 2);
                    if(!b.evo) this.bullets.splice(bi,1);
                    if(e.hp <= 0) {
                        this.sessionGold += e.boss ? 15 * this.diff : 1;
                        this.sessionExp += e.boss ? 100 : 20;
                        this.p.pExp += e.boss ? 200 : 50;
                        this.enemies.splice(i,1);
                    }
                }
            });

            // –£—Ä–æ–Ω –∏–≥—Ä–æ–∫—É
            if(Math.hypot(e.x-this.p.x, e.y-this.p.y) < e.r + this.p.r) {
                this.p.hp -= 0.5 * this.diff;
                if(this.p.hp <= 0) this.over(false);
            }
        });

        // –ü–æ–≤—ã—à–µ–Ω–∏–µ —É—Ä–æ–≤–Ω—è –≤–Ω—É—Ç—Ä–∏ —Å–µ—Å—Å–∏–∏ (–≤—ã–±–æ—Ä –∫–∞—Ä—Ç–æ—á–µ–∫)
        let nextLvlExp = this.p.pLvl * 250;
        if(this.p.pExp >= nextLvlExp) {
            this.p.pExp = 0; this.p.pLvl++;
            this.showCardSelection();
        }
    },

    showCardSelection() {
        this.paused = true;
        const screen = document.getElementById('card-screen');
        const list = document.getElementById('card-list');
        list.innerHTML = "";
        screen.classList.remove('hidden');

        let options = Object.keys(SKILLS_DB)
            .filter(n => (this.playerSkills[n] || 0) < 6)
            .sort(() => 0.5-Math.random()).slice(0,3);

        options.forEach(name => {
            const nextLvl = (this.playerSkills[name] || 0) + 1;
            const isEvo = nextLvl === 6;
            const item = document.createElement('div');
            item.className = `card-item ${isEvo ? 'evo' : ''}`;
            item.innerHTML = `
                <div class="card-icon">${SKILLS_DB[name].icon}</div>
                <div class="card-info">
                    <h3>${name}</h3>
                    <div class="stars">${isEvo ? '–≠–í–û–õ–Æ–¶–ò–Ø' : '‚òÖ'.repeat(nextLvl)}</div>
                </div>`;
            item.onclick = () => { 
                this.playerSkills[name] = nextLvl; 
                screen.classList.add('hidden'); 
                this.paused = false; 
            };
            list.appendChild(item);
        });
    },

    render() {
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#050805'; ctx.fillRect(0,0,this.w,this.h);
        
        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –ø—É–ª—å
        this.bullets.forEach(b => { 
            ctx.fillStyle = b.evo ? '#ff3333' : '#fff'; 
            ctx.shadowBlur = b.evo ? 10 : 0;
            ctx.shadowColor = '#ff3333';
            ctx.fillRect(b.x-3, b.y-3, b.evo?8:5, b.evo?8:5); 
            ctx.shadowBlur = 0;
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –≤—Ä–∞–≥–æ–≤
        this.enemies.forEach(e => { 
            ctx.fillStyle = e.boss ? '#ffcc00' : '#ff0055';
            ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, Math.PI*2); ctx.fill(); 
        });

        // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞
        ctx.fillStyle = '#00d4ff'; 
        ctx.beginPath(); ctx.arc(this.p.x, this.p.y, this.p.r, 0, Math.PI*2); ctx.fill();
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ HUD
        document.getElementById('h-lvl').innerText = `LVL ${this.p.pLvl}`;
        document.getElementById('h-gold').innerText = `üí∞ ${this.sessionGold}`;
        document.getElementById('hp-fill').style.width = (this.p.hp/this.p.mHp*100)+'%';
        document.getElementById('exp-fill').style.width = (this.p.pExp / (this.p.pLvl * 250) * 100)+'%';
        
        const sec = Math.floor(this.time/60);
        document.getElementById('h-time').innerText = `${Math.floor(sec/60)}:${(sec%60).toString().padStart(2,'0')}`;
    },

    loop() { 
        if(this.active) { 
            this.update(); 
            this.render(); 
            requestAnimationFrame(() => this.loop()); 
        } 
    },

    over(isWin) {
        this.active = false;
        
        // –û–±–Ω–æ–≤–ª–µ–Ω–∏–µ –ø—Ä–æ–≥—Ä–µ—Å—Å–∞ –∞–∫–∫–∞—É–Ω—Ç–∞
        account.curr.gold += this.sessionGold;
        account.curr.exp += this.sessionExp;
        
        const totalSeconds = Math.floor(this.time / 60);
        if(this.mode === 'infinite') account.curr.infTime = Math.max(account.curr.infTime || 0, totalSeconds);
        if(this.mode === 'boss') account.curr.bossTime = Math.max(account.curr.bossTime || 0, totalSeconds);

        // –û—Ç–∫—Ä—ã—Ç–∏–µ –Ω–æ–≤—ã—Ö —Å–ª–æ–∂–Ω–æ—Å—Ç–µ–π
        if(isWin && this.mode === 'normal') {
            if(this.diff === 1) account.curr.unlocks.normal2 = true;
            if(this.diff === 2) account.curr.unlocks.normal3 = true;
        }

        // –†–æ—Å—Ç —É—Ä–æ–≤–Ω—è –∞–∫–∫–∞—É–Ω—Ç–∞
        while(account.curr.exp >= account.curr.lvl * 100) {
            account.curr.exp -= account.curr.lvl * 100;
            account.curr.lvl++;
        }

        account.save();
        alert(isWin ? "–í–´ –í–´–ñ–ò–õ–ò! –ú–ò–°–°–ò–Ø –í–´–ü–û–õ–ù–ï–ù–ê" : "–ì–ï–†–û–ô –ü–û–ì–ò–ë");
        document.getElementById('hud').classList.add('hidden');
        account.openLobby();
    }
};
</script>
