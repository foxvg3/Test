<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivor.io Clone + Boss</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: 'Segoe UI', sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; }
        .hidden { display: none !important; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        .top-bar { display: flex; align-items: center; gap: 10px; }
        #exp-bar { flex-grow: 1; height: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; overflow: hidden; }
        #exp-fill { width: 0%; height: 100%; background: #00d4ff; box-shadow: 0 0 10px #00d4ff; }
        #timer { font-size: 20px; font-weight: bold; text-align: center; margin-top: 5px; color: #fff; text-shadow: 2px 2px #000; }
        #hp-bar { width: 120px; height: 12px; background: #333; margin-top: 5px; border-radius: 6px; border: 2px solid #000; overflow: hidden; }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; transition: width 0.2s; }
        #joystick-container { position: absolute; bottom: 60px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; z-index: 5; }
        #joystick-base { width: 100%; height: 100%; background: rgba(255,255,255,0.05); border-radius: 50%; border: 2px solid rgba(0,212,255,0.2); display: flex; align-items: center; justify-content: center; }
        #joystick-stick { width: 40px; height: 40px; background: #00d4ff; border-radius: 50%; opacity: 0.6; }
        #level-up { position: fixed; inset: 0; background: rgba(0,0,0,0.9); display: flex; align-items: center; justify-content: center; z-index: 100; }
        .modal { background: #1a1a1a; padding: 20px; border-radius: 15px; border: 3px solid #00d4ff; width: 85%; max-width: 400px; text-align: center; }
        .card { background: #2a2a2a; border: 2px solid #444; padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; pointer-events: all; transition: 0.1s; display: flex; flex-direction: column; align-items: center; }
        .card:active { transform: scale(0.95); background: #333; border-color: #00d4ff; }
    </style>
</head>
<body>

<div id="ui">
    <div class="top-bar">
        <div style="font-weight: bold; color: #00d4ff;">Lvl <span id="lvl">1</span></div>
        <div id="exp-bar"><div id="exp-fill"></div></div>
    </div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div id="timer">00:00</div>
</div>

<canvas id="game"></canvas>

<div id="joystick-container">
    <div id="joystick-base"><div id="joystick-stick"></div></div>
</div>

<div id="level-up" class="hidden">
    <div class="modal">
        <h2 style="color: #00d4ff; margin-top: 0;">ВЫБЕРИ НАВЫК</h2>
        <div id="cards-container"></div>
    </div>
</div>

<script>
    const canvas = document.getElementById('game');
    const ctx = canvas.getContext('2d');
    let gameActive = true, isPaused = false;
    let startTime = Date.now();
    let lastBossSpawn = 0;

    const player = {
        x: 0, y: 0, hp: 100, maxHp: 100, lvl: 1, exp: 0, nextLvl: 100, speed: 3.5,
        skills: { bulletCount: 1, fieldLvl: 0, brickLvl: 0 }
    };

    let enemies = [], bullets = [], bricks = [], crystals = [];
    let stats = { fireRate: 800, lastShot: 0, lastBrick: 0, damage: 15 };

    function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
    window.addEventListener('resize', resize);
    resize();

    // Джойстик
    let joystick = { active: false, x: 0, y: 0 };
    const stick = document.getElementById('joystick-stick');
    const jBase = document.getElementById('joystick-base');

    function handleInput(e) {
        if(!joystick.active && e.type !== 'touchstart') return;
        const t = e.touches ? e.touches[0] : e;
        const b = jBase.getBoundingClientRect();
        const dx = t.clientX - (b.left + b.width/2), dy = t.clientY - (b.top + b.height/2);
        const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
        const a = Math.atan2(dy, dx);
        joystick.x = Math.cos(a) * (d/40);
        joystick.y = Math.sin(a) * (d/40);
        stick.style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
    }

    document.addEventListener('touchstart', e => { joystick.active = true; handleInput(e); });
    document.addEventListener('touchmove', e => { if(joystick.active) { e.preventDefault(); handleInput(e); } }, {passive: false});
    document.addEventListener('touchend', () => { joystick.active = false; stick.style.transform = 'translate(0,0)'; });

    function update() {
        if(!gameActive || isPaused) return requestAnimationFrame(update);

        let now = Date.now();
        let elapsed = Math.floor((now - startTime) / 1000);
        let mins = Math.floor(elapsed / 60);
        let secs = elapsed % 60;
        document.getElementById('timer').innerText = `${mins.toString().padStart(2,'0')}:${secs.toString().padStart(2,'0')}`;

        // Спавн БОССА каждые 5 минут (300 секунд)
        if (mins > 0 && mins % 5 === 0 && mins !== lastBossSpawn) {
            spawnBoss();
            lastBossSpawn = mins;
        }

        if(joystick.active) {
            player.x += joystick.x * player.speed;
            player.y += joystick.y * player.speed;
        }

        // Авто-стрельба
        if(now - stats.lastShot > stats.fireRate) {
            let nearest = getNearestEnemy(600);
            if(nearest) {
                let angle = Math.atan2(nearest.y - player.y, nearest.x - player.x);
                for(let i=0; i < player.skills.bulletCount; i++) {
                    let spread = (i - (player.skills.bulletCount-1)/2) * 0.2;
                    bullets.push({x: player.x, y: player.y, vx: Math.cos(angle+spread)*10, vy: Math.sin(angle+spread)*10});
                }
                stats.lastShot = now;
            }
        }

        // Кирпичи
        if(player.skills.brickLvl > 0 && now - stats.lastBrick > 2000 / player.skills.brickLvl) {
            bricks.push({x: player.x, y: player.y, vy: -12, vx: (Math.random()-0.5)*10, g: 0.4});
            stats.lastBrick = now;
        }
        bricks.forEach((b, i) => {
            b.x += b.vx; b.y += b.vy; b.vy += b.g;
            enemies.forEach(e => {
                if(Math.sqrt((b.x-e.x)**2 + (b.y-e.y)**2) < (e.boss ? 60 : 30)) e.hp -= 2;
            });
            if(b.y > player.y + 600) bricks.splice(i, 1);
        });

        // Силовое поле
        if(player.skills.fieldLvl > 0) {
            let radius = 80 + (player.skills.fieldLvl * 20);
            enemies.forEach(e => {
                if(Math.sqrt((e.x-player.x)**2 + (e.y-player.y)**2) < radius) e.hp -= 0.5;
            });
        }

        // Пули
        bullets.forEach((b, bi) => {
            b.x += b.vx; b.y += b.vy;
            enemies.forEach((e, ei) => {
                if(Math.sqrt((b.x-e.x)**2 + (b.y-e.y)**2) < (e.boss ? 50 : 20)) {
                    e.hp -= stats.damage;
                    bullets.splice(bi, 1);
                    if(e.hp <= 0) { 
                        crystals.push({x: e.x, y: e.y, big: e.boss}); 
                        enemies.splice(ei, 1); 
                    }
                }
            });
            if(Math.abs(b.x-player.x) > 800) bullets.splice(bi, 1);
        });

        // Враги
        if(enemies.length < 20 + player.lvl*2) {
            let a = Math.random()*Math.PI*2;
            enemies.push({x: player.x+Math.cos(a)*500, y: player.y+Math.sin(a)*500, hp: 20 + player.lvl*5, boss: false});
        }
        enemies.forEach(e => {
            let a = Math.atan2(player.y-e.y, player.x-e.x);
            let speed = e.boss ? 1 : 1.5;
            e.x += Math.cos(a)*speed; e.y += Math.sin(a)*speed;
            if(Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2) < (e.boss ? 50 : 25)) {
                player.hp -= e.boss ? 1 : 0.4;
                if(player.hp <= 0) { alert("ГЕРОЙ ПАЛ! Время: " + document.getElementById('timer').innerText); location.reload(); }
            }
        });

        // Опыт
        crystals.forEach((c, i) => {
            if(Math.sqrt((c.x-player.x)**2 + (c.y-player.y)**2) < 40) {
                player.exp += c.big ? 500 : 40; 
                crystals.splice(i, 1);
                if(player.exp >= player.nextLvl) showLevelUp();
            }
        });

        draw();
        requestAnimationFrame(update);
    }

    function spawnBoss() {
        let a = Math.random()*Math.PI*2;
        enemies.push({
            x: player.x+Math.cos(a)*400, 
            y: player.y+Math.sin(a)*400, 
            hp: 2000, 
            boss: true
        });
    }

    function getNearestEnemy(range) {
        let near = null, minD = range;
        enemies.forEach(e => {
            let d = Math.sqrt((e.x-player.x)**2 + (e.y-player.y)**2);
            if(d < minD) { minD = d; near = e; }
        });
        return near;
    }

    function showLevelUp() {
        isPaused = true;
        const cont = document.getElementById('cards-container');
        cont.innerHTML = '';
        document.getElementById('level-up').classList.remove('hidden');
        const pool = [
            {n: "ДОП. ПУЛЯ", d: "Больше снарядов", f: () => player.skills.bulletCount++},
            {n: "КИРПИЧ", d: "Бросок кирпича", f: () => player.skills.brickLvl++},
            {n: "СИЛОВОЕ ПОЛЕ", d: "Аура вокруг", f: () => player.skills.fieldLvl++},
            {n: "МАГНИТ", d: "Полное исцеление", f: () => player.hp = player.maxHp}
        ];
        pool.sort(()=>0.5-Math.random()).slice(0,3).forEach(o => {
            let d = document.createElement('div'); d.className = 'card';
            d.innerHTML = `<b>${o.n}</b><span>${o.d}</span>`;
            d.onclick = () => {
                o.f();
                player.lvl++; player.exp = 0; player.nextLvl *= 1.4;
                isPaused = false; document.getElementById('level-up').classList.add('hidden');
            };
            cont.appendChild(d);
        });
    }

    function draw() {
        ctx.fillStyle = '#0a0d0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
        const cx = canvas.width/2, cy = canvas.height/2;

        // Фон (Сетка)
        ctx.strokeStyle = '#151a15'; ctx.lineWidth = 1;
        let gridSize = 100;
        let offsetX = -player.x % gridSize, offsetY = -player.y % gridSize;
        for(let x = offsetX; x < canvas.width; x += gridSize) {
            ctx.beginPath(); ctx.moveTo(x, 0); ctx.lineTo(x, canvas.height); ctx.stroke();
        }
        for(let y = offsetY; y < canvas.height; y += gridSize) {
            ctx.beginPath(); ctx.moveTo(0, y); ctx.lineTo(canvas.width, y); ctx.stroke();
        }

        // Кристаллы
        crystals.forEach(c => {
            ctx.fillStyle = c.big ? '#ff00ff' : '#00f2ff';
            ctx.fillRect(c.x-player.x+cx-5, c.y-player.y+cy-5, c.big ? 15 : 8, c.big ? 15 : 8);
        });

        // Враги и БОСС
        enemies.forEach(e => {
            ctx.fillStyle = e.boss ? '#ff0000' : '#ff4444';
            ctx.beginPath(); 
            ctx.arc(e.x-player.x+cx, e.y-player.y+cy, e.boss ? 50 : 15, 0, Math.PI*2); 
            ctx.fill();
            if (e.boss) { // Корона босса
                ctx.fillStyle = '#ffd700';
                ctx.fillRect(e.x-player.x+cx-20, e.y-player.y+cy-70, 40, 10);
            }
        });

        // Пули и Кирпичи
        ctx.fillStyle = '#ffff00'; bullets.forEach(b => { ctx.beginPath(); ctx.arc(b.x-player.x+cx, b.y-player.y+cy, 5, 0, Math.PI*2); ctx.fill(); });
        ctx.fillStyle = '#ff8800'; bricks.forEach(b => ctx.fillRect(b.x-player.x+cx-10, b.y-player.y+cy-10, 20, 12));

        // Силовое поле
        if(player.skills.fieldLvl > 0) {
            ctx.strokeStyle = 'rgba(0, 212, 255, 0.3)'; ctx.lineWidth = 3;
            ctx.beginPath(); ctx.arc(cx, cy, 80 + (player.skills.fieldLvl * 20), 0, Math.PI*2); ctx.stroke();
        }

        // Герой
        ctx.fillStyle = '#ffe0bd'; ctx.beginPath(); ctx.arc(cx, cy-18, 10, 0, Math.PI*2); ctx.fill();
        ctx.fillStyle = '#0066ff'; ctx.fillRect(cx-8, cy-8, 16, 20);

        document.getElementById('lvl').innerText = player.lvl;
        document.getElementById('exp-fill').style.width = (player.exp/player.nextLvl*100)+'%';
        document.getElementById('hp-fill').style.width = (player.hp/player.maxHp*100)+'%';
    }

    requestAnimationFrame(update);
</script>
</body>
</html>
