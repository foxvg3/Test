<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivor.io - Character Shop & Black Hole</title>
    <style>
        body { margin: 0; background: #050505; overflow: hidden; font-family: sans-serif; touch-action: none; color: white; user-select: none; }
        canvas { display: block; }
        .hidden { display: none !important; }
        #ui { position: absolute; top: 0; left: 0; width: 100%; padding: 10px; box-sizing: border-box; z-index: 10; pointer-events: none; }
        #exp-bar { width: 100%; height: 10px; background: #1a1a1a; border: 1px solid #333; border-radius: 5px; overflow: hidden; }
        #exp-fill { width: 0%; height: 100%; background: #00d4ff; }
        #hp-bar { width: 120px; height: 12px; background: #333; margin-top: 5px; border-radius: 6px; overflow: hidden; border: 2px solid #000; }
        #hp-fill { width: 100%; height: 100%; background: #ff4d4d; }
        
        /* –ú–µ–Ω—é */
        .overlay { position: fixed; inset: 0; background: rgba(0,0,0,0.9); z-index: 100; display: none; flex-direction: column; align-items: center; justify-content: center; overflow-y: auto; padding: 20px; }
        .modal { background: #111; padding: 20px; border-radius: 15px; border: 2px solid #00d4ff; width: 90%; max-width: 400px; text-align: center; }
        
        .btn { background: #222; border: 2px solid #00d4ff; color: #00d4ff; padding: 12px; border-radius: 8px; cursor: pointer; font-weight: bold; margin: 5px; display: inline-block; pointer-events: all; }
        .btn:active { background: #00d4ff; color: #000; }
        .btn-gold { border-color: #ffd700; color: #ffd700; }

        /* –ö–∞—Ä—Ç–æ—á–∫–∏ –ø–µ—Ä—Å–æ–Ω–∞–∂–µ–π */
        .char-card { background: #1a1a1a; border: 1px solid #444; padding: 10px; margin: 10px 0; border-radius: 10px; text-align: left; }
        .char-card.selected { border: 2px solid #00ff00; background: #0a200a; }
        .char-info { font-size: 12px; color: #aaa; margin: 5px 0; }

        #joystick-container { position: absolute; bottom: 50px; left: 50%; transform: translateX(-50%); width: 100px; height: 100px; z-index: 5; }
        #joystick-base { width: 100%; height: 100%; background: rgba(255,255,255,0.1); border-radius: 50%; border: 1px solid rgba(255,255,255,0.2); display: flex; align-items: center; justify-content: center; }
        #joystick-stick { width: 40px; height: 40px; background: #00d4ff; border-radius: 50%; opacity: 0.6; }

        .card { background: #222; border: 1px solid #444; padding: 15px; margin: 10px 0; border-radius: 10px; cursor: pointer; pointer-events: all; }
        .card b { color: #00d4ff; }
        .card.red-star b { color: #ff0000; }
    </style>
</head>
<body>

<div id="ui">
    <div id="exp-bar"><div id="exp-fill"></div></div>
    <div id="hp-bar"><div id="hp-fill"></div></div>
    <div id="gold-display" style="color:#ffd700; font-weight:bold; margin-top:5px;">üí∞ 0</div>
    <div id="timer" style="text-align:center; font-size:20px;">00:00</div>
</div>

<div id="dev-toggle" style="position:absolute; top:80px; right:10px; z-index:200; background:#00d4ff; color:#000; padding:5px; border-radius:5px; display:none; cursor:pointer; pointer-events:all;" onclick="toggleDev()">DEV</div>

<div id="dev-panel" class="overlay">
    <div class="modal">
        <h2>ADMIN MENU</h2>
        <div id="dev-btns">
            <div class="btn" onclick="godMode=!godMode">–ë–û–ì: –¢–ï–°–¢</div>
            <div class="btn" onclick="bhActive=!bhActive; this.innerText='–î–´–†–ê: '+(bhActive?'–í–ö–õ':'–í–´–ö–õ')">–î–´–†–ê: –í–´–ö–õ</div>
            <div class="btn" onclick="timeOffset+=60">+1 –ú–ò–ù</div>
            <div class="btn" onclick="devMagnet()">–ú–ê–ì–ù–ò–¢</div>
            <div class="btn" onclick="levelUp()">LVL UP</div>
            <div class="btn" onclick="persistentGold+=10000; updateUI()">+10000$</div>
        </div>
        <div class="btn" style="border-color:red" onclick="toggleDev()">–ó–ê–ö–†–´–¢–¨</div>
    </div>
</div>

<div id="death-screen" class="overlay">
    <div class="modal">
        <h1 style="color:red">–ö–û–ù–ï–¶ –ò–ì–†–´</h1>
        <p id="final-gold">–ó–æ–ª–æ—Ç–æ: 0</p>
        <div class="btn" onclick="showCharacters()">–ü–ï–†–°–û–ù–ê–ñ–ò</div>
        <div class="btn" style="background:#00d4ff; color:#000" onclick="location.reload()">–†–ï–°–¢–ê–†–¢</div>
    </div>
</div>

<div id="char-menu" class="overlay">
    <div class="modal">
        <h2>–í–´–ë–û–† –ì–ï–†–û–Ø</h2>
        <div id="char-list"></div>
        <div class="btn" onclick="hideCharacters()">–ù–ê–ó–ê–î</div>
    </div>
</div>

<div id="level-up" class="overlay"><div class="modal"><h3>–£–õ–£–ß–®–ï–ù–ò–ï</h3><div id="cards"></div></div></div>

<canvas id="game"></canvas>
<div id="joystick-container"><div id="joystick-base"><div id="joystick-stick"></div></div></div>

<script>
const canvas = document.getElementById('game');
const ctx = canvas.getContext('2d');
let gameActive = true, isPaused = false, godMode = false, bhActive = false;
let startTime = Date.now(), timeOffset = 0;

// –î–∞–Ω–Ω—ã–µ –æ –ø–µ—Ä—Å–æ–Ω–∞–∂–∞—Ö
const CHARS = {
    square: { id: 'square', name: '–ö–≤–∞–¥—Ä–∞—Ç', hp: 150, dmg: 1.0, speed: 3.0, magnet: 60, shape: 'rect' },
    triangle: { id: 'triangle', name: '–¢—Ä–µ—É–≥–æ–ª—å–Ω–∏–∫', hp: 80, dmg: 1.8, speed: 4.0, magnet: 50, shape: 'tri' },
    circle: { id: 'circle', name: '–ö—Ä—É–≥', hp: 100, dmg: 1.0, speed: 5.0, magnet: 100, shape: 'circle' }
};

// –°–æ—Ö—Ä–∞–Ω–µ–Ω–∏–µ (–ü—Ä–æ–≥—Ä–µ—Å—Å)
let save = JSON.parse(localStorage.getItem('surv_save_v3')) || {
    gold: 0,
    selectedId: 'square',
    levels: { square: 1, triangle: 1, circle: 1 },
    unlocked: ['square']
};

let persistentGold = save.gold;
let curChar = CHARS[save.selectedId];
let charLvl = save.levels[save.selectedId];

// –ò—Ç–æ–≥–æ–≤—ã–µ —Å—Ç–∞—Ç—ã –∏–≥—Ä–æ–∫–∞ (–±–∞–∑–∞ * —É—Ä–æ–≤–µ–Ω—å)
const player = {
    x: 0, y: 0, 
    maxHp: curChar.hp + (charLvl * 20),
    hp: curChar.hp + (charLvl * 20),
    dmg: curChar.dmg + (charLvl * 0.2),
    speed: curChar.speed + (charLvl * 0.1),
    magnet: curChar.magnet + (charLvl * 5),
    lvl: 1, exp: 0, nextLvl: 100, expMod: 1, cd: 1, armor: 0,
    skills: { gun: 1, lightning: 0, field: 0, brick: 0, mines: 0, p_magnet:0, p_exp:0, p_speed:0, p_cd:0, p_hp:0 }
};

let enemies = [], bullets = [], crystals = [], goldDrops = [], particles = [];
let stats = { fireRate: 800, lastGun: 0, lastLight: 0, lastBrick: 0, lastMine: 0 };

if(location.search.includes('ad')) document.getElementById('dev-toggle').style.display = 'block';

function resize() { canvas.width = window.innerWidth; canvas.height = window.innerHeight; }
window.addEventListener('resize', resize); resize();

// –£–ø—Ä–∞–≤–ª–µ–Ω–∏–µ
let joy = { active: false, x: 0, y: 0 };
document.addEventListener('touchstart', e => { if(!isPaused) { joy.active=true; moveJoy(e); } });
document.addEventListener('touchmove', e => { if(joy.active) { e.preventDefault(); moveJoy(e); } }, {passive:false});
document.addEventListener('touchend', () => { joy.active=false; document.getElementById('joystick-stick').style.transform='translate(0,0)'; });

function moveJoy(e) {
    const t = e.touches[0];
    const b = document.getElementById('joystick-base').getBoundingClientRect();
    const dx = t.clientX - (b.left + 50), dy = t.clientY - (b.top + 50);
    const d = Math.min(Math.sqrt(dx*dx+dy*dy), 40);
    const a = Math.atan2(dy, dx);
    joy.x = Math.cos(a) * (d/40); joy.y = Math.sin(a) * (d/40);
    document.getElementById('joystick-stick').style.transform = `translate(${Math.cos(a)*d}px, ${Math.sin(a)*d}px)`;
}

// –ú–ê–ì–ê–ó–ò–ù –ò –ü–†–û–ö–ê–ß–ö–ê
function showCharacters() {
    document.getElementById('death-screen').style.display = 'none';
    document.getElementById('char-menu').style.display = 'flex';
    const list = document.getElementById('char-list');
    list.innerHTML = '';

    Object.values(CHARS).forEach(c => {
        let isUnlocked = save.unlocked.includes(c.id);
        let lvl = save.levels[c.id];
        let upgradeCost = lvl * 500;
        let unlockCost = 2000;
        
        let card = document.createElement('div');
        card.className = `char-card ${save.selectedId === c.id ? 'selected' : ''}`;
        card.innerHTML = `
            <b>${c.name} (–£—Ä. ${lvl})</b>
            <div class="char-info">HP: ${c.hp + lvl*20} | –£—Ä–æ–Ω: ${(c.dmg + lvl*0.2).toFixed(1)}</div>
            ${isUnlocked ? 
                `<div class="btn btn-gold" onclick="upgradeChar('${c.id}', ${upgradeCost})">–£–ª—É—á—à–∏—Ç—å: ${upgradeCost}üí∞</div>
                 <div class="btn" onclick="selectChar('${c.id}')">–í—ã–±—Ä–∞—Ç—å</div>` : 
                `<div class="btn btn-gold" onclick="unlockChar('${c.id}', ${unlockCost})">–û—Ç–∫—Ä—ã—Ç—å: ${unlockCost}üí∞</div>`
            }
        `;
        list.appendChild(card);
    });
}

function unlockChar(id, cost) {
    if(persistentGold >= cost) {
        persistentGold -= cost; save.gold = persistentGold;
        save.unlocked.push(id); saveGame(); showCharacters();
    }
}

function upgradeChar(id, cost) {
    if(persistentGold >= cost) {
        persistentGold -= cost; save.gold = persistentGold;
        save.levels[id]++; saveGame(); showCharacters();
    }
}

function selectChar(id) { save.selectedId = id; saveGame(); showCharacters(); }
function hideCharacters() { document.getElementById('char-menu').style.display = 'none'; document.getElementById('death-screen').style.display = 'flex'; }
function saveGame() { localStorage.setItem('surv_save_v3', JSON.stringify(save)); updateUI(); }
function toggleDev() { isPaused = !isPaused; document.getElementById('dev-panel').style.display = isPaused?'flex':'none'; }
function devMagnet() { crystals.forEach(c => {c.x=player.x; c.y=player.y}); }
function updateUI() { document.getElementById('gold-display').innerText = `üí∞ ${persistentGold}`; }

// –ò–ì–†–û–í–û–ô –¶–ò–ö–õ
function update() {
    if(!gameActive || isPaused) return requestAnimationFrame(update);
    let now = Date.now(), elapsed = Math.floor((now - startTime)/1000) + timeOffset;
    let diff = 1 + (Math.floor(elapsed/60) * 0.15);

    if(joy.active) { player.x += joy.x * player.speed; player.y += joy.y * player.speed; }

    // –ß–µ—Ä–Ω–∞—è –¥—ã—Ä–∞ (–ü—Ä–∏—Ç—è–≥–∏–≤–∞–µ—Ç –≤ —Ç–æ—á–∫—É —Å–ø—Ä–∞–≤–∞ –æ—Ç –∏–≥—Ä–æ–∫–∞)
    if(bhActive) {
        let targetX = player.x + 100, targetY = player.y;
        enemies.forEach(e => {
            let a = Math.atan2(targetY - e.y, targetX - e.x);
            e.x += Math.cos(a) * 5; e.y += Math.sin(a) * 5;
        });
    }

    // –ê—Ç–∞–∫–∏ (–∫—Ä–∞—Ç–∫–æ)
    if(now - stats.lastGun > stats.fireRate * player.cd) {
        let e = getNear(800);
        if(e) {
            let a = Math.atan2(e.y-player.y, e.x-player.x);
            bullets.push({x:player.x, y:player.y, vx:Math.cos(a)*13, vy:Math.sin(a)*13, pen:player.skills.gun>=6?10:1});
            stats.lastGun = now;
        }
    }

    // –í—Ä–∞–≥–∏
    if(enemies.length < 40) {
        let a = Math.random()*Math.PI*2;
        enemies.push({x:player.x+Math.cos(a)*700, y:player.y+Math.sin(a)*700, hp:(50+player.lvl*10)*diff, size:18, speed:1.5});
    }

    enemies.forEach((e, i) => {
        let a = Math.atan2(player.y-e.y, player.x-e.x);
        e.x += Math.cos(a)*e.speed; e.y += Math.sin(a)*e.speed;
        if(Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2) < 25) {
            if(!godMode) player.hp -= 0.5 * diff;
            if(player.hp <= 0) endGame();
        }
    });

    bullets.forEach((b, i) => {
        b.x += b.vx; b.y += b.vy;
        enemies.forEach(e => {
            if(Math.sqrt((b.x-e.x)**2+(b.y-e.y)**2) < 20) {
                e.hp -= (40 + player.skills.gun*20) * player.dmg; b.pen--;
                if(b.pen <= 0) bullets.splice(i,1);
                if(e.hp <= 0) { 
                    crystals.push({x:e.x, y:e.y}); 
                    if(Math.random()>0.8) goldDrops.push({x:e.x, y:e.y});
                    enemies = enemies.filter(en => en !== e);
                }
            }
        });
    });

    // –°–±–æ—Ä
    crystals.forEach((c, i) => { if(Math.sqrt((c.x-player.x)**2+(c.y-player.y)**2) < player.magnet) { player.exp += 50*player.expMod; crystals.splice(i,1); if(player.exp >= player.nextLvl) levelUp(); }});
    goldDrops.forEach((g, i) => { if(Math.sqrt((g.x-player.x)**2+(g.y-player.y)**2) < player.magnet) { persistentGold += 10; save.gold = persistentGold; goldDrops.splice(i,1); updateUI(); }});

    draw(elapsed);
    requestAnimationFrame(update);
}

function endGame() { gameActive = false; saveGame(); document.getElementById('death-screen').style.display = 'flex'; document.getElementById('final-gold').innerText = `–ó–æ–ª–æ—Ç–æ: ${persistentGold}`; }

function levelUp() {
    isPaused = true; document.getElementById('level-up').style.display = 'flex';
    const box = document.getElementById('cards'); box.innerHTML = '';
    const pool = [{id:'gun', n:'–ü—É—à–∫–∞'}, {id:'p_hp', n:'–ó–¥–æ—Ä–æ–≤—å–µ'}, {id:'p_speed', n:'–°–∫–æ—Ä–æ—Å—Ç—å'}].slice(0, 3);
    pool.forEach(s => {
        let d = document.createElement('div'); d.className = 'card';
        d.innerHTML = `<b>${s.n}</b>`;
        d.onclick = () => { player.skills[s.id]++; player.lvl++; player.exp=0; player.nextLvl*=1.3; isPaused=false; document.getElementById('level-up').style.display='none'; };
        box.appendChild(d);
    });
}

function getNear(r) { let near = null, min = r; enemies.forEach(e => { let d = Math.sqrt((e.x-player.x)**2+(e.y-player.y)**2); if(d < min) { min = d; near = e; }}); return near; }

function draw(elapsed) {
    ctx.fillStyle = '#0a0a0a'; ctx.fillRect(0,0,canvas.width,canvas.height);
    const cx = canvas.width/2, cy = canvas.height/2;
    
    crystals.forEach(c => { ctx.fillStyle = '#0ff'; ctx.fillRect(c.x-player.x+cx-4, c.y-player.y+cy-4, 8, 8); });
    goldDrops.forEach(g => { ctx.fillStyle = '#ffd700'; ctx.beginPath(); ctx.arc(g.x-player.x+cx, g.y-player.y+cy, 5, 0, Math.PI*2); ctx.fill(); });
    enemies.forEach(e => { ctx.fillStyle = '#f44'; ctx.beginPath(); ctx.arc(e.x-player.x+cx, e.y-player.y+cy, e.size, 0, Math.PI*2); ctx.fill(); });
    bullets.forEach(b => { ctx.fillStyle = '#ff0'; ctx.fillRect(b.x-player.x+cx-4, b.y-player.y+cy-4, 8, 8); });

    // –û—Ç—Ä–∏—Å–æ–≤–∫–∞ –∏–≥—Ä–æ–∫–∞ –≤ –∑–∞–≤–∏—Å–∏–º–æ—Å—Ç–∏ –æ—Ç —Ñ–æ—Ä–º—ã
    ctx.fillStyle = godMode ? 'gold' : '#0066ff';
    if(curChar.shape === 'rect') ctx.fillRect(cx-12, cy-12, 24, 24);
    else if(curChar.shape === 'circle') { ctx.beginPath(); ctx.arc(cx, cy, 14, 0, Math.PI*2); ctx.fill(); }
    else { ctx.beginPath(); ctx.moveTo(cx, cy-15); ctx.lineTo(cx-15, cy+15); ctx.lineTo(cx+15, cy+15); ctx.fill(); }

    document.getElementById('exp-fill').style.width = (player.exp/player.nextLvl*100)+'%';
    document.getElementById('hp-fill').style.width = (player.hp/player.maxHp*100)+'%';
    document.getElementById('timer').innerText = `${Math.floor(elapsed/60).toString().padStart(2,'0')}:${(elapsed%60).toString().padStart(2,'0')}`;
}
updateUI();
update();
</script>
</body>
</html>
