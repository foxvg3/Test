<!DOCTYPE html>
<html lang="ru">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>Survivalist</title>
    <style>
        :root { --p: #00d4ff; --r: #ff0055; --g: #ffcc00; --bg: #050805; }
        * { box-sizing: border-box; -webkit-tap-highlight-color: transparent; user-select: none; outline: none; margin: 0; padding: 0; }
        body { background: var(--bg); color: #fff; font-family: sans-serif; overflow: hidden; width: 100vw; height: 100vh; }
        canvas { display: block; position: absolute; top: 0; left: 0; }
        .ui { position: absolute; inset: 0; display: flex; justify-content: center; align-items: center; z-index: 100; background: rgba(0,0,0,0.85); backdrop-filter: blur(10px); }
        .hidden { display: none !important; }
        .panel { background: rgba(0,25,0,0.95); padding: 25px; border: 2px solid var(--p); border-radius: 20px; text-align: center; width: 90%; max-width: 380px; box-shadow: 0 0 20px var(--p); }
        .btn { display: block; width: 100%; padding: 12px; margin-top: 10px; background: var(--p); color: #000; border: none; border-radius: 10px; font-weight: bold; cursor: pointer; text-transform: uppercase; }
        input { width: 100%; padding: 12px; background: #000; border: 1px solid var(--p); color: #fff; text-align: center; margin-bottom: 12px; border-radius: 8px; font-size: 16px; }
        
        #hud { position: absolute; top: 0; left: 0; width: 100%; padding: 15px; pointer-events: none; z-index: 50; }
        .lvl-badge { pointer-events: auto; background: var(--p); color: #000; padding: 5px 15px; border-radius: 20px; font-weight: bold; cursor: pointer; display: inline-block; }
        .bar { width: 100%; height: 8px; background: rgba(255,255,255,0.1); margin-top: 5px; border-radius: 4px; overflow: hidden; }
        .fill { height: 100%; width: 0%; transition: width 0.2s; }
        
        .rank-list { height: 150px; overflow-y: auto; background: rgba(0,0,0,0.3); margin: 10px 0; border-radius: 10px; text-align: left; padding: 10px; font-size: 14px; }
        .rank-item { display: flex; justify-content: space-between; border-bottom: 1px solid #222; padding: 4px 0; }

        #joy-base { position: absolute; width: 100px; height: 100px; background: rgba(255,255,255,0.05); border: 2px solid var(--p); border-radius: 50%; z-index: 60; transform: translate(-50%, -50%); pointer-events: none; }
        #joy-stick { position: absolute; width: 40px; height: 40px; background: var(--p); border-radius: 50%; left: 30px; top: 30px; }
    </style>
</head>
<body>

<div id="hud" class="hidden">
    <div style="display:flex; justify-content:space-between; align-items: center;">
        <div id="h-lvl" class="lvl-badge" onclick="game.showLvlInfo()">LVL 1</div>
        <div id="h-time" style="font-family: monospace; font-size: 20px;">00:00</div>
        <div id="h-gold" style="color:var(--g); font-weight:bold;">üí∞ 0</div>
    </div>
    <div class="bar"><div id="exp-fill" class="fill" style="background:var(--p)"></div></div>
    <div class="bar"><div id="hp-fill" class="fill" style="background:var(--r); width:100%"></div></div>
</div>

<div id="auth" class="ui">
    <div class="panel">
        <h1 style="color:var(--p); margin-bottom: 20px;">SURVIVALIST</h1>
        <input type="text" id="nick" placeholder="–õ–û–ì–ò–ù">
        <input type="password" id="pass" placeholder="–ü–ê–†–û–õ–¨">
        <button class="btn" onclick="account.login()">–í–•–û–î / –†–ï–ì–ò–°–¢–†–ê–¶–ò–Ø</button>
    </div>
</div>

<div id="lobby" class="ui hidden">
    <div class="panel">
        <h2 id="u-info" style="color:var(--p)">–ì–ï–†–û–ô</h2>
        <p id="u-lvl-info" style="font-size: 14px; opacity: 0.8;"></p>
        <h3 id="u-gold" style="color:var(--g); margin: 10px 0;">üí∞ 0</h3>
        <button class="btn" onclick="game.start()">–í –ë–û–ô</button>
        <div style="margin-top: 15px; border-top: 1px solid #333; padding-top: 10px;">
            <h4 style="color:var(--p)">–¢–û–ü-100 –í–´–ñ–ò–í–®–ò–•</h4>
            <div id="rankings" class="rank-list"></div>
        </div>
        <button class="btn" style="background:transparent; color:var(--r); border:1px solid var(--r); font-size: 12px;" onclick="account.logout()">–í–´–ô–¢–ò</button>
    </div>
</div>

<div id="joy-base" class="hidden"><div id="joy-stick"></div></div>
<canvas id="cvs"></canvas>

<script>
const account = {
    curr: null,
    init() {
        const last = localStorage.getItem('last_user');
        if(last) {
            this.curr = JSON.parse(localStorage.getItem('user_' + last));
            this.openLobby();
        }
    },
    login() {
        const n = document.getElementById('nick').value.trim().toLowerCase();
        const p = document.getElementById('pass').value.trim();
        if(!n || !p) return alert("–ó–∞–ø–æ–ª–Ω–∏—Ç–µ –≤—Å–µ –ø–æ–ª—è!");
        
        const saved = localStorage.getItem('user_' + n);
        if(saved) {
            const data = JSON.parse(saved);
            if(data.pass !== p) return alert("–ù–µ–≤–µ—Ä–Ω—ã–π –ø–∞—Ä–æ–ª—å!");
            this.curr = data;
        } else {
            // –ù–æ–≤–∞—è —Ä–µ–≥–∏—Å—Ç—Ä–∞—Ü–∏—è
            this.curr = { nick: n, pass: p, gold: 0, lvl: 1, exp: 0, totalExp: 0 };
            this.save();
        }
        localStorage.setItem('last_user', n);
        this.openLobby();
    },
    logout() { localStorage.removeItem('last_user'); location.reload(); },
    save() { localStorage.setItem('user_' + this.curr.nick, JSON.stringify(this.curr)); },
    openLobby() {
        document.getElementById('auth').classList.add('hidden');
        document.getElementById('lobby').classList.remove('hidden');
        document.getElementById('u-info').innerText = this.curr.nick.toUpperCase();
        document.getElementById('u-gold').innerText = `üí∞ ${this.curr.gold}`;
        const next = this.curr.lvl * 100;
        document.getElementById('u-lvl-info').innerText = `–£—Ä–æ–≤–µ–Ω—å ${this.curr.lvl} (${this.curr.exp} / ${next} XP)`;
        this.renderLeaderboard();
    },
    renderLeaderboard() {
        const list = document.getElementById('rankings');
        const users = [];
        for(let i=0; i<localStorage.length; i++){
            const key = localStorage.key(i);
            if(key.startsWith('user_')) users.push(JSON.parse(localStorage.getItem(key)));
        }
        users.sort((a,b) => b.totalExp - a.totalExp);
        list.innerHTML = users.slice(0, 100).map((u, i) => `
            <div class="rank-item">
                <span>${i+1}. ${u.nick} [Lvl ${u.lvl}]</span>
                <span style="color:var(--g)">${u.gold} üí∞</span>
            </div>
        `).join('') || "–ü–æ–∫–∞ –Ω–∏–∫–æ–≥–æ –Ω–µ—Ç...";
    }
};

const joy = {
    active: false, x: 0, y: 0, origin: {x:0, y:0},
    base: document.getElementById('joy-base'),
    stick: document.getElementById('joy-stick'),
    init() {
        window.addEventListener('touchstart', (e) => {
            if(!game.active) return;
            this.active = true;
            this.origin = { x: e.touches[0].clientX, y: e.touches[0].clientY };
            this.base.style.left = this.origin.x + 'px';
            this.base.style.top = this.origin.y + 'px';
            this.base.classList.remove('hidden');
        });
        window.addEventListener('touchmove', (e) => {
            if(!this.active) return;
            const t = e.touches[0];
            const dx = t.clientX - this.origin.x, dy = t.clientY - this.origin.y;
            const d = Math.hypot(dx, dy), max = 40, a = Math.atan2(dy, dx);
            const mx = Math.min(d, max) * Math.cos(a), my = Math.min(d, max) * Math.sin(a);
            this.stick.style.transform = `translate(${mx}px, ${my}px)`;
            this.x = mx/max; this.y = my/max;
        });
        window.addEventListener('touchend', () => { this.active = false; this.x = 0; this.y = 0; this.base.classList.add('hidden'); });
    }
};

const game = {
    active: false, time: 0, enemies: [], bullets: [], sessionGold: 0, sessionExp: 0,
    start() {
        this.active = true; this.time = 0; this.enemies = []; this.bullets = [];
        this.sessionGold = 0; this.sessionExp = 0;
        document.getElementById('lobby').classList.add('hidden');
        document.getElementById('hud').classList.remove('hidden');
        this.w = cvs.width = window.innerWidth;
        this.h = cvs.height = window.innerHeight;
        // –ë–µ—Ä—ë–º —Ç–µ–∫—É—â–∏–π —É—Ä–æ–≤–µ–Ω—å –∏ –æ–ø—ã—Ç –∏–∑ –∞–∫–∫–∞—É–Ω—Ç–∞ –¥–ª—è —Å—Ç–∞—Ä—Ç–∞ —Å–µ—Å—Å–∏–∏
        this.p = { ...account.curr, x: this.w/2, y: this.h/2, hp: 100, mHp: 100, r: 15, s: 3.5, last: 0 };
        joy.init();
        this.loop();
    },
    spawn() {
        if(this.enemies.length > 30) return;
        const s = Math.floor(Math.random()*4), isBoss = Math.random() < 0.05;
        let x, y;
        if(s==0){x=Math.random()*this.w; y=-20} else if(s==1){x=this.w+20; y=Math.random()*this.h}
        else if(s==2){x=Math.random()*this.w; y=this.h+20} else {x=-20; y=Math.random()*this.h}
        this.enemies.push({ x, y, hp: isBoss?20:2, r: isBoss?30:14, s: isBoss?0.8:1.5, boss: isBoss });
    },
    showLvlInfo() {
        const next = this.p.lvl * 100;
        alert(`Survivalist: –£–†–û–í–ï–ù–¨ ${this.p.lvl}\n–û–ü–´–¢: ${this.p.exp + this.sessionExp} / ${next}\n–ù—É–∂–Ω–æ –µ—â–µ ${next - (this.p.exp + this.sessionExp)} XP –¥–æ —Å–ª–µ–¥—É—é—â–µ–≥–æ —É—Ä–æ–≤–Ω—è.`);
    },
    update() {
        this.time++;
        this.p.x = Math.max(15, Math.min(this.w-15, this.p.x + joy.x * this.p.s));
        this.p.y = Math.max(15, Math.min(this.h-15, this.p.y + joy.y * this.p.s));
        if(this.time % 60 === 0) this.spawn();

        if(this.time - this.p.last > 25) {
            let target = null, dMin = 350;
            this.enemies.forEach(e => {
                const d = Math.hypot(e.x-this.p.x, e.y-this.p.y);
                if(d < dMin) { dMin = d; target = e; }
            });
            if(target) {
                this.bullets.push({x:this.p.x, y:this.p.y, a:Math.atan2(target.y-this.p.y, target.x-this.p.x), s:9});
                this.p.last = this.time;
            }
        }

        this.bullets.forEach((b, i) => {
            b.x += Math.cos(b.a)*b.s; b.y += Math.sin(b.a)*b.s;
            if(b.x<0 || b.x>this.w || b.y<0 || b.y>this.h) this.bullets.splice(i,1);
        });

        this.enemies.forEach((e, i) => {
            const a = Math.atan2(this.p.y-e.y, this.p.x-e.x);
            e.x += Math.cos(a)*e.s; e.y += Math.sin(a)*e.s;
            this.bullets.forEach((b, bi) => {
                if(Math.hypot(e.x-b.x, e.y-b.y) < e.r) {
                    e.hp--; this.bullets.splice(bi,1);
                    if(e.hp<=0) {
                        this.sessionGold += e.boss ? 50 : 1;
                        this.sessionExp += e.boss ? 100 : 1;
                        this.enemies.splice(i,1);
                    }
                }
            });
            if(Math.hypot(e.x-this.p.x, e.y-this.p.y) < e.r + this.p.r) {
                this.p.hp -= 0.5; if(this.p.hp <= 0) this.over();
            }
        });
        
        // –õ–æ–≥–∏–∫–∞ –ø–æ–≤—ã—à–µ–Ω–∏—è —É—Ä–æ–≤–Ω—è –ø—Ä—è–º–æ –≤ –±–æ—é
        let totalCurrentExp = this.p.exp + this.sessionExp;
        const next = this.p.lvl * 100;
        if(totalCurrentExp >= next) {
            this.p.lvl++;
            this.p.exp = 0;
            this.sessionExp = totalCurrentExp - next;
            this.p.hp = this.p.mHp; // –õ–µ—á–∏–º –ø—Ä–∏ –ª–≤–ª-–∞–ø–µ
        }
        
        this.render();
    },
    render() {
        const ctx = cvs.getContext('2d');
        ctx.fillStyle = '#050805'; ctx.fillRect(0,0,this.w,this.h);
        ctx.fillStyle = '#fff'; this.bullets.forEach(b => ctx.fillRect(b.x-2, b.y-2, 5, 5));
        this.enemies.forEach(e => { 
            ctx.fillStyle = e.boss ? '#ffcc00' : '#ff0055';
            ctx.beginPath(); ctx.arc(e.x, e.y, e.r, 0, 7); ctx.fill(); 
        });
        ctx.fillStyle = '#00d4ff'; ctx.beginPath(); ctx.arc(this.p.x, this.p.y, this.p.r, 0, 7); ctx.fill();
        
        document.getElementById('h-lvl').innerText = `LVL ${this.p.lvl}`;
        document.getElementById('h-gold').innerText = `üí∞ ${this.sessionGold}`;
        document.getElementById('hp-fill').style.width = (this.p.hp/this.p.mHp*100)+'%';
        document.getElementById('exp-fill').style.width = ((this.p.exp + this.sessionExp) / (this.p.lvl * 100) * 100)+'%';
        const s = Math.floor(this.time/60);
        document.getElementById('h-time').innerText = `${Math.floor(s/60)}:${(s%60).toString().padStart(2,'0')}`;
    },
    loop() { if(this.active) { this.update(); requestAnimationFrame(() => this.loop()); } },
    over() {
        this.active = false;
        // –°–æ—Ö—Ä–∞–Ω—è–µ–º –≤—Å–µ –Ω–∞–∂–∏—Ç–æ–µ –≤ –ø—Ä–æ—Ñ–∏–ª—å
        account.curr.gold += this.sessionGold;
        account.curr.totalExp += this.sessionExp;
        account.curr.exp += this.sessionExp;
        account.curr.lvl = this.p.lvl;
        
        // –ü–µ—Ä–µ—Å—á–µ—Ç –æ–ø—ã—Ç–∞ –¥–ª—è —Å–æ—Ö—Ä–∞–Ω–µ–Ω–∏—è –∫–æ—Ä—Ä–µ–∫—Ç–Ω–æ–≥–æ –æ—Å—Ç–∞—Ç–∫–∞
        while(account.curr.exp >= account.curr.lvl * 100) {
            account.curr.exp -= account.curr.lvl * 100;
            account.curr.lvl++;
        }
        
        account.save();
        alert(`SURVIVALIST: –ò–ì–†–ê –û–ö–û–ù–ß–ï–ù–ê!\n–ó–æ–ª–æ—Ç–æ: +${this.sessionGold}\n–û–ø—ã—Ç: +${this.sessionExp}`);
        account.openLobby();
    }
};
account.init();
</script>
</body>
</html>
